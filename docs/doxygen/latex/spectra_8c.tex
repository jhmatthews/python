\hypertarget{spectra_8c}{}\section{/\+Users/mhewitt/python/source/spectra.c File Reference}
\label{spectra_8c}\index{/\+Users/mhewitt/python/source/spectra.\+c@{/\+Users/mhewitt/python/source/spectra.\+c}}


The subroutines in this file handle allocating, incrementing, and writing out the spectrum arrays for Python.  


{\ttfamily \#include $<$stdio.\+h$>$}\newline
{\ttfamily \#include $<$stdlib.\+h$>$}\newline
{\ttfamily \#include $<$string.\+h$>$}\newline
{\ttfamily \#include $<$math.\+h$>$}\newline
{\ttfamily \#include \char`\"{}atomic.\+h\char`\"{}}\newline
{\ttfamily \#include \char`\"{}python.\+h\char`\"{}}\newline
Include dependency graph for spectra.\+c\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{spectra_8c__incl}
\end{center}
\end{figure}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
int \hyperlink{spectra_8c_a26cbf4a3506fa195892c934fa79275df}{spectrum\+\_\+init} (double f1, double f2, int nangle, angle, phase, scat\+\_\+select, top\+\_\+bot\+\_\+select, int select\+\_\+extract, rho\+\_\+select, z\+\_\+select, az\+\_\+select, r\+\_\+select)
\begin{DoxyCompactList}\small\item\em allocates space for and initializes the spectrum arrays, storing the criteria that are later used to create each spectrum. \end{DoxyCompactList}\item 
int \hyperlink{spectra_8c_a3e05df283bba500d0e7a307679b291d6}{spectrum\+\_\+create} (\hyperlink{python_8h_ad2424d53ebcf811656882a87e11b440c}{Phot\+Ptr} p, double f1, double f2, int nangle, int select\+\_\+extract)
\begin{DoxyCompactList}\small\item\em Increments the spectrum arrays after each flight of photons is processed (during ionization cycles and for detailed spectra in the Live or Die option). \end{DoxyCompactList}\item 
int \hyperlink{spectra_8c_a9e26bf475d028c01075ff128c8c80d57}{spectrum\+\_\+summary} (filename, int nspecmin, int nspecmax, int select\+\_\+spectype, double \hyperlink{vvector_8c_a8f009c8e40535ce9122cb90112b6e88c}{renorm}, int loglin, int iwind)
\begin{DoxyCompactList}\small\item\em (writes out the spectrum to a file \end{DoxyCompactList}\item 
int \hyperlink{spectra_8c_a6d37ca5473b25832956cb6988e1b4ed5}{spectrum\+\_\+restart\+\_\+renormalise} (int nangle)
\begin{DoxyCompactList}\small\item\em renormalizes the detailed spectra in case of a restart \end{DoxyCompactList}\end{DoxyCompactItemize}
\subsection*{Variables}
\begin{DoxyCompactItemize}
\item 
int \hyperlink{spectra_8c_ad96cdba540104e93e764a980db99ea4e}{i\+\_\+spec\+\_\+start} = 0
\end{DoxyCompactItemize}


\subsection{Detailed Description}
The subroutines in this file handle allocating, incrementing, and writing out the spectrum arrays for Python. 

\begin{DoxyAuthor}{Author}
ksl 
\end{DoxyAuthor}
\begin{DoxyDate}{Date}
May, 2018 
\end{DoxyDate}


\subsection{Function Documentation}
\mbox{\Hypertarget{spectra_8c_a3e05df283bba500d0e7a307679b291d6}\label{spectra_8c_a3e05df283bba500d0e7a307679b291d6}} 
\index{spectra.\+c@{spectra.\+c}!spectrum\+\_\+create@{spectrum\+\_\+create}}
\index{spectrum\+\_\+create@{spectrum\+\_\+create}!spectra.\+c@{spectra.\+c}}
\subsubsection{\texorpdfstring{spectrum\+\_\+create()}{spectrum\_create()}}
{\footnotesize\ttfamily int spectrum\+\_\+create (\begin{DoxyParamCaption}\item[{\hyperlink{python_8h_ad2424d53ebcf811656882a87e11b440c}{Phot\+Ptr}}]{p,  }\item[{double}]{f1,  }\item[{double}]{f2,  }\item[{int}]{nangle,  }\item[{int}]{select\+\_\+extract }\end{DoxyParamCaption})}



Increments the spectrum arrays after each flight of photons is processed (during ionization cycles and for detailed spectra in the Live or Die option). 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em Phot\+Ptr} & p A flight of photons \\
\hline
\mbox{\tt in}  & {\em double} & f1 The minimum frequncy in the spectrum \\
\hline
\mbox{\tt in}  & {\em double} & f2 The maximum frequency in the spectrum \\
\hline
\mbox{\tt in}  & {\em int} & nangle The number of different angles and phases for which to create detailed spectra \\
\hline
\mbox{\tt in}  & {\em int} & select\+\_\+extract The integer stating whether the Live or Die option has \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Always returns 0
\end{DoxyReturn}
This routine increments the total spectrum arrays based on what has happened to each photon during ionization cycles. In the Live or Die option, the spectra at specific angles are also created here when detailed spectra are created.

The routine is called after each batch of photons has been transported through the wind and prints some intermediate results to assure the user that the program is still running.

\paragraph*{Notes}

Summing up of the spectra in the \char`\"{}extract\char`\"{} option is done in \hyperlink{extract_8c}{extract.\+c}

\begin{DoxyRefDesc}{Bug}
\item[\hyperlink{bug__bug000059}{Bug}]To create spectra in the live or die option which are selected on the number of scatters individual photons undergo, there are some additional changes required to this routine. These changes should parallel those now in extract under the normal option. 97aug29\end{DoxyRefDesc}


Definition at line 427 of file spectra.\+c.

Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{spectra_8c_a3e05df283bba500d0e7a307679b291d6_cgraph}
\end{center}
\end{figure}
Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=270pt]{spectra_8c_a3e05df283bba500d0e7a307679b291d6_icgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{spectra_8c_a26cbf4a3506fa195892c934fa79275df}\label{spectra_8c_a26cbf4a3506fa195892c934fa79275df}} 
\index{spectra.\+c@{spectra.\+c}!spectrum\+\_\+init@{spectrum\+\_\+init}}
\index{spectrum\+\_\+init@{spectrum\+\_\+init}!spectra.\+c@{spectra.\+c}}
\subsubsection{\texorpdfstring{spectrum\+\_\+init()}{spectrum\_init()}}
{\footnotesize\ttfamily int spectrum\+\_\+init (\begin{DoxyParamCaption}\item[{double}]{f1,  }\item[{double}]{f2,  }\item[{int}]{nangle,  }\item[{angle}]{,  }\item[{phase}]{,  }\item[{scat\+\_\+select}]{,  }\item[{top\+\_\+bot\+\_\+select}]{,  }\item[{int}]{select\+\_\+extract,  }\item[{rho\+\_\+select}]{,  }\item[{z\+\_\+select}]{,  }\item[{az\+\_\+select}]{,  }\item[{r\+\_\+select}]{ }\end{DoxyParamCaption})}



allocates space for and initializes the spectrum arrays, storing the criteria that are later used to create each spectrum. 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em double} & f1 The minimum frequency for the spectra to be created \\
\hline
\mbox{\tt in}  & {\em double} & f2 The maximum frequency in the spectra \\
\hline
\mbox{\tt in}  & {\em int} & nangle The number of different inclination angles (or more properly the number of spectra) to be created \\
\hline
\mbox{\tt in}  & {\em double} & angle\mbox{[}\mbox{]} The inclination angles associated with each spectrum \\
\hline
\mbox{\tt in}  & {\em double} & phase\mbox{[}\mbox{]} The orbital phase associated with each spectrum \\
\hline
\mbox{\tt in}  & {\em int} & scat\+\_\+select\mbox{[}\mbox{]} A parameter for each spectrum which allows one to construct spectra with specifid numbers of scatters \\
\hline
\mbox{\tt in}  & {\em int} & top\+\_\+bot\+\_\+select\mbox{[}\mbox{]} A code which allows one to select photons only from below or above the disk \\
\hline
\mbox{\tt in}  & {\em int} & select\+\_\+extract 0 for Live or Die option, non-\/zero fo a normal extraction \\
\hline
\mbox{\tt in}  & {\em double} & rho\+\_\+select\mbox{[}\mbox{]} Rho coordinates for extracting only photons in a particualr region \\
\hline
\mbox{\tt in}  & {\em double} & z\+\_\+select\mbox{[}\mbox{]} Z cooordiante for selecting only photons that scattreed or were created in a praticular region \\
\hline
\mbox{\tt in}  & {\em double} & az\+\_\+select\mbox{[}\mbox{]} Aximuthal angle for selecting only photons in a particular region \\
\hline
\mbox{\tt in}  & {\em double} & r\+\_\+select\mbox{[}\mbox{]} Radius of the region from which to select photons \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Always returns 0
\end{DoxyReturn}
The first time spectrum\+\_\+init is called (i.\+e. if ispec\+\_\+start=0), it allocates memory for the various spectrum arrays. (This is done one time, so one needs to allocate space for all the arrays even though they are not all used in the ionization step). The total number of spectra created is nangle+\+M\+S\+P\+EC.

On subsequent calls to spectrum\+\_\+init, it rezeros all the spectrum information and calculates the other information associated with each spectrum, such as the angle cosines and the names of each spectrum.

\paragraph*{Notes}

angle\mbox{[}\mbox{]},phase\mbox{[}\mbox{]} and scat\+\_\+select\mbox{[}\mbox{]} only apply to the spectra extracted at specific angles. angle\mbox{[}0\mbox{]}, phase\mbox{[}0\mbox{]}, and scat\+\_\+select\mbox{[}0\mbox{]} all affect spec\mbox{[}3\mbox{]}

scat\+\_\+select allows one to select spectra with a specific number of scattere or range og scatters. If nscat $>$ 999 select all. This is the normal case. The rest are used largely for diagnostic purposes. If 0 $<$nscat $<$ M\+A\+X\+Scat selected only photons which have scattered nscat times. If nscat is negattive, then all photons with more than $\vert$nscat$\vert$ re included.

If top\+\_\+bot\+\_\+select is 0, then all photons are counted in the spectrum; if $>$ 0, then only photons above the disk plane are selected, if $<$0 only those from below the disk plane are selected.

rho\+\_\+select,z\+\_\+select,az\+\_\+select,r\+\_\+select define a region of space and can be used to create spectra only from photons that scattered or were created in these particular regions. It is normally only used for diagnostic reasons

Warning -\/ Do not put anything in this routine that does anything but initialize or reinitialize the spectrum structure s. This is important because this routine is not accessed if one is continuing an old calculation of the detailed spectrum. It is still use on a restart where the detailed spectral cycles have not begun because in that case the spectra are not saved. 

Definition at line 154 of file spectra.\+c.

Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{spectra_8c_a26cbf4a3506fa195892c934fa79275df_cgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{spectra_8c_a6d37ca5473b25832956cb6988e1b4ed5}\label{spectra_8c_a6d37ca5473b25832956cb6988e1b4ed5}} 
\index{spectra.\+c@{spectra.\+c}!spectrum\+\_\+restart\+\_\+renormalise@{spectrum\+\_\+restart\+\_\+renormalise}}
\index{spectrum\+\_\+restart\+\_\+renormalise@{spectrum\+\_\+restart\+\_\+renormalise}!spectra.\+c@{spectra.\+c}}
\subsubsection{\texorpdfstring{spectrum\+\_\+restart\+\_\+renormalise()}{spectrum\_restart\_renormalise()}}
{\footnotesize\ttfamily int spectrum\+\_\+restart\+\_\+renormalise (\begin{DoxyParamCaption}\item[{int}]{nangle }\end{DoxyParamCaption})}



renormalizes the detailed spectra in case of a restart 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em int} & nangle The number of discrete angles \\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Always returns 0
\end{DoxyReturn}
This routine deals with a very special case when one is restarting a previous run, and adding spectral cycles to obtain a detailed spectrum with higher statistics.

In the previous run, the spectral will have been normalized so that one gets the correct flux for the simulation. We are now computing additional spectral cycles, so we have to reduce the fluxes for the spectral cycles that are read in, so we can continue. renorm\+\_\+factor = (cycles in old pf file) / (cycles in new pf file)

\paragraph*{Notes}

see Issue \#134 

Definition at line 1019 of file spectra.\+c.

Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=296pt]{spectra_8c_a6d37ca5473b25832956cb6988e1b4ed5_icgraph}
\end{center}
\end{figure}
\mbox{\Hypertarget{spectra_8c_a9e26bf475d028c01075ff128c8c80d57}\label{spectra_8c_a9e26bf475d028c01075ff128c8c80d57}} 
\index{spectra.\+c@{spectra.\+c}!spectrum\+\_\+summary@{spectrum\+\_\+summary}}
\index{spectrum\+\_\+summary@{spectrum\+\_\+summary}!spectra.\+c@{spectra.\+c}}
\subsubsection{\texorpdfstring{spectrum\+\_\+summary()}{spectrum\_summary()}}
{\footnotesize\ttfamily int spectrum\+\_\+summary (\begin{DoxyParamCaption}\item[{filename}]{,  }\item[{int}]{nspecmin,  }\item[{int}]{nspecmax,  }\item[{int}]{select\+\_\+spectype,  }\item[{double}]{renorm,  }\item[{int}]{loglin,  }\item[{int}]{iwind }\end{DoxyParamCaption})}



(writes out the spectrum to a file 


\begin{DoxyParams}[1]{Parameters}
\mbox{\tt in}  & {\em char} & filename\mbox{[}\mbox{]} The name of the file to write \\
\hline
\mbox{\tt in}  & {\em int} & nspecmin The number of the first spectrum to write \\
\hline
\mbox{\tt in}  & {\em int} & nspecmax The number of the last spectrum to write . \\
\hline
\mbox{\tt in}  & {\em int} & select\+\_\+spectype The type of spectral file you want to create \\
\hline
\mbox{\tt in,out}  & {\em double} & renorm This is renormalization which incrementally decreases to one as the detailed spectral calculation goes forward. It was added to allow one to print out the spectrum at the end of each cycle, rather than the end of the entire calculation. \\
\hline
\mbox{\tt in}  & {\em int} & loglin 0 to print the spectrum out in linear units, 1 in log units \\
\hline
\mbox{\tt in}  & {\em int} & iwind If false (0), print out the normal spectrum; if true (1), print out only photons that were scattered or created in the wind.\\
\hline
\end{DoxyParams}
\begin{DoxyReturn}{Returns}
Always returns 0, unless there is a major problem in which case the program exits
\end{DoxyReturn}
This simple routine simply writes the spectra to a file in an easily interpretable ascii format. Normally one would write all of the spectra in one go, but one can use spectrum summary to write various spectra to various files by using the variables nspecmin and nspecmax..

Normally s\mbox{[}0\mbox{]},s\mbox{[}1\mbox{]},and s\mbox{[}2\mbox{]} will be the escaping, scattered, and absorbed spectrum. The rest will be those which have been \char`\"{}extracted\char`\"{}.

It can be called multiple times. In Python, it is currently called twice, once at the end of the ionization stage and once when computation of the detailed spectra are completed.

\paragraph*{Notes}

Definition at line 827 of file spectra.\+c.

Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{spectra_8c_a9e26bf475d028c01075ff128c8c80d57_cgraph}
\end{center}
\end{figure}


\subsection{Variable Documentation}
\mbox{\Hypertarget{spectra_8c_ad96cdba540104e93e764a980db99ea4e}\label{spectra_8c_ad96cdba540104e93e764a980db99ea4e}} 
\index{spectra.\+c@{spectra.\+c}!i\+\_\+spec\+\_\+start@{i\+\_\+spec\+\_\+start}}
\index{i\+\_\+spec\+\_\+start@{i\+\_\+spec\+\_\+start}!spectra.\+c@{spectra.\+c}}
\subsubsection{\texorpdfstring{i\+\_\+spec\+\_\+start}{i\_spec\_start}}
{\footnotesize\ttfamily int i\+\_\+spec\+\_\+start = 0}



Definition at line 97 of file spectra.\+c.

