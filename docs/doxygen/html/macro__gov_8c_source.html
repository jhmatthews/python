<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Python MCRT: /Users/mhewitt/python/source/macro_gov.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Python MCRT
   </div>
   <div id="projectbrief">A Monte Carlo radiative transfer and ionization code</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('macro__gov_8c_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">macro_gov.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="macro__gov_8c.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;<span class="comment">/***********************************************************/</span></div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="preprocessor">#include &lt;stdlib.h&gt;</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &lt;math.h&gt;</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="atomic_8h.html">atomic.h</a>&quot;</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="python_8h.html">python.h</a>&quot;</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#include &lt;gsl/gsl_block.h&gt;</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;<span class="preprocessor">#include &lt;gsl/gsl_vector.h&gt;</span></div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="preprocessor">#include &lt;gsl/gsl_matrix.h&gt;</span></div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;<span class="comment">//#include &lt;gsl/gsl_blas.h&gt;</span></div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="my__linalg_8h.html">my_linalg.h</a>&quot;</span></div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;<span class="comment">/**********************************************************/</span></div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;<span class="keywordtype">int</span></div><div class="line"><a name="l00057"></a><span class="lineno"><a class="line" href="templates_8h.html#a7de597169a947d506f6d2210de2080ac">   57</a></span>&#160;<a class="code" href="macro__gov_8c.html#a7de597169a947d506f6d2210de2080ac">macro_gov</a> (p, <a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a>, matom_or_kpkt, which_out)</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;     <a class="code" href="structphoton.html">PhotPtr</a> p;</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;     <span class="keywordtype">int</span> *<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a>;</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;     <span class="keywordtype">int</span> matom_or_kpkt;</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;     <span class="keywordtype">int</span> *which_out;</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;{</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;  <span class="keywordtype">int</span> escape;                   <span class="comment">//this tells us when the r-packet is escaping</span></div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;  escape = 0;                   <span class="comment">//start with it not being ready to escape as an r-packet</span></div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;  <span class="keywordflow">while</span> (escape == 0)</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;  {</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    <span class="keywordflow">if</span> (matom_or_kpkt == 1)     <span class="comment">//excite a macro atom - depending on simple/macro choice call different routines</span></div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;    {</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;      <span class="keywordflow">if</span> (*<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a> &gt; (-1) &amp;&amp; *<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a> &lt; <a class="code" href="atomic_8h.html#a59990369239024c94cbe22080c9d29c3">NLINES</a> &amp;&amp; <a class="code" href="python_8h.html#a3a571e0bd4220490c5c5bd86f51c83ba">geo</a>.<a class="code" href="structgeometry.html#ac453ab1a6ed3b90674cd6552c0185bff">macro_simple</a> == 0 &amp;&amp; <a class="code" href="atomic_8h.html#a8c1d70d2c39e64a6cc16b6132d86c044">lin_ptr</a>[*<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a>]-&gt;<a class="code" href="structlines.html#a8bf1b13f22b24fc4fb517bb28dd775b8">macro_info</a> == 1)</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;        <span class="comment">/* This is a bb line of a macro atoms and we want the full macro atom treatment. */</span></div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;      {</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="python_8h.html#a3a571e0bd4220490c5c5bd86f51c83ba">geo</a>.<a class="code" href="structgeometry.html#a4b97dc16b54fd49d53a06ff8896596a6">matom_radiation</a> == 1)</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;        {</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;          <span class="comment">/* During the spectrum cycles we want to throw these photons away. */</span></div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;          p-&gt;<a class="code" href="structphoton.html#a5fa87a07a9ceef33dd79aa5cdd7856cb">w</a> = 0.0;</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;          escape = 1;           <span class="comment">//This doesn&#39;t matter but it breaks us out of this loop</span></div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;        }</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;        {</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;          <a class="code" href="foo_8h.html#a9301eba8fb39302ef3da90cdb52aef4d">matom</a> (p, <a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a>, &amp;escape);</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;          <span class="keywordflow">if</span> (escape == 1)</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;          {</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;            <span class="comment">/* It is going to escape as a r-packet that was created by de-activation of a macro atom.</span></div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;<span class="comment">               Therefore, if the frequency is suitable it should be recorded as a macro atom emission event for use in the</span></div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;<span class="comment">               computation of the k-packet emissivity needed for the final spectrum calculation. */</span></div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;            *which_out = 1;</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;            <span class="comment">/* 0803 - ksl - 60 - Added code to modify the photon origin to indicate the packet has been processed</span></div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;<span class="comment">               by a macro atom */</span></div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;            <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structphoton.html#a201206174a8fa79b29526a68e20704cf">origin</a> &lt; 10)</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;              p-&gt;<a class="code" href="structphoton.html#a201206174a8fa79b29526a68e20704cf">origin</a> += 10;</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;            <span class="keywordflow">return</span> (1);</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;          }</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;        }</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;      }</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a> &gt; (-1) &amp;&amp; *<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a> &lt; <a class="code" href="atomic_8h.html#a59990369239024c94cbe22080c9d29c3">NLINES</a> &amp;&amp; (<a class="code" href="python_8h.html#a3a571e0bd4220490c5c5bd86f51c83ba">geo</a>.<a class="code" href="structgeometry.html#ac453ab1a6ed3b90674cd6552c0185bff">macro_simple</a> == 1 || <a class="code" href="atomic_8h.html#a8c1d70d2c39e64a6cc16b6132d86c044">lin_ptr</a>[*<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a>]-&gt;<a class="code" href="structlines.html#a8bf1b13f22b24fc4fb517bb28dd775b8">macro_info</a> == 0))</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;        <span class="comment">/* This is a bb line for which we don&#39;t want a full macro atom treatment. */</span></div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;      {</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;        <a class="code" href="foo_8h.html#aa39c27768ea571d93b29aa2bf90e7913">fake_matom_bb</a> (p, <a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a>, &amp;escape);</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;      }</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a> &gt; <a class="code" href="atomic_8h.html#a59990369239024c94cbe22080c9d29c3">NLINES</a> &amp;&amp; <a class="code" href="atomic_8h.html#aed5961eebbc0ca048e57fe2ad4cdfab8">phot_top</a>[*<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a> - <a class="code" href="atomic_8h.html#a59990369239024c94cbe22080c9d29c3">NLINES</a> - 1].<a class="code" href="structlines.html#a8bf1b13f22b24fc4fb517bb28dd775b8">macro_info</a> == 1 &amp;&amp; <a class="code" href="python_8h.html#a3a571e0bd4220490c5c5bd86f51c83ba">geo</a>.<a class="code" href="structgeometry.html#ac453ab1a6ed3b90674cd6552c0185bff">macro_simple</a> == 0)</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;        <span class="comment">/* This is a bf continuum of a macro atom and we want the full treatment. */</span></div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;      {</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="python_8h.html#a3a571e0bd4220490c5c5bd86f51c83ba">geo</a>.<a class="code" href="structgeometry.html#a4b97dc16b54fd49d53a06ff8896596a6">matom_radiation</a> == 1)</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;        {</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;          <span class="comment">/* During the spectrum cycles we want to throw these photons away. */</span></div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;          p-&gt;<a class="code" href="structphoton.html#a5fa87a07a9ceef33dd79aa5cdd7856cb">w</a> = 0.0;</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;          escape = 1;           <span class="comment">//This doesn&#39;t matter but it breaks us out of this loop</span></div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;        }</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;        {</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;          <a class="code" href="foo_8h.html#a9301eba8fb39302ef3da90cdb52aef4d">matom</a> (p, <a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a>, &amp;escape);</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;          <span class="keywordflow">if</span> (escape == 1)</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;          {</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;            <span class="comment">/* It is going to escape as a r-packet that was created by de-activation of a macro atom.</span></div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;<span class="comment">               Therefore, if the frequency is suitable it should be recorded as a macro atom emission event for use in the</span></div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;<span class="comment">               computation of the k-packet emissivity needed for the final spectrum calculation. */</span></div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;            *which_out = 1;</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;            <span class="comment">//SWM - If reverb is on, and this is the last ionisation cycle, then track the photon path</span></div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;            <span class="keywordflow">if</span> (<a class="code" href="python_8h.html#a3a571e0bd4220490c5c5bd86f51c83ba">geo</a>.<a class="code" href="structgeometry.html#a853e273c5a2a6630c2c1c609db0f47a1">reverb</a> == REV_MATOM &amp;&amp; <a class="code" href="python_8h.html#a3a571e0bd4220490c5c5bd86f51c83ba">geo</a>.<a class="code" href="structgeometry.html#a1cdd3c658ff714b9504c7ada69ae1f0d">ioniz_or_extract</a> &amp;&amp; <a class="code" href="python_8h.html#a3a571e0bd4220490c5c5bd86f51c83ba">geo</a>.<a class="code" href="structgeometry.html#a14e36d7ed328d1a6439a8215fa0944a6">fraction_converged</a> &gt; <a class="code" href="python_8h.html#a3a571e0bd4220490c5c5bd86f51c83ba">geo</a>.<a class="code" href="structgeometry.html#a38b14c19caa8036cfef9998e80835a57">reverb_fraction_converged</a>)</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;            {</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;              <a class="code" href="foo_8h.html#ab2919946d2f7195f5e532eefeae7dd2d">line_paths_add_phot</a> (&amp;(<a class="code" href="python_8h.html#a940291848296c285c722ed248863afc1">wmain</a>[p-&gt;<a class="code" href="structphoton.html#a2aa9d1ea7afffe4f370b28b0a21d6c79">grid</a>]), p, <a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a>);</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;            }</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;            <span class="keywordflow">return</span> (1);</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;            <span class="comment">/* 0803 - ksl - 60 - Added code to modify the photon origin to indicate the packet has been processed</span></div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;<span class="comment">               by a macro atom */</span></div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;            <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structphoton.html#a201206174a8fa79b29526a68e20704cf">origin</a> &lt; 10)</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;              p-&gt;<a class="code" href="structphoton.html#a201206174a8fa79b29526a68e20704cf">origin</a> += 10;</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;            <span class="keywordflow">return</span> (1);</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;          }</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;        }</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;      }</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;      <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a> &gt; <a class="code" href="atomic_8h.html#a59990369239024c94cbe22080c9d29c3">NLINES</a> &amp;&amp; (<a class="code" href="atomic_8h.html#aed5961eebbc0ca048e57fe2ad4cdfab8">phot_top</a>[*<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a> - <a class="code" href="atomic_8h.html#a59990369239024c94cbe22080c9d29c3">NLINES</a> - 1].<a class="code" href="structlines.html#a8bf1b13f22b24fc4fb517bb28dd775b8">macro_info</a> == 0 || <a class="code" href="python_8h.html#a3a571e0bd4220490c5c5bd86f51c83ba">geo</a>.<a class="code" href="structgeometry.html#ac453ab1a6ed3b90674cd6552c0185bff">macro_simple</a> == 1))</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;        <span class="comment">/* This is a bf continuum but we don&#39;t want the full macro atom treatment. */</span></div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;      {</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;        <a class="code" href="foo_8h.html#a4c03c66dea8a22dd2a87077c816d26c2">fake_matom_bf</a> (p, <a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a>, &amp;escape);</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;      }</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;      matom_or_kpkt = 2;        <span class="comment">//if it did not escape then it must have had a</span></div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;      <span class="comment">//de-activation by collision processes -&gt; need a k-packet</span></div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;    }</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (matom_or_kpkt == 2)        <span class="comment">//deal with a k-packet</span></div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;    {</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;      <span class="keywordflow">if</span> (<a class="code" href="python_8h.html#a3a571e0bd4220490c5c5bd86f51c83ba">geo</a>.<a class="code" href="structgeometry.html#a4b97dc16b54fd49d53a06ff8896596a6">matom_radiation</a> == 1)</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;      {</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;        <span class="comment">/* During the spectrum cycles we want to throw these photons away. */</span></div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;        p-&gt;<a class="code" href="structphoton.html#a5fa87a07a9ceef33dd79aa5cdd7856cb">w</a> = 0.0;</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;        escape = 1;             <span class="comment">//This doesn&#39;t matter but it breaks us out of the loop.</span></div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;      }</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;      {</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;        <a class="code" href="foo_8h.html#a16ae068adf1746f09c432de7e245dfb1">kpkt</a> (p, <a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a>, &amp;escape);</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;      }</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;      matom_or_kpkt = 1;        <span class="comment">//if it did not escape then the k-packet must have been</span></div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;      <span class="comment">//destroyed by collisionally exciting a macro atom -</span></div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;      <span class="comment">//excite a macro atom next</span></div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    }</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    {</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;      <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;macro_gov: Unknown choice for next action. Abort.\n&quot;</span>);</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;      exit (0);</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    }</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;  }</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;  <span class="comment">//When it gets here an escpae has taken place. That&#39;s it done.</span></div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;  *which_out = 2;</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;  <span class="comment">/* 0803 - ksl - 60 - Added code to modify the photon origin to indicate the packet has been processed</span></div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;<span class="comment">     by a macro atom */</span></div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;  <span class="keywordflow">if</span> (p-&gt;<a class="code" href="structphoton.html#a201206174a8fa79b29526a68e20704cf">origin</a> &lt; 10)</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;    p-&gt;<a class="code" href="structphoton.html#a201206174a8fa79b29526a68e20704cf">origin</a> += 10;</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;  <span class="keywordflow">return</span> (0);</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;  <span class="comment">//All done.</span></div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;}</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;<span class="comment">/**********************************************************/</span></div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;<span class="keywordtype">int</span></div><div class="line"><a name="l00221"></a><span class="lineno"><a class="line" href="templates_8h.html#a590f1ed026cd692ac6f878ed6f359d5a">  221</a></span>&#160;<a class="code" href="macro__gov_8c.html#a590f1ed026cd692ac6f878ed6f359d5a">macro_pops</a> (<a class="code" href="compton_8c.html#ad65f0d74fe764d3ecae5ec1a89d63f08">xplasma</a>, xne)</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;     <a class="code" href="structplasma.html">PlasmaPtr</a> <a class="code" href="compton_8c.html#ad65f0d74fe764d3ecae5ec1a89d63f08">xplasma</a>;</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;     <span class="keywordtype">double</span> xne;</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;{</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;  <span class="keywordtype">int</span> index_element, index_ion, index_lvl;</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;  <span class="keywordtype">int</span> n_macro_lvl;</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;  <span class="keywordtype">double</span> rate;</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;  <span class="keywordtype">double</span> rate_matrix[<a class="code" href="atomic_8h.html#af618fc4a6769a63822cf1f4be873ce23">NLEVELS_MACRO</a>][<a class="code" href="atomic_8h.html#af618fc4a6769a63822cf1f4be873ce23">NLEVELS_MACRO</a>];</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;  <span class="keywordtype">int</span> radiative_flag[<a class="code" href="atomic_8h.html#af618fc4a6769a63822cf1f4be873ce23">NLEVELS_MACRO</a>][<a class="code" href="atomic_8h.html#af618fc4a6769a63822cf1f4be873ce23">NLEVELS_MACRO</a>];     <span class="comment">// 140423 JM flag if two levels are radiatively linked</span></div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;  <span class="keywordtype">int</span> conf_to_matrix[<a class="code" href="atomic_8h.html#af618fc4a6769a63822cf1f4be873ce23">NLEVELS_MACRO</a>];</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;  <span class="keyword">struct </span><a class="code" href="structlines.html">lines</a> *line_ptr;</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;  <span class="keyword">struct </span><a class="code" href="structtopbase__phot.html">topbase_phot</a> *cont_ptr;</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;  <span class="keywordtype">int</span> nn, mm;</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;  <span class="keywordtype">int</span> index_bbu, index_bbd, index_bfu, index_bfd;</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;  <span class="keywordtype">int</span> lower, upper;</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;  <span class="keywordtype">double</span> this_ion_density, level_population;</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;  <span class="keywordtype">double</span> inversion_test;</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;  <span class="keywordtype">double</span> <a class="code" href="direct__ion_8c.html#ad33c3a097208fb519a5e779c62e3d1f3">q_ioniz</a> (), <a class="code" href="direct__ion_8c.html#a432a9569392003e4470067b1c44dca5b">q_recomb</a> ();</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;  <span class="keywordtype">double</span> *a_data, *b_data;</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;  <span class="keywordtype">double</span> *populations;</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;  <span class="keywordtype">int</span> index_fast_col, ierr, insane, sane_populations;</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;  <a class="code" href="structmacro.html">MacroPtr</a> mplasma;</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;  mplasma = &amp;<a class="code" href="python_8h.html#a0453c2160b73529f8d858dccfc85aad5">macromain</a>[xplasma-&gt;<a class="code" href="structplasma.html#a8220b5d466addc895b973f092d9b7b15">nplasma</a>];</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;  <span class="comment">/* Start with an outer loop over elements: there are no rates that couple</span></div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;<span class="comment">     levels of different elements so we can always separate them out. */</span></div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;  <span class="keywordflow">for</span> (index_element = 0; index_element &lt; <a class="code" href="atomic_8h.html#a23ae6a00bed19d2ad34d439636e797da">nelements</a>; index_element++)</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;  {</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;    <span class="comment">/* Zero all elements of the matrix before doing anything else. */</span></div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;    <span class="keywordflow">for</span> (nn = 0; nn &lt; <a class="code" href="atomic_8h.html#af618fc4a6769a63822cf1f4be873ce23">NLEVELS_MACRO</a>; nn++)</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;    {</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;      <span class="keywordflow">for</span> (mm = 0; mm &lt; <a class="code" href="atomic_8h.html#af618fc4a6769a63822cf1f4be873ce23">NLEVELS_MACRO</a>; mm++)</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;      {</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;        rate_matrix[mm][nn] = 0.0;</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;        <span class="comment">/* 140423 JM -- new int array to flag if  two levels are radiatively linked</span></div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;<span class="comment">           initialize to 0 */</span></div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;        radiative_flag[mm][nn] = 0;</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;      }</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    }</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;    <span class="comment">/* See if this element uses a macro atom treatment or is a simple element.</span></div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="comment">       For now I&#39;m assuming that either all ions of a given element are</span></div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="comment">       treated using the macro atom method, or else none are (mixing and</span></div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;<span class="comment">       matching is probably a bad idea because of the way in which bf</span></div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;<span class="comment">       processes couple different ionisation stages). */</span></div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;    <span class="comment">/* The check is against the first ion of the element. */</span></div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="atomic_8h.html#ae721a9114e3cf54f9bcc3dab31072273">ion</a>[<a class="code" href="atomic_8h.html#a5696fba91c25a0a9593747ac3ca6ebf1">ele</a>[index_element].firstion].<a class="code" href="structtopbase__phot.html#a0552ae390dbc87aa64fdd05d32227006">macro_info</a> == 1 &amp;&amp; <a class="code" href="python_8h.html#a3a571e0bd4220490c5c5bd86f51c83ba">geo</a>.<a class="code" href="structgeometry.html#ac453ab1a6ed3b90674cd6552c0185bff">macro_simple</a> == 0)</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;    {</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;      sane_populations = 0;</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;      <span class="keywordflow">while</span> (sane_populations == 0)</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;      {</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;        <span class="comment">/* Having established that the ion requires a macro atom treatment we</span></div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;<span class="comment">           are going to construct a matrix of rates between the levels and</span></div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;<span class="comment">           invert that matrix to get the level populations. The first thing we need</span></div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;<span class="comment">           to do is work out how many levels we are dealing with in total. This is</span></div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;<span class="comment">           easily done by summing up the number of levels of each ion. */</span></div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;        n_macro_lvl = 0;</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;        <span class="keywordflow">for</span> (index_ion = <a class="code" href="atomic_8h.html#a5696fba91c25a0a9593747ac3ca6ebf1">ele</a>[index_element].firstion; index_ion &lt; (<a class="code" href="atomic_8h.html#a5696fba91c25a0a9593747ac3ca6ebf1">ele</a>[index_element].<a class="code" href="structelements.html#a309aeae50d0264cd963f1a1815ce604e">firstion</a> + <a class="code" href="atomic_8h.html#a5696fba91c25a0a9593747ac3ca6ebf1">ele</a>[index_element].<a class="code" href="structelements.html#a90866d4e99cc142553839ad5e8f13dbc">nions</a>); index_ion++)</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;        {</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;          <span class="keywordflow">for</span> (index_lvl = <a class="code" href="atomic_8h.html#ae721a9114e3cf54f9bcc3dab31072273">ion</a>[index_ion].first_nlte_level; index_lvl &lt; <a class="code" href="atomic_8h.html#ae721a9114e3cf54f9bcc3dab31072273">ion</a>[index_ion].<a class="code" href="structions.html#a83472c99234de6ca9d530d69b71e3d04">first_nlte_level</a> + <a class="code" href="atomic_8h.html#ae721a9114e3cf54f9bcc3dab31072273">ion</a>[index_ion].<a class="code" href="structions.html#ad10a7e7016ca466bb48a388847845b8e">nlte</a>; index_lvl++)</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;          {</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;            <span class="comment">/* I want to be able to easily go from knowing the index of a level in the</span></div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;<span class="comment">               configurations structure to its position in the rates matrix. So I&#39;m making</span></div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;<span class="comment">               two arrays here that allow the mapping between these indices to be done easily.</span></div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;<span class="comment">             */</span></div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;            conf_to_matrix[index_lvl] = n_macro_lvl;</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;            n_macro_lvl++;</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;          }</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;        }</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;        <span class="comment">/* We now know how many levels there are and therefore how big the matrix we</span></div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;<span class="comment">           need to invert will be. */</span></div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;        <span class="comment">/* Now we want to populate the matrix with all the rates between the levels. */</span></div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;        <span class="keywordflow">for</span> (index_ion = <a class="code" href="atomic_8h.html#a5696fba91c25a0a9593747ac3ca6ebf1">ele</a>[index_element].firstion; index_ion &lt; (<a class="code" href="atomic_8h.html#a5696fba91c25a0a9593747ac3ca6ebf1">ele</a>[index_element].<a class="code" href="structelements.html#a309aeae50d0264cd963f1a1815ce604e">firstion</a> + <a class="code" href="atomic_8h.html#a5696fba91c25a0a9593747ac3ca6ebf1">ele</a>[index_element].<a class="code" href="structelements.html#a90866d4e99cc142553839ad5e8f13dbc">nions</a>); index_ion++)</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;        {</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;          index_lvl = <a class="code" href="atomic_8h.html#ae721a9114e3cf54f9bcc3dab31072273">ion</a>[index_ion].<a class="code" href="structions.html#a83472c99234de6ca9d530d69b71e3d04">first_nlte_level</a>;</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;          <span class="comment">/* The next loop judges whether or not a level is to be fixed in population relative to ground</span></div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;<span class="comment">             star. The input radiative lifetime is used to judge this at the moment. If the lifetime was set</span></div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;<span class="comment">             to be long (essentially infite) then a very fast collisional transition is put in to dominate</span></div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;<span class="comment">             all other rates into and out of this level.</span></div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;<span class="comment"></span></div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;<span class="comment">             Whether this is really the best thing to do I don&#39;t know, but it&#39;s an improvement over ignoring</span></div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;<span class="comment">             this issue altogether! SS Aug 05 */</span></div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;          <span class="keywordflow">for</span> (index_fast_col = index_lvl; index_fast_col &lt; <a class="code" href="atomic_8h.html#ae721a9114e3cf54f9bcc3dab31072273">ion</a>[index_ion].<a class="code" href="structions.html#a83472c99234de6ca9d530d69b71e3d04">first_nlte_level</a> + <a class="code" href="atomic_8h.html#ae721a9114e3cf54f9bcc3dab31072273">ion</a>[index_ion].<a class="code" href="structions.html#ad10a7e7016ca466bb48a388847845b8e">nlte</a> - 1; index_fast_col++)</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;          {</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;            {</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;              <span class="keywordflow">if</span> (<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[index_fast_col + 1].rad_rate &gt; 1.e15)</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;              {</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;                <a class="code" href="atomic_8h.html#adab2db9c1b71c19f88f08d4130fd335d">fast_line</a>.<a class="code" href="structlines.html#a5165d0546a6f5fa57612a4476d2b5ab9">gl</a> = <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[index_lvl].<a class="code" href="structconfigurations.html#a568aa359240b411f0774506fb0857f7c">g</a>;</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;                <a class="code" href="atomic_8h.html#adab2db9c1b71c19f88f08d4130fd335d">fast_line</a>.<a class="code" href="structlines.html#a0e2eb51cd04b7d4bbc112e63d1744a9f">gu</a> = <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[index_fast_col + 1].<a class="code" href="structconfigurations.html#a568aa359240b411f0774506fb0857f7c">g</a>;</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;                <a class="code" href="atomic_8h.html#adab2db9c1b71c19f88f08d4130fd335d">fast_line</a>.<a class="code" href="structlines.html#a4d74840df54d02617c21c66b2498a81c">freq</a> = (<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[index_fast_col + 1].<a class="code" href="structconfigurations.html#a7759058c9db6702f3e3cefa8c2506110">ex</a> - <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[index_lvl].<a class="code" href="structconfigurations.html#a7759058c9db6702f3e3cefa8c2506110">ex</a>) / <a class="code" href="atomic_8h.html#abec92cc72a096640b821b8cd56a02495">H</a>;</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;                <a class="code" href="atomic_8h.html#adab2db9c1b71c19f88f08d4130fd335d">fast_line</a>.<a class="code" href="structlines.html#adda9b685ebb8bc0dd55faea92c24f3ca">f</a> = 1e4;</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;                rate = <a class="code" href="foo_8h.html#a277d190575cbdab99ac77d308dc9dfa1">q12</a> (&amp;<a class="code" href="atomic_8h.html#adab2db9c1b71c19f88f08d4130fd335d">fast_line</a>, xplasma-&gt;<a class="code" href="structplasma.html#a9b217285a754e1533f95d92972b6afd6">t_e</a>) * xne;</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;                lower = conf_to_matrix[index_lvl];</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;                upper = conf_to_matrix[index_fast_col + 1];</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;                rate_matrix[lower][lower] += -1. * rate;</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;                rate_matrix[upper][lower] += rate;</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;                rate = <a class="code" href="foo_8h.html#a6daa97078321cf4f668d31b7004fed6c">q21</a> (&amp;<a class="code" href="atomic_8h.html#adab2db9c1b71c19f88f08d4130fd335d">fast_line</a>, xplasma-&gt;<a class="code" href="structplasma.html#a9b217285a754e1533f95d92972b6afd6">t_e</a>) * xne;</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;                rate_matrix[upper][upper] += -1. * rate;</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;                rate_matrix[lower][upper] += rate;</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;              }</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;            }</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;          }</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;          <span class="keywordflow">for</span> (index_lvl = <a class="code" href="atomic_8h.html#ae721a9114e3cf54f9bcc3dab31072273">ion</a>[index_ion].first_nlte_level; index_lvl &lt; <a class="code" href="atomic_8h.html#ae721a9114e3cf54f9bcc3dab31072273">ion</a>[index_ion].<a class="code" href="structions.html#a83472c99234de6ca9d530d69b71e3d04">first_nlte_level</a> + <a class="code" href="atomic_8h.html#ae721a9114e3cf54f9bcc3dab31072273">ion</a>[index_ion].<a class="code" href="structions.html#ad10a7e7016ca466bb48a388847845b8e">nlte</a>; index_lvl++)</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;          {</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;            <span class="comment">/* Now add contribution for all the bb and bf processes between the levels. This is</span></div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;<span class="comment">               done by looping over the numbers &quot;bbu, bbd, bfu, bfd&quot; which tell us how many</span></div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;<span class="comment">               processes there are. */</span></div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;            <span class="keywordflow">for</span> (index_bbu = 0; index_bbu &lt; <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[index_lvl].<a class="code" href="structconfigurations.html#a9e1d8406fcb5d8d371e61e11750653a7">n_bbu_jump</a>; index_bbu++)</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;            {</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;              <span class="comment">/* These are bb upwards jumps. The rate in such a jump is given by</span></div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;<span class="comment">                 Jbar which has been computed as a Monte Carlo estimator. I&#39;m also</span></div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;<span class="comment">                 including a collisional term (which depends on ne). */</span></div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;              line_ptr = &amp;<a class="code" href="atomic_8h.html#a1df743c9da06da92232eff98af40239a">line</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[index_lvl].<a class="code" href="structconfigurations.html#adbe6f0e8f48ab2ac418543cd5bbb5d12">bbu_jump</a>[index_bbu]];</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;              rate = <a class="code" href="foo_8h.html#ac84f4556e3972c1fe39b74fd9b7b4241">b12</a> (line_ptr) * mplasma-&gt;<a class="code" href="structmacro.html#a517e7721172c08c80b4f8a1b20274385">jbar_old</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[index_lvl].<a class="code" href="structconfigurations.html#a006c163c0458412401d44aca2d8b228d">bbu_indx_first</a> + index_bbu];</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;              rate += <a class="code" href="foo_8h.html#a277d190575cbdab99ac77d308dc9dfa1">q12</a> (line_ptr, xplasma-&gt;<a class="code" href="structplasma.html#a9b217285a754e1533f95d92972b6afd6">t_e</a>) * xne;</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;              <span class="comment">/* This is the rate out of the level in question. We need to add it</span></div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;<span class="comment">                 to the matrix in two places: firstly as a -ve contribution to the</span></div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;<span class="comment">                 diagonal and secondly as a +ve contribution for the off-diagonal</span></div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;<span class="comment">                 corresponding to the level populated by this process. */</span></div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;              <span class="comment">/* Get the matix indices for the upper and lower states of the jump. */</span></div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;              lower = conf_to_matrix[index_lvl];</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;              upper = conf_to_matrix[line_ptr-&gt;<a class="code" href="structlines.html#a96fff3bddbfd451e708fe60b9b495784">nconfigu</a>];</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;              rate_matrix[lower][lower] += -1. * rate;</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;              rate_matrix[upper][lower] += rate;</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;              <span class="keywordflow">if</span> (rate &lt; 0.0 || <a class="code" href="log_8h.html#aaadbb20af7b628f26e81e4e49b1a379f">sane_check</a> (rate))</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;              {</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;                <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;macro_pops: bbu rate is %8.4e in cell/matom %i\n&quot;</span>, rate, xplasma-&gt;<a class="code" href="structplasma.html#a8220b5d466addc895b973f092d9b7b15">nplasma</a>);</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;              }</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;              <span class="comment">/* There&#39;s a radiative jump between these levels, so we want to clean</span></div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;<span class="comment">                 for popualtion inversions. Flag this jump */</span></div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;              radiative_flag[index_lvl][line_ptr-&gt;<a class="code" href="structlines.html#a96fff3bddbfd451e708fe60b9b495784">nconfigu</a>] = 1;</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;            }</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;            <span class="keywordflow">for</span> (index_bbd = 0; index_bbd &lt; <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[index_lvl].<a class="code" href="structconfigurations.html#ade544b4d373e9e586f689a19330037ec">n_bbd_jump</a>; index_bbd++)</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;            {</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;              <span class="comment">/* These are bb downwards jumps. The rate in such a jump is given by</span></div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;<span class="comment">                 the A-value. I&#39;m also</span></div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;<span class="comment">                 including a collisional term (which depends on ne). */</span></div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;              line_ptr = &amp;<a class="code" href="atomic_8h.html#a1df743c9da06da92232eff98af40239a">line</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[index_lvl].<a class="code" href="structconfigurations.html#a4d26c780eab93bd42aeefef3ddc9fcda">bbd_jump</a>[index_bbd]];</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;              rate = (<a class="code" href="atomic_8c.html#a8c589bd3089b7851e8da407ad1ce44a5">a21</a> (line_ptr) * <a class="code" href="foo_8h.html#a3579026b8eac7743ef56ad21ff9696ff">p_escape</a> (line_ptr, xplasma));</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;              <span class="comment">//rate =0.0;</span></div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;              rate += <a class="code" href="foo_8h.html#a6daa97078321cf4f668d31b7004fed6c">q21</a> (line_ptr, xplasma-&gt;<a class="code" href="structplasma.html#a9b217285a754e1533f95d92972b6afd6">t_e</a>) * xne;</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;              <span class="comment">/* This is the rate out of the level in question. We need to add it</span></div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;<span class="comment">                 to the matrix in two places: firstly as a -ve contribution to the</span></div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;<span class="comment">                 diagonal and secondly as a +ve contribution for the off-diagonal</span></div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;<span class="comment">                 corresponding to the level populated by this process. */</span></div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;              <span class="comment">/* Get the matix indices for the upper and lower states of the jump. */</span></div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;              upper = conf_to_matrix[index_lvl];</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;              lower = conf_to_matrix[line_ptr-&gt;<a class="code" href="structlines.html#aa570454ab15c3c7d4324b54a254daf05">nconfigl</a>];</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;              rate_matrix[upper][upper] += -1. * rate;</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;              rate_matrix[lower][upper] += rate;</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;              <span class="comment">/* There&#39;s a radiative jump between these levels, so we want to clean</span></div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;<span class="comment">                 for popualtion inversions. Flag this jump */</span></div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;              radiative_flag[line_ptr-&gt;<a class="code" href="structlines.html#aa570454ab15c3c7d4324b54a254daf05">nconfigl</a>][index_lvl] = 1;</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;              <span class="keywordflow">if</span> (rate &lt; 0.0 || <a class="code" href="log_8h.html#aaadbb20af7b628f26e81e4e49b1a379f">sane_check</a> (rate))</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;              {</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;                <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;macro_pops: bbd rate is %8.4e in cell/matom %i\n&quot;</span>, rate, xplasma-&gt;<a class="code" href="structplasma.html#a8220b5d466addc895b973f092d9b7b15">nplasma</a>);</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;              }</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;            }</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;            <span class="keywordflow">for</span> (index_bfu = 0; index_bfu &lt; <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[index_lvl].<a class="code" href="structconfigurations.html#aeab07933f8fe82391d5c8f3e4113d1bd">n_bfu_jump</a>; index_bfu++)</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;            {</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;              <span class="comment">/* These are bf upwards jumps. The rate in such a jump is given by</span></div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;<span class="comment">                 gamma which has been computed as a Monte Carlo estimator. */</span></div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;              cont_ptr = &amp;<a class="code" href="atomic_8h.html#aed5961eebbc0ca048e57fe2ad4cdfab8">phot_top</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[index_lvl].<a class="code" href="structconfigurations.html#ad7ff676cefd02052bf9ec5a92f37db98">bfu_jump</a>[index_bfu]];</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;              rate = mplasma-&gt;<a class="code" href="structmacro.html#ae6d7a0a034aa6e4b67b5a379fc599b4d">gamma_old</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[index_lvl].<a class="code" href="structconfigurations.html#a8942d3fe089878881187ced90e2ccc5e">bfu_indx_first</a> + index_bfu];</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;              rate += <a class="code" href="direct__ion_8c.html#ad33c3a097208fb519a5e779c62e3d1f3">q_ioniz</a> (cont_ptr, xplasma-&gt;<a class="code" href="structplasma.html#a9b217285a754e1533f95d92972b6afd6">t_e</a>) * xne;</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;              <span class="comment">/* This is the rate out of the level in question. We need to add it</span></div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;<span class="comment">                 to the matrix in two places: firstly as a -ve contribution to the</span></div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;<span class="comment">                 diagonal and secondly as a +ve contribution for the off-diagonal</span></div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;<span class="comment">                 corresponding to the level populated by this process. */</span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;              <span class="comment">/* Get the matix indices for the upper and lower states of the jump. */</span></div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;              lower = conf_to_matrix[index_lvl];</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;              upper = conf_to_matrix[cont_ptr-&gt;<a class="code" href="structtopbase__phot.html#aa07be8946fb5a7bb165ee7f3e90aeb7c">uplev</a>];</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;              rate_matrix[lower][lower] += -1. * rate;</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;              rate_matrix[upper][lower] += rate;</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;              <span class="keywordflow">if</span> (rate &lt; 0.0 || <a class="code" href="log_8h.html#aaadbb20af7b628f26e81e4e49b1a379f">sane_check</a> (rate))</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;              {</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;                <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;macro_pops: bfu rate is %8.4e in cell/matom %i\n&quot;</span>, rate, xplasma-&gt;<a class="code" href="structplasma.html#a8220b5d466addc895b973f092d9b7b15">nplasma</a>);</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;              }</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;              <span class="comment">/* Now deal with the stimulated emission. */</span></div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;              <span class="comment">/* Lower and upper are the same, but now it contributes in the</span></div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;<span class="comment">                 other direction. */</span></div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;              rate = mplasma-&gt;<a class="code" href="structmacro.html#adc584bf7d87a213e34b03a3631078c4d">alpha_st_old</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[index_lvl].<a class="code" href="structconfigurations.html#a8942d3fe089878881187ced90e2ccc5e">bfu_indx_first</a> + index_bfu] * xne;</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;              rate_matrix[upper][upper] += -1. * rate;</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;              rate_matrix[lower][upper] += rate;</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;              <span class="keywordflow">if</span> (rate &lt; 0.0 || <a class="code" href="log_8h.html#aaadbb20af7b628f26e81e4e49b1a379f">sane_check</a> (rate))</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;              {</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;                <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;macro_pops: st. recomb rate is %8.4e in cell/matom %i\n&quot;</span>, rate, xplasma-&gt;<a class="code" href="structplasma.html#a8220b5d466addc895b973f092d9b7b15">nplasma</a>);</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;              }</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;            }</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;            <span class="keywordflow">for</span> (index_bfd = 0; index_bfd &lt; <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[index_lvl].<a class="code" href="structconfigurations.html#acfee0b128e4e7c2a4e6aea0687a233d9">n_bfd_jump</a>; index_bfd++)</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;            {</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;              <span class="comment">/* These are bf downwards jumps. The rate in such a jump is given by</span></div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;<span class="comment">                 the alpha value. */</span></div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;              cont_ptr = &amp;<a class="code" href="atomic_8h.html#aed5961eebbc0ca048e57fe2ad4cdfab8">phot_top</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[index_lvl].<a class="code" href="structconfigurations.html#a20d66fef678daa8ef52c0b933546e16a">bfd_jump</a>[index_bfd]];</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;              <span class="comment">/* Get new values of the recombination rates and store them. */</span></div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;              mplasma-&gt;<a class="code" href="structmacro.html#aa33a4e57be212a9a8f49edf6660350cb">recomb_sp</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[index_lvl].<a class="code" href="structconfigurations.html#abc158a8d23c5630e6eedf3a1866af30c">bfd_indx_first</a> + index_bfd] = <a class="code" href="foo_8h.html#a53e97649d5cd9a1fab024ab99489ddb1">alpha_sp</a> (cont_ptr, xplasma, 0);</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;              mplasma-&gt;<a class="code" href="structmacro.html#a13217cd83bb2aff404860f1eea75d18e">recomb_sp_e</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[index_lvl].<a class="code" href="structconfigurations.html#abc158a8d23c5630e6eedf3a1866af30c">bfd_indx_first</a> + index_bfd] = <a class="code" href="foo_8h.html#a53e97649d5cd9a1fab024ab99489ddb1">alpha_sp</a> (cont_ptr, xplasma, 2);</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;              rate = mplasma-&gt;<a class="code" href="structmacro.html#aa33a4e57be212a9a8f49edf6660350cb">recomb_sp</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[index_lvl].<a class="code" href="structconfigurations.html#abc158a8d23c5630e6eedf3a1866af30c">bfd_indx_first</a> + index_bfd] * xne;</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;              rate += <a class="code" href="direct__ion_8c.html#a432a9569392003e4470067b1c44dca5b">q_recomb</a> (cont_ptr, xplasma-&gt;<a class="code" href="structplasma.html#a9b217285a754e1533f95d92972b6afd6">t_e</a>) * xne * xne;</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;              <span class="comment">/* This is the rate out of the level in question. We need to add it</span></div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;<span class="comment">                 to the matrix in two places: firstly as a -ve contribution to the</span></div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;<span class="comment">                 diagonal and secondly as a +ve contribution for the off-diagonal</span></div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;<span class="comment">                 corresponding to the level populated by this process. */</span></div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;              <span class="comment">/* Get the matix indices for the upper and lower states of the jump. */</span></div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;              upper = conf_to_matrix[index_lvl];</div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;              lower = conf_to_matrix[cont_ptr-&gt;<a class="code" href="structtopbase__phot.html#ae51ac7fd7f3c120cf7eb188b207b824f">nlev</a>];</div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;              rate_matrix[upper][upper] += -1. * rate;</div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;              rate_matrix[lower][upper] += rate;</div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;              <span class="keywordflow">if</span> (rate &lt; 0.0 || <a class="code" href="log_8h.html#aaadbb20af7b628f26e81e4e49b1a379f">sane_check</a> (rate))</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;              {</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;                <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;macro_pops: bfd rate is %8.4e in cell/matom %i\n&quot;</span>, rate, xplasma-&gt;<a class="code" href="structplasma.html#a8220b5d466addc895b973f092d9b7b15">nplasma</a>);</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;              }</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;            }</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;          }</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;        }</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;        <span class="comment">/* The rate matrix is now filled up. Since the problem is not closed as it stands, the next</span></div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;<span class="comment">           thing is to replace one of the rows of the matrix (say the first row) with the constraint</span></div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;<span class="comment">           that the sum of all the populations is 1.0 (this will let us get population fractions). */</span></div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;        <span class="keywordflow">for</span> (index_lvl = 0; index_lvl &lt; n_macro_lvl; index_lvl++)</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;        {</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;          rate_matrix[0][index_lvl] = 1.0;</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;        }</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;        <span class="comment">/* Now we can just invert the matrix to get the fractional level populations. */</span></div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;          <span class="comment">/********************************************************************************/</span></div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;        <span class="comment">/* The block that follows (down to next line of ***s) is to do the</span></div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;<span class="comment">           matrix inversion. It uses LU decomposition - the code for doing this is</span></div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;<span class="comment">           taken from the GSL manual with very few modifications. */</span></div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;        <span class="comment">/* here we solve the matrix equation M x = b, where x is our vector containing</span></div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;<span class="comment">           level populations as a fraction w.r.t the whole element */</span></div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;        <span class="comment">/* Replaced inline array allocaation with calloc, which will work with older version of c compilers */</span></div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;        a_data = (<span class="keywordtype">double</span> *) calloc (<span class="keyword">sizeof</span> (rate), n_macro_lvl * n_macro_lvl);</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;        <span class="keywordflow">for</span> (nn = 0; nn &lt; n_macro_lvl; nn++)</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;        {</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;          <span class="keywordflow">for</span> (mm = 0; mm &lt; n_macro_lvl; mm++)</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;          {</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;            a_data[nn * n_macro_lvl + mm] = rate_matrix[nn][mm];</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;          }</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;        }</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;        <span class="comment">/* Replaced inline array allocaation with calloc, which will work with older version of c compilers</span></div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;<span class="comment">           calloc also sets the elements to zero, which is required */</span></div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;        b_data = (<span class="keywordtype">double</span> *) calloc (<span class="keyword">sizeof</span> (rate), n_macro_lvl);</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;        populations = (<span class="keywordtype">double</span> *) calloc (<span class="keyword">sizeof</span> (rate), n_macro_lvl);</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;        <span class="comment">/* replace the first entry with 1.0- this is part of the normalisation constraint */</span></div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;        b_data[0] = 1.0;</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;        <span class="comment">/* this next routine is a general routine which solves the matrix equation</span></div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;<span class="comment">           via LU decomposition */</span></div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;        ierr = <a class="code" href="foo_8h.html#a37b054a7922fd8ef0a3c003f01b0aa2d">solve_matrix</a> (a_data, b_data, n_macro_lvl, populations, xplasma-&gt;<a class="code" href="structplasma.html#a8220b5d466addc895b973f092d9b7b15">nplasma</a>);</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;        <span class="keywordflow">if</span> (ierr != 0)</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;          <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;macro_pops: bad return from solve_matrix\n&quot;</span>);</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;        <span class="comment">/* free memory */</span></div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;        free (a_data);</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;        free (b_data);</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160;        <span class="comment">/* MC noise can cause population inversions (particularly amongst highly excited states)</span></div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;<span class="comment">           which are never a good thing and most likely unphysical.</span></div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;<span class="comment">           Therefor let&#39;s follow Leon&#39;s procedure (Lucy 2003) and remove inversions. */</span></div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;        <span class="keywordflow">for</span> (index_ion = <a class="code" href="atomic_8h.html#a5696fba91c25a0a9593747ac3ca6ebf1">ele</a>[index_element].firstion; index_ion &lt; (<a class="code" href="atomic_8h.html#a5696fba91c25a0a9593747ac3ca6ebf1">ele</a>[index_element].<a class="code" href="structelements.html#a309aeae50d0264cd963f1a1815ce604e">firstion</a> + <a class="code" href="atomic_8h.html#a5696fba91c25a0a9593747ac3ca6ebf1">ele</a>[index_element].<a class="code" href="structelements.html#a90866d4e99cc142553839ad5e8f13dbc">nions</a>); index_ion++)</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;        {</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;          <span class="keywordflow">for</span> (index_lvl = <a class="code" href="atomic_8h.html#ae721a9114e3cf54f9bcc3dab31072273">ion</a>[index_ion].first_nlte_level; index_lvl &lt; <a class="code" href="atomic_8h.html#ae721a9114e3cf54f9bcc3dab31072273">ion</a>[index_ion].<a class="code" href="structions.html#a83472c99234de6ca9d530d69b71e3d04">first_nlte_level</a> + <a class="code" href="atomic_8h.html#ae721a9114e3cf54f9bcc3dab31072273">ion</a>[index_ion].<a class="code" href="structions.html#ad10a7e7016ca466bb48a388847845b8e">nlte</a>; index_lvl++)</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;          {                     <span class="comment">/* Start loop with lowest level of the ion. For each level in turn check to see if there&#39;s a population</span></div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;<span class="comment">                                   inversion i.e. is  upper_pop &gt; lower_pop * g_upper / g_lower. If it is then replace upper_pop with</span></div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;<span class="comment">                                   lower_pop * g_upper / g_lower. We loop over all levels higher than the currently chosen lower level. */</span></div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;            <span class="keywordflow">for</span> (nn = index_lvl + 1; nn &lt; (<a class="code" href="atomic_8h.html#ae721a9114e3cf54f9bcc3dab31072273">ion</a>[index_ion].<a class="code" href="structions.html#a83472c99234de6ca9d530d69b71e3d04">first_nlte_level</a> + <a class="code" href="atomic_8h.html#ae721a9114e3cf54f9bcc3dab31072273">ion</a>[index_ion].<a class="code" href="structions.html#ad10a7e7016ca466bb48a388847845b8e">nlte</a>); nn++)</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;            {</div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;</div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;              <span class="comment">/* this if statement means we only clean if there&#39;s a radiative jump between the levels */</span></div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;              <span class="keywordflow">if</span> (radiative_flag[index_lvl][nn])</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;              {</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;                inversion_test = populations[conf_to_matrix[index_lvl]] * <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[nn].<a class="code" href="structconfigurations.html#a568aa359240b411f0774506fb0857f7c">g</a> / <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[index_lvl].<a class="code" href="structconfigurations.html#a568aa359240b411f0774506fb0857f7c">g</a> * 0.999999;        <span class="comment">//include a correction factor</span></div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;                <span class="keywordflow">if</span> (populations[conf_to_matrix[nn]] &gt; inversion_test)</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;                {</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160;                  populations[conf_to_matrix[nn]] = inversion_test;</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;                }</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;              }</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160;            }</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;          }</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;        }</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;        <span class="comment">/* The populations are now known. The populations need to be stored</span></div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;<span class="comment">           firstly as ion populations and secondly as fractional</span></div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;<span class="comment">           level populations within an ion. Get the ion</span></div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;<span class="comment">           populations and write them to one-&gt;density[nion]. The level populations</span></div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;<span class="comment">           are to be put in &quot;levden&quot;. */</span></div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;        insane = 0;</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;        nn = 0;</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;        mm = 0;</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;        <span class="keywordflow">for</span> (index_ion = <a class="code" href="atomic_8h.html#a5696fba91c25a0a9593747ac3ca6ebf1">ele</a>[index_element].firstion; index_ion &lt; (<a class="code" href="atomic_8h.html#a5696fba91c25a0a9593747ac3ca6ebf1">ele</a>[index_element].<a class="code" href="structelements.html#a309aeae50d0264cd963f1a1815ce604e">firstion</a> + <a class="code" href="atomic_8h.html#a5696fba91c25a0a9593747ac3ca6ebf1">ele</a>[index_element].<a class="code" href="structelements.html#a90866d4e99cc142553839ad5e8f13dbc">nions</a>); index_ion++)</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;        {</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;          this_ion_density = 0.0;</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;          <span class="keywordflow">for</span> (index_lvl = <a class="code" href="atomic_8h.html#ae721a9114e3cf54f9bcc3dab31072273">ion</a>[index_ion].first_nlte_level; index_lvl &lt; <a class="code" href="atomic_8h.html#ae721a9114e3cf54f9bcc3dab31072273">ion</a>[index_ion].<a class="code" href="structions.html#a83472c99234de6ca9d530d69b71e3d04">first_nlte_level</a> + <a class="code" href="atomic_8h.html#ae721a9114e3cf54f9bcc3dab31072273">ion</a>[index_ion].<a class="code" href="structions.html#ad10a7e7016ca466bb48a388847845b8e">nlte</a>; index_lvl++)</div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;          {</div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;            level_population = populations[conf_to_matrix[index_lvl]];</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;            this_ion_density += level_population;</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;            nn++;</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;          }</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;</div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;          <span class="comment">/* Write the level populations to the</span></div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;<span class="comment">             levden array. These are fractional level populations within an ion. */</span></div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;          <span class="keywordflow">for</span> (index_lvl = <a class="code" href="atomic_8h.html#ae721a9114e3cf54f9bcc3dab31072273">ion</a>[index_ion].first_nlte_level; index_lvl &lt; <a class="code" href="atomic_8h.html#ae721a9114e3cf54f9bcc3dab31072273">ion</a>[index_ion].<a class="code" href="structions.html#a83472c99234de6ca9d530d69b71e3d04">first_nlte_level</a> + <a class="code" href="atomic_8h.html#ae721a9114e3cf54f9bcc3dab31072273">ion</a>[index_ion].<a class="code" href="structions.html#ad10a7e7016ca466bb48a388847845b8e">nlte</a>; index_lvl++)</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;          {</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;            xplasma-&gt;<a class="code" href="structplasma.html#a4fb98583700310c3abbf6fa266c755c0">levden</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[index_lvl].<a class="code" href="structconfigurations.html#a61b972e882a25cc3fb22de0cdb797103">nden</a>] = populations[conf_to_matrix[index_lvl]] / this_ion_density;</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;            <span class="keywordflow">if</span> (xplasma-&gt;<a class="code" href="structplasma.html#a4fb98583700310c3abbf6fa266c755c0">levden</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[index_lvl].<a class="code" href="structconfigurations.html#a61b972e882a25cc3fb22de0cdb797103">nden</a>] &lt; 0.0 || <a class="code" href="log_8h.html#aaadbb20af7b628f26e81e4e49b1a379f">sane_check</a> (xplasma-&gt;<a class="code" href="structplasma.html#a4fb98583700310c3abbf6fa266c755c0">levden</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[index_lvl].<a class="code" href="structconfigurations.html#a61b972e882a25cc3fb22de0cdb797103">nden</a>]))</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;            {</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;              <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;macro_pops: level %i has frac. pop. %8.4e in cell %i\n&quot;</span>,</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;                     index_lvl, xplasma-&gt;<a class="code" href="structplasma.html#a4fb98583700310c3abbf6fa266c755c0">levden</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[index_lvl].<a class="code" href="structconfigurations.html#a61b972e882a25cc3fb22de0cdb797103">nden</a>], xplasma-&gt;<a class="code" href="structplasma.html#a8220b5d466addc895b973f092d9b7b15">nplasma</a>);</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;              insane = 1;</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;            }</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;            mm++;</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;</div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;          }</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;          xplasma-&gt;<a class="code" href="structplasma.html#a711ac1ddc0f32849edd96d937ff70761">density</a>[index_ion] = this_ion_density * <a class="code" href="atomic_8h.html#a5696fba91c25a0a9593747ac3ca6ebf1">ele</a>[index_element].<a class="code" href="structelements.html#a72235377dd9fdab9cc49404b11a294c3">abun</a> * xplasma-&gt;<a class="code" href="structplasma.html#aeffd93110218aa8876f074488b026390">rho</a> * <a class="code" href="atomic_8h.html#a9dc9286373de87e475724fbd5e8c0435">rho2nh</a>;</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;          <span class="keywordflow">if</span> (<a class="code" href="log_8h.html#aaadbb20af7b628f26e81e4e49b1a379f">sane_check</a> (xplasma-&gt;<a class="code" href="structplasma.html#a711ac1ddc0f32849edd96d937ff70761">density</a>[index_ion]) || xplasma-&gt;<a class="code" href="structplasma.html#a711ac1ddc0f32849edd96d937ff70761">density</a>[index_ion] &lt; 0.0)</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;          {</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;            <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;macro_pops: ion %i has frac. pop. %8.4e in cell %i\n&quot;</span>, index_ion, xplasma-&gt;<a class="code" href="structplasma.html#a711ac1ddc0f32849edd96d937ff70761">density</a>[index_ion], xplasma-&gt;<a class="code" href="structplasma.html#a8220b5d466addc895b973f092d9b7b15">nplasma</a>);</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;            insane = 1;</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;          }</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;        }</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;        <span class="comment">/* if the variable insane has been set to 1 then that means we had either a negative or</span></div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;<span class="comment">           non-finite level population somewhere. If that is the case, then set all the estimators</span></div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;<span class="comment">           to dilute blackbodies instead and go through the solution again */</span></div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;        <span class="keywordflow">if</span> (insane)</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;        {</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;          <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;macro_pops: found unreasonable populations in cell %i, so adopting dilute BBody excitation\n&quot;</span>, xplasma-&gt;<a class="code" href="structplasma.html#a8220b5d466addc895b973f092d9b7b15">nplasma</a>);</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;          <a class="code" href="estimators_8c.html#abd62705b5006847a8dc70b442bf15332">get_dilute_estimators</a> (xplasma);</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;        }</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;        <span class="comment">/* if we didn&#39;t set insane to 1 then we have a realistic set of populations, so set sane_populations to 1 to break</span></div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;<span class="comment">           the while loop */</span></div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;          sane_populations = 1;</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;      }                         <span class="comment">// end of while sane loop</span></div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;    }                           <span class="comment">// end of if statement for macro-atoms</span></div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;  }                             <span class="comment">// end of elements loop</span></div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;  <span class="keywordflow">return</span> (0);</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;  <span class="comment">/* All done. (SS, Apr 04) */</span></div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;}</div><div class="ttc" id="structgeometry_html_a853e273c5a2a6630c2c1c609db0f47a1"><div class="ttname"><a href="structgeometry.html#a853e273c5a2a6630c2c1c609db0f47a1">geometry::reverb</a></div><div class="ttdeci">enum geometry::reverb_enum reverb</div></div>
<div class="ttc" id="structconfigurations_html_a8942d3fe089878881187ced90e2ccc5e"><div class="ttname"><a href="structconfigurations.html#a8942d3fe089878881187ced90e2ccc5e">configurations::bfu_indx_first</a></div><div class="ttdeci">int bfu_indx_first</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00208">atomic.h:208</a></div></div>
<div class="ttc" id="structlines_html_a0e2eb51cd04b7d4bbc112e63d1744a9f"><div class="ttname"><a href="structlines.html#a0e2eb51cd04b7d4bbc112e63d1744a9f">lines::gu</a></div><div class="ttdeci">double gu</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00226">atomic.h:226</a></div></div>
<div class="ttc" id="structphoton_html_a5fa87a07a9ceef33dd79aa5cdd7856cb"><div class="ttname"><a href="structphoton.html#a5fa87a07a9ceef33dd79aa5cdd7856cb">photon::w</a></div><div class="ttdeci">double w</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l01039">python.h:1039</a></div></div>
<div class="ttc" id="structplasma_html_a8220b5d466addc895b973f092d9b7b15"><div class="ttname"><a href="structplasma.html#a8220b5d466addc895b973f092d9b7b15">plasma::nplasma</a></div><div class="ttdeci">int nplasma</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00740">python.h:740</a></div></div>
<div class="ttc" id="structmacro_html_a13217cd83bb2aff404860f1eea75d18e"><div class="ttname"><a href="structmacro.html#a13217cd83bb2aff404860f1eea75d18e">macro::recomb_sp_e</a></div><div class="ttdeci">double * recomb_sp_e</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00958">python.h:958</a></div></div>
<div class="ttc" id="foo_8h_html_a4c03c66dea8a22dd2a87077c816d26c2"><div class="ttname"><a href="foo_8h.html#a4c03c66dea8a22dd2a87077c816d26c2">fake_matom_bf</a></div><div class="ttdeci">int fake_matom_bf(PhotPtr p, int *nres, int *escape)</div><div class="ttdef"><b>Definition:</b> <a href="matom_8c_source.html#l01276">matom.c:1276</a></div></div>
<div class="ttc" id="atomic_8h_html_a8c1d70d2c39e64a6cc16b6132d86c044"><div class="ttname"><a href="atomic_8h.html#a8c1d70d2c39e64a6cc16b6132d86c044">lin_ptr</a></div><div class="ttdeci">LinePtr lin_ptr[NLINES]</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00253">atomic.h:253</a></div></div>
<div class="ttc" id="compton_8c_html_ad65f0d74fe764d3ecae5ec1a89d63f08"><div class="ttname"><a href="compton_8c.html#ad65f0d74fe764d3ecae5ec1a89d63f08">xplasma</a></div><div class="ttdeci">PlasmaPtr xplasma</div><div class="ttdef"><b>Definition:</b> <a href="compton_8c_source.html#l00019">compton.c:19</a></div></div>
<div class="ttc" id="structlines_html_a4d74840df54d02617c21c66b2498a81c"><div class="ttname"><a href="structlines.html#a4d74840df54d02617c21c66b2498a81c">lines::freq</a></div><div class="ttdeci">double freq</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00235">atomic.h:235</a></div></div>
<div class="ttc" id="structconfigurations_html_a20d66fef678daa8ef52c0b933546e16a"><div class="ttname"><a href="structconfigurations.html#a20d66fef678daa8ef52c0b933546e16a">configurations::bfd_jump</a></div><div class="ttdeci">int bfd_jump[NBFJUMPS]</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00206">atomic.h:206</a></div></div>
<div class="ttc" id="macro__gov_8c_html_a7de597169a947d506f6d2210de2080ac"><div class="ttname"><a href="macro__gov_8c.html#a7de597169a947d506f6d2210de2080ac">macro_gov</a></div><div class="ttdeci">int macro_gov(PhotPtr p, int *nres, int matom_or_kpkt, int *which_out)</div><div class="ttdoc">is a routine that will sit at a higher level in the code than either matom or kpkt and will govern th...</div><div class="ttdef"><b>Definition:</b> <a href="macro__gov_8c_source.html#l00057">macro_gov.c:57</a></div></div>
<div class="ttc" id="foo_8h_html_a6daa97078321cf4f668d31b7004fed6c"><div class="ttname"><a href="foo_8h.html#a6daa97078321cf4f668d31b7004fed6c">q21</a></div><div class="ttdeci">double q21(struct lines *line_ptr, double t)</div><div class="ttdoc">calculates and returns the collisional de-excitation coefficient q21 </div><div class="ttdef"><b>Definition:</b> <a href="lines_8c_source.html#l00224">lines.c:224</a></div></div>
<div class="ttc" id="foo_8h_html_a3579026b8eac7743ef56ad21ff9696ff"><div class="ttname"><a href="foo_8h.html#a3579026b8eac7743ef56ad21ff9696ff">p_escape</a></div><div class="ttdeci">double p_escape(struct lines *line_ptr, PlasmaPtr xplasma)</div><div class="ttdoc">Estimate the esccapte probability for a line in a plasma cell. </div><div class="ttdef"><b>Definition:</b> <a href="lines_8c_source.html#l00773">lines.c:773</a></div></div>
<div class="ttc" id="structlines_html_a5165d0546a6f5fa57612a4476d2b5ab9"><div class="ttname"><a href="structlines.html#a5165d0546a6f5fa57612a4476d2b5ab9">lines::gl</a></div><div class="ttdeci">double gl</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00226">atomic.h:226</a></div></div>
<div class="ttc" id="python_8h_html_a0453c2160b73529f8d858dccfc85aad5"><div class="ttname"><a href="python_8h.html#a0453c2160b73529f8d858dccfc85aad5">macromain</a></div><div class="ttdeci">MacroPtr macromain</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00986">python.h:986</a></div></div>
<div class="ttc" id="structconfigurations_html_acfee0b128e4e7c2a4e6aea0687a233d9"><div class="ttname"><a href="structconfigurations.html#acfee0b128e4e7c2a4e6aea0687a233d9">configurations::n_bfd_jump</a></div><div class="ttdeci">int n_bfd_jump</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00198">atomic.h:198</a></div></div>
<div class="ttc" id="structconfigurations_html_abc158a8d23c5630e6eedf3a1866af30c"><div class="ttname"><a href="structconfigurations.html#abc158a8d23c5630e6eedf3a1866af30c">configurations::bfd_indx_first</a></div><div class="ttdeci">int bfd_indx_first</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00209">atomic.h:209</a></div></div>
<div class="ttc" id="structconfigurations_html_a9e1d8406fcb5d8d371e61e11750653a7"><div class="ttname"><a href="structconfigurations.html#a9e1d8406fcb5d8d371e61e11750653a7">configurations::n_bbu_jump</a></div><div class="ttdeci">int n_bbu_jump</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00197">atomic.h:197</a></div></div>
<div class="ttc" id="structconfigurations_html_a568aa359240b411f0774506fb0857f7c"><div class="ttname"><a href="structconfigurations.html#a568aa359240b411f0774506fb0857f7c">configurations::g</a></div><div class="ttdeci">double g</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00199">atomic.h:199</a></div></div>
<div class="ttc" id="structplasma_html_a9b217285a754e1533f95d92972b6afd6"><div class="ttname"><a href="structplasma.html#a9b217285a754e1533f95d92972b6afd6">plasma::t_e</a></div><div class="ttdeci">double t_e</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00779">python.h:779</a></div></div>
<div class="ttc" id="structtopbase__phot_html_ae51ac7fd7f3c120cf7eb188b207b824f"><div class="ttname"><a href="structtopbase__phot.html#ae51ac7fd7f3c120cf7eb188b207b824f">topbase_phot::nlev</a></div><div class="ttdeci">int nlev</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00332">atomic.h:332</a></div></div>
<div class="ttc" id="structplasma_html_a711ac1ddc0f32849edd96d937ff70761"><div class="ttname"><a href="structplasma.html#a711ac1ddc0f32849edd96d937ff70761">plasma::density</a></div><div class="ttdeci">double * density</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00745">python.h:745</a></div></div>
<div class="ttc" id="structphoton_html"><div class="ttname"><a href="structphoton.html">photon</a></div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l01034">python.h:1034</a></div></div>
<div class="ttc" id="foo_8h_html_a53e97649d5cd9a1fab024ab99489ddb1"><div class="ttname"><a href="foo_8h.html#a53e97649d5cd9a1fab024ab99489ddb1">alpha_sp</a></div><div class="ttdeci">double alpha_sp(struct topbase_phot *cont_ptr, PlasmaPtr xplasma, int ichoice)</div><div class="ttdef"><b>Definition:</b> <a href="matom_8c_source.html#l00584">matom.c:584</a></div></div>
<div class="ttc" id="structelements_html_a90866d4e99cc142553839ad5e8f13dbc"><div class="ttname"><a href="structelements.html#a90866d4e99cc142553839ad5e8f13dbc">elements::nions</a></div><div class="ttdeci">int nions</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00089">atomic.h:89</a></div></div>
<div class="ttc" id="atomic_8h_html_adab2db9c1b71c19f88f08d4130fd335d"><div class="ttname"><a href="atomic_8h.html#adab2db9c1b71c19f88f08d4130fd335d">fast_line</a></div><div class="ttdeci">struct lines fast_line</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00257">atomic.h:257</a></div></div>
<div class="ttc" id="python_8h_html_a3a571e0bd4220490c5c5bd86f51c83ba"><div class="ttname"><a href="python_8h.html#a3a571e0bd4220490c5c5bd86f51c83ba">geo</a></div><div class="ttdeci">struct geometry geo</div></div>
<div class="ttc" id="structlines_html_adda9b685ebb8bc0dd55faea92c24f3ca"><div class="ttname"><a href="structlines.html#adda9b685ebb8bc0dd55faea92c24f3ca">lines::f</a></div><div class="ttdeci">double f</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00236">atomic.h:236</a></div></div>
<div class="ttc" id="structions_html_a83472c99234de6ca9d530d69b71e3d04"><div class="ttname"><a href="structions.html#a83472c99234de6ca9d530d69b71e3d04">ions::first_nlte_level</a></div><div class="ttdeci">int first_nlte_level</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00118">atomic.h:118</a></div></div>
<div class="ttc" id="structphoton_html_a201206174a8fa79b29526a68e20704cf"><div class="ttname"><a href="structphoton.html#a201206174a8fa79b29526a68e20704cf">photon::origin</a></div><div class="ttdeci">enum photon::origin_enum origin</div></div>
<div class="ttc" id="foo_8h_html_a9301eba8fb39302ef3da90cdb52aef4d"><div class="ttname"><a href="foo_8h.html#a9301eba8fb39302ef3da90cdb52aef4d">matom</a></div><div class="ttdeci">int matom(PhotPtr p, int *nres, int *escape)</div><div class="ttdoc">The core of the implementation of Macro Atoms in python. </div><div class="ttdef"><b>Definition:</b> <a href="matom_8c_source.html#l00097">matom.c:97</a></div></div>
<div class="ttc" id="structconfigurations_html_a4d26c780eab93bd42aeefef3ddc9fcda"><div class="ttname"><a href="structconfigurations.html#a4d26c780eab93bd42aeefef3ddc9fcda">configurations::bbd_jump</a></div><div class="ttdeci">int bbd_jump[NBBJUMPS]</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00204">atomic.h:204</a></div></div>
<div class="ttc" id="direct__ion_8c_html_ad33c3a097208fb519a5e779c62e3d1f3"><div class="ttname"><a href="direct__ion_8c.html#ad33c3a097208fb519a5e779c62e3d1f3">q_ioniz</a></div><div class="ttdeci">double q_ioniz(struct topbase_phot *cont_ptr, double electron_temperature)</div><div class="ttdoc">returns the collisional ionization rate co-efficient </div><div class="ttdef"><b>Definition:</b> <a href="direct__ion_8c_source.html#l00387">direct_ion.c:387</a></div></div>
<div class="ttc" id="structconfigurations_html_a7759058c9db6702f3e3cefa8c2506110"><div class="ttname"><a href="structconfigurations.html#a7759058c9db6702f3e3cefa8c2506110">configurations::ex</a></div><div class="ttdeci">double ex</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00201">atomic.h:201</a></div></div>
<div class="ttc" id="estimators_8c_html_abd62705b5006847a8dc70b442bf15332"><div class="ttname"><a href="estimators_8c.html#abd62705b5006847a8dc70b442bf15332">get_dilute_estimators</a></div><div class="ttdeci">int get_dilute_estimators(PlasmaPtr xplasma)</div><div class="ttdoc">compute dilute matom estimators </div><div class="ttdef"><b>Definition:</b> <a href="estimators_8c_source.html#l00961">estimators.c:961</a></div></div>
<div class="ttc" id="structtopbase__phot_html"><div class="ttname"><a href="structtopbase__phot.html">topbase_phot</a></div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00329">atomic.h:329</a></div></div>
<div class="ttc" id="direct__ion_8c_html_a432a9569392003e4470067b1c44dca5b"><div class="ttname"><a href="direct__ion_8c.html#a432a9569392003e4470067b1c44dca5b">q_recomb</a></div><div class="ttdeci">double q_recomb(struct topbase_phot *cont_ptr, double electron_temperature)</div><div class="ttdoc">Returns a collisional recombination rate co-efficient. </div><div class="ttdef"><b>Definition:</b> <a href="direct__ion_8c_source.html#l00450">direct_ion.c:450</a></div></div>
<div class="ttc" id="atomic_8h_html_abec92cc72a096640b821b8cd56a02495"><div class="ttname"><a href="atomic_8h.html#abec92cc72a096640b821b8cd56a02495">H</a></div><div class="ttdeci">#define H</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00007">atomic.h:7</a></div></div>
<div class="ttc" id="structlines_html_a96fff3bddbfd451e708fe60b9b495784"><div class="ttname"><a href="structlines.html#a96fff3bddbfd451e708fe60b9b495784">lines::nconfigu</a></div><div class="ttdeci">int nconfigu</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00227">atomic.h:227</a></div></div>
<div class="ttc" id="structmacro_html_aa33a4e57be212a9a8f49edf6660350cb"><div class="ttname"><a href="structmacro.html#aa33a4e57be212a9a8f49edf6660350cb">macro::recomb_sp</a></div><div class="ttdeci">double * recomb_sp</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00955">python.h:955</a></div></div>
<div class="ttc" id="atomic_8h_html_a23ae6a00bed19d2ad34d439636e797da"><div class="ttname"><a href="atomic_8h.html#a23ae6a00bed19d2ad34d439636e797da">nelements</a></div><div class="ttdeci">int nelements</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00055">atomic.h:55</a></div></div>
<div class="ttc" id="structlines_html"><div class="ttname"><a href="structlines.html">lines</a></div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00222">atomic.h:222</a></div></div>
<div class="ttc" id="structgeometry_html_a14e36d7ed328d1a6439a8215fa0944a6"><div class="ttname"><a href="structgeometry.html#a14e36d7ed328d1a6439a8215fa0944a6">geometry::fraction_converged</a></div><div class="ttdeci">double fraction_converged</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00579">python.h:579</a></div></div>
<div class="ttc" id="python_8h_html"><div class="ttname"><a href="python_8h.html">python.h</a></div></div>
<div class="ttc" id="structions_html_ad10a7e7016ca466bb48a388847845b8e"><div class="ttname"><a href="structions.html#ad10a7e7016ca466bb48a388847845b8e">ions::nlte</a></div><div class="ttdeci">int nlte</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00122">atomic.h:122</a></div></div>
<div class="ttc" id="foo_8h_html_a16ae068adf1746f09c432de7e245dfb1"><div class="ttname"><a href="foo_8h.html#a16ae068adf1746f09c432de7e245dfb1">kpkt</a></div><div class="ttdeci">int kpkt(PhotPtr p, int *nres, int *escape)</div><div class="ttdef"><b>Definition:</b> <a href="matom_8c_source.html#l00687">matom.c:687</a></div></div>
<div class="ttc" id="atomic_8h_html_a9dc9286373de87e475724fbd5e8c0435"><div class="ttname"><a href="atomic_8h.html#a9dc9286373de87e475724fbd5e8c0435">rho2nh</a></div><div class="ttdeci">double rho2nh</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00096">atomic.h:96</a></div></div>
<div class="ttc" id="atomic_8h_html_a1df743c9da06da92232eff98af40239a"><div class="ttname"><a href="atomic_8h.html#a1df743c9da06da92232eff98af40239a">line</a></div><div class="ttdeci">LinePtr line</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00253">atomic.h:253</a></div></div>
<div class="ttc" id="foo_8h_html_ac84f4556e3972c1fe39b74fd9b7b4241"><div class="ttname"><a href="foo_8h.html#ac84f4556e3972c1fe39b74fd9b7b4241">b12</a></div><div class="ttdeci">double b12(struct lines *line_ptr)</div><div class="ttdef"><b>Definition:</b> <a href="matom_8c_source.html#l00530">matom.c:530</a></div></div>
<div class="ttc" id="structlines_html_aa570454ab15c3c7d4324b54a254daf05"><div class="ttname"><a href="structlines.html#aa570454ab15c3c7d4324b54a254daf05">lines::nconfigl</a></div><div class="ttdeci">int nconfigl</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00227">atomic.h:227</a></div></div>
<div class="ttc" id="structlines_html_a8bf1b13f22b24fc4fb517bb28dd775b8"><div class="ttname"><a href="structlines.html#a8bf1b13f22b24fc4fb517bb28dd775b8">lines::macro_info</a></div><div class="ttdeci">int macro_info</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00229">atomic.h:229</a></div></div>
<div class="ttc" id="structconfigurations_html_a006c163c0458412401d44aca2d8b228d"><div class="ttname"><a href="structconfigurations.html#a006c163c0458412401d44aca2d8b228d">configurations::bbu_indx_first</a></div><div class="ttdeci">int bbu_indx_first</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00207">atomic.h:207</a></div></div>
<div class="ttc" id="python_8h_html_ac1f90b11b79f8d2c9a25f12643063ee7"><div class="ttname"><a href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a></div><div class="ttdeci">int nres[MAXSCAT+1]</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l01138">python.h:1138</a></div></div>
<div class="ttc" id="log_8h_html_a4f4caa375f1c3a9def422000f305cce5"><div class="ttname"><a href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a></div><div class="ttdeci">int Error(char *format,...)</div><div class="ttdoc">Print/write out an error message. </div><div class="ttdef"><b>Definition:</b> <a href="xlog_8c_source.html#l00402">xlog.c:402</a></div></div>
<div class="ttc" id="atomic_8h_html"><div class="ttname"><a href="atomic_8h.html">atomic.h</a></div></div>
<div class="ttc" id="atomic_8h_html_a684683fca9c02a1eb50bd3125efdaa2c"><div class="ttname"><a href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a></div><div class="ttdeci">ConfigPtr config</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00214">atomic.h:214</a></div></div>
<div class="ttc" id="structconfigurations_html_ad7ff676cefd02052bf9ec5a92f37db98"><div class="ttname"><a href="structconfigurations.html#ad7ff676cefd02052bf9ec5a92f37db98">configurations::bfu_jump</a></div><div class="ttdeci">int bfu_jump[NBFJUMPS]</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00205">atomic.h:205</a></div></div>
<div class="ttc" id="structgeometry_html_a1cdd3c658ff714b9504c7ada69ae1f0d"><div class="ttname"><a href="structgeometry.html#a1cdd3c658ff714b9504c7ada69ae1f0d">geometry::ioniz_or_extract</a></div><div class="ttdeci">int ioniz_or_extract</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00419">python.h:419</a></div></div>
<div class="ttc" id="structmacro_html"><div class="ttname"><a href="structmacro.html">macro</a></div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00923">python.h:923</a></div></div>
<div class="ttc" id="atomic_8h_html_ae721a9114e3cf54f9bcc3dab31072273"><div class="ttname"><a href="atomic_8h.html#ae721a9114e3cf54f9bcc3dab31072273">ion</a></div><div class="ttdeci">IonPtr ion</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00174">atomic.h:174</a></div></div>
<div class="ttc" id="structconfigurations_html_aeab07933f8fe82391d5c8f3e4113d1bd"><div class="ttname"><a href="structconfigurations.html#aeab07933f8fe82391d5c8f3e4113d1bd">configurations::n_bfu_jump</a></div><div class="ttdeci">int n_bfu_jump</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00198">atomic.h:198</a></div></div>
<div class="ttc" id="atomic_8h_html_aed5961eebbc0ca048e57fe2ad4cdfab8"><div class="ttname"><a href="atomic_8h.html#aed5961eebbc0ca048e57fe2ad4cdfab8">phot_top</a></div><div class="ttdeci">Topbase_phot phot_top[NLEVELS]</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00360">atomic.h:360</a></div></div>
<div class="ttc" id="structplasma_html_a4fb98583700310c3abbf6fa266c755c0"><div class="ttname"><a href="structplasma.html#a4fb98583700310c3abbf6fa266c755c0">plasma::levden</a></div><div class="ttdeci">double * levden</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00748">python.h:748</a></div></div>
<div class="ttc" id="structconfigurations_html_ade544b4d373e9e586f689a19330037ec"><div class="ttname"><a href="structconfigurations.html#ade544b4d373e9e586f689a19330037ec">configurations::n_bbd_jump</a></div><div class="ttdeci">int n_bbd_jump</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00197">atomic.h:197</a></div></div>
<div class="ttc" id="structgeometry_html_ac453ab1a6ed3b90674cd6552c0185bff"><div class="ttname"><a href="structgeometry.html#ac453ab1a6ed3b90674cd6552c0185bff">geometry::macro_simple</a></div><div class="ttdeci">int macro_simple</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00424">python.h:424</a></div></div>
<div class="ttc" id="atomic_8c_html_a8c589bd3089b7851e8da407ad1ce44a5"><div class="ttname"><a href="atomic_8c.html#a8c589bd3089b7851e8da407ad1ce44a5">a21</a></div><div class="ttdeci">double a21(struct lines *line_ptr)</div><div class="ttdoc">Calculate the Einstein A coefficient for a transition. </div><div class="ttdef"><b>Definition:</b> <a href="atomic_8c_source.html#l00103">atomic.c:103</a></div></div>
<div class="ttc" id="log_8h_html_aaadbb20af7b628f26e81e4e49b1a379f"><div class="ttname"><a href="log_8h.html#aaadbb20af7b628f26e81e4e49b1a379f">sane_check</a></div><div class="ttdeci">int sane_check(double x)</div><div class="ttdoc">Check that a variable is valid double precision number. </div><div class="ttdef"><b>Definition:</b> <a href="xlog_8c_source.html#l00528">xlog.c:528</a></div></div>
<div class="ttc" id="structplasma_html"><div class="ttname"><a href="structplasma.html">plasma</a></div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00737">python.h:737</a></div></div>
<div class="ttc" id="macro__gov_8c_html_a590f1ed026cd692ac6f878ed6f359d5a"><div class="ttname"><a href="macro__gov_8c.html#a590f1ed026cd692ac6f878ed6f359d5a">macro_pops</a></div><div class="ttdeci">int macro_pops(PlasmaPtr xplasma, double xne)</div><div class="ttdoc">uses the Monte Carlo estimators to compute a set of level populations for levels of macro atoms...</div><div class="ttdef"><b>Definition:</b> <a href="macro__gov_8c_source.html#l00221">macro_gov.c:221</a></div></div>
<div class="ttc" id="my__linalg_8h_html"><div class="ttname"><a href="my__linalg_8h.html">my_linalg.h</a></div></div>
<div class="ttc" id="python_8h_html_a940291848296c285c722ed248863afc1"><div class="ttname"><a href="python_8h.html#a940291848296c285c722ed248863afc1">wmain</a></div><div class="ttdeci">WindPtr wmain</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00724">python.h:724</a></div></div>
<div class="ttc" id="structgeometry_html_a38b14c19caa8036cfef9998e80835a57"><div class="ttname"><a href="structgeometry.html#a38b14c19caa8036cfef9998e80835a57">geometry::reverb_fraction_converged</a></div><div class="ttdeci">double reverb_fraction_converged</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00579">python.h:579</a></div></div>
<div class="ttc" id="structelements_html_a72235377dd9fdab9cc49404b11a294c3"><div class="ttname"><a href="structelements.html#a72235377dd9fdab9cc49404b11a294c3">elements::abun</a></div><div class="ttdeci">double abun</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00090">atomic.h:90</a></div></div>
<div class="ttc" id="structplasma_html_aeffd93110218aa8876f074488b026390"><div class="ttname"><a href="structplasma.html#aeffd93110218aa8876f074488b026390">plasma::rho</a></div><div class="ttdeci">double rho</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00742">python.h:742</a></div></div>
<div class="ttc" id="atomic_8h_html_a59990369239024c94cbe22080c9d29c3"><div class="ttname"><a href="atomic_8h.html#a59990369239024c94cbe22080c9d29c3">NLINES</a></div><div class="ttdeci">#define NLINES</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00064">atomic.h:64</a></div></div>
<div class="ttc" id="structmacro_html_adc584bf7d87a213e34b03a3631078c4d"><div class="ttname"><a href="structmacro.html#adc584bf7d87a213e34b03a3631078c4d">macro::alpha_st_old</a></div><div class="ttdeci">double * alpha_st_old</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00948">python.h:948</a></div></div>
<div class="ttc" id="structmacro_html_ae6d7a0a034aa6e4b67b5a379fc599b4d"><div class="ttname"><a href="structmacro.html#ae6d7a0a034aa6e4b67b5a379fc599b4d">macro::gamma_old</a></div><div class="ttdeci">double * gamma_old</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00937">python.h:937</a></div></div>
<div class="ttc" id="structphoton_html_a2aa9d1ea7afffe4f370b28b0a21d6c79"><div class="ttname"><a href="structphoton.html#a2aa9d1ea7afffe4f370b28b0a21d6c79">photon::grid</a></div><div class="ttdeci">int grid</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l01062">python.h:1062</a></div></div>
<div class="ttc" id="structconfigurations_html_adbe6f0e8f48ab2ac418543cd5bbb5d12"><div class="ttname"><a href="structconfigurations.html#adbe6f0e8f48ab2ac418543cd5bbb5d12">configurations::bbu_jump</a></div><div class="ttdeci">int bbu_jump[NBBJUMPS]</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00203">atomic.h:203</a></div></div>
<div class="ttc" id="atomic_8h_html_a5696fba91c25a0a9593747ac3ca6ebf1"><div class="ttname"><a href="atomic_8h.html#a5696fba91c25a0a9593747ac3ca6ebf1">ele</a></div><div class="ttdeci">ElemPtr ele</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00094">atomic.h:94</a></div></div>
<div class="ttc" id="foo_8h_html_aa39c27768ea571d93b29aa2bf90e7913"><div class="ttname"><a href="foo_8h.html#aa39c27768ea571d93b29aa2bf90e7913">fake_matom_bb</a></div><div class="ttdeci">int fake_matom_bb(PhotPtr p, int *nres, int *escape)</div><div class="ttdef"><b>Definition:</b> <a href="matom_8c_source.html#l01159">matom.c:1159</a></div></div>
<div class="ttc" id="foo_8h_html_a277d190575cbdab99ac77d308dc9dfa1"><div class="ttname"><a href="foo_8h.html#a277d190575cbdab99ac77d308dc9dfa1">q12</a></div><div class="ttdeci">double q12(struct lines *line_ptr, double t)</div><div class="ttdoc">Calculate the collisional excitation coefficient for a line. </div><div class="ttdef"><b>Definition:</b> <a href="lines_8c_source.html#l00285">lines.c:285</a></div></div>
<div class="ttc" id="foo_8h_html_a37b054a7922fd8ef0a3c003f01b0aa2d"><div class="ttname"><a href="foo_8h.html#a37b054a7922fd8ef0a3c003f01b0aa2d">solve_matrix</a></div><div class="ttdeci">int solve_matrix(double *a_data, double *b_data, int nrows, double *x, int nplasma)</div><div class="ttdoc">solves the matrix equation A x = b for the vector x. </div><div class="ttdef"><b>Definition:</b> <a href="matrix__ion_8c_source.html#l00632">matrix_ion.c:632</a></div></div>
<div class="ttc" id="structelements_html_a309aeae50d0264cd963f1a1815ce604e"><div class="ttname"><a href="structelements.html#a309aeae50d0264cd963f1a1815ce604e">elements::firstion</a></div><div class="ttdeci">int firstion</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00088">atomic.h:88</a></div></div>
<div class="ttc" id="foo_8h_html_ab2919946d2f7195f5e532eefeae7dd2d"><div class="ttname"><a href="foo_8h.html#ab2919946d2f7195f5e532eefeae7dd2d">line_paths_add_phot</a></div><div class="ttdeci">int line_paths_add_phot(WindPtr wind, PhotPtr pp, int *nres)</div><div class="ttdoc">Following a line emission, increments cell paths. </div><div class="ttdef"><b>Definition:</b> <a href="paths_8c_source.html#l00212">paths.c:212</a></div></div>
<div class="ttc" id="structgeometry_html_a4b97dc16b54fd49d53a06ff8896596a6"><div class="ttname"><a href="structgeometry.html#a4b97dc16b54fd49d53a06ff8896596a6">geometry::matom_radiation</a></div><div class="ttdeci">int matom_radiation</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00403">python.h:403</a></div></div>
<div class="ttc" id="structconfigurations_html_a61b972e882a25cc3fb22de0cdb797103"><div class="ttname"><a href="structconfigurations.html#a61b972e882a25cc3fb22de0cdb797103">configurations::nden</a></div><div class="ttdeci">int nden</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00188">atomic.h:188</a></div></div>
<div class="ttc" id="structtopbase__phot_html_aa07be8946fb5a7bb165ee7f3e90aeb7c"><div class="ttname"><a href="structtopbase__phot.html#aa07be8946fb5a7bb165ee7f3e90aeb7c">topbase_phot::uplev</a></div><div class="ttdeci">int uplev</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00333">atomic.h:333</a></div></div>
<div class="ttc" id="structtopbase__phot_html_a0552ae390dbc87aa64fdd05d32227006"><div class="ttname"><a href="structtopbase__phot.html#a0552ae390dbc87aa64fdd05d32227006">topbase_phot::macro_info</a></div><div class="ttdeci">int macro_info</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00344">atomic.h:344</a></div></div>
<div class="ttc" id="structmacro_html_a517e7721172c08c80b4f8a1b20274385"><div class="ttname"><a href="structmacro.html#a517e7721172c08c80b4f8a1b20274385">macro::jbar_old</a></div><div class="ttdeci">double * jbar_old</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00931">python.h:931</a></div></div>
<div class="ttc" id="atomic_8h_html_af618fc4a6769a63822cf1f4be873ce23"><div class="ttname"><a href="atomic_8h.html#af618fc4a6769a63822cf1f4be873ce23">NLEVELS_MACRO</a></div><div class="ttdeci">#define NLEVELS_MACRO</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00062">atomic.h:62</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_b2f33c71d4aa5e7af42a1ca61ff5af1b.html">source</a></li><li class="navelem"><a class="el" href="macro__gov_8c.html">macro_gov.c</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
