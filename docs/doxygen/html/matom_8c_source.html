<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Python MCRT: /Users/mhewitt/python/source/matom.c Source File</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Python MCRT
   </div>
   <div id="projectbrief">A Monte Carlo radiative transfer and ionization code</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('matom_8c_source.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">matom.c</div>  </div>
</div><!--header-->
<div class="contents">
<a href="matom_8c.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;<span class="comment">/***********************************************************/</span></div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;<span class="preprocessor">#include &lt;stdio.h&gt;</span></div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;<span class="preprocessor">#include &lt;stdlib.h&gt;</span></div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;<span class="preprocessor">#include &lt;math.h&gt;</span></div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="atomic_8h.html">atomic.h</a>&quot;</span></div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="python_8h.html">python.h</a>&quot;</span></div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;<span class="preprocessor">#include &lt;gsl/gsl_block.h&gt;</span></div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;<span class="preprocessor">#include &lt;gsl/gsl_vector.h&gt;</span></div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;<span class="preprocessor">#include &lt;gsl/gsl_matrix.h&gt;</span></div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;<span class="comment">//#include &lt;gsl/gsl_blas.h&gt;</span></div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;<span class="preprocessor">#include &quot;<a class="code" href="my__linalg_8h.html">my_linalg.h</a>&quot;</span></div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;<span class="comment">/**********************************************************/</span></div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;<span class="keywordtype">int</span></div><div class="line"><a name="l00097"></a><span class="lineno"><a class="line" href="templates_8h.html#a9301eba8fb39302ef3da90cdb52aef4d">   97</a></span>&#160;<a class="code" href="matom_8c.html#a9301eba8fb39302ef3da90cdb52aef4d">matom</a> (p, <a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a>, escape)</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;     <a class="code" href="structphoton.html">PhotPtr</a> p;</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;     <span class="keywordtype">int</span> *<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a>;</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;     <span class="keywordtype">int</span> *escape;</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;{</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;  <span class="keyword">struct </span><a class="code" href="structlines.html">lines</a> *line_ptr;</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;  <span class="keyword">struct </span><a class="code" href="structtopbase__phot.html">topbase_phot</a> *cont_ptr;</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;  <span class="keywordtype">int</span> uplvl, uplvl_old;</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;  <span class="keywordtype">double</span> jprbs[2 * (<a class="code" href="atomic_8h.html#a27e1e039bca1d64c21caa972e1111c09">NBBJUMPS</a> + <a class="code" href="atomic_8h.html#a0829916f98c17313ddf806ae4a16355e">NBFJUMPS</a>)];</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;  <span class="keywordtype">double</span> eprbs[<a class="code" href="atomic_8h.html#a27e1e039bca1d64c21caa972e1111c09">NBBJUMPS</a> + <a class="code" href="atomic_8h.html#a0829916f98c17313ddf806ae4a16355e">NBFJUMPS</a>];</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;  <span class="keywordtype">double</span> pjnorm, penorm;</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;  <span class="keywordtype">double</span> threshold, run_tot;</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;  <span class="keywordtype">double</span> sp_rec_rate;</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>, m;</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;  <span class="keywordtype">int</span> njumps;</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;  <span class="keywordtype">int</span> nbbd, nbbu, nbfd, nbfu;</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;  <span class="keywordtype">double</span> t_e, ne;</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;  <span class="keywordtype">double</span> bb_cont, choice, bf_cont;</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;  <a class="code" href="structwind.html">WindPtr</a> one;</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;  <span class="keywordtype">double</span> rad_rate, coll_rate;</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;  <a class="code" href="structplasma.html">PlasmaPtr</a> <a class="code" href="compton_8c.html#ad65f0d74fe764d3ecae5ec1a89d63f08">xplasma</a>;</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;  <a class="code" href="structmacro.html">MacroPtr</a> mplasma;</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;  <span class="keywordtype">double</span> jprbs_known[<a class="code" href="atomic_8h.html#af618fc4a6769a63822cf1f4be873ce23">NLEVELS_MACRO</a>][2 * (<a class="code" href="atomic_8h.html#a27e1e039bca1d64c21caa972e1111c09">NBBJUMPS</a> + <a class="code" href="atomic_8h.html#a0829916f98c17313ddf806ae4a16355e">NBFJUMPS</a>)], eprbs_known[<a class="code" href="atomic_8h.html#af618fc4a6769a63822cf1f4be873ce23">NLEVELS_MACRO</a>][2 * (<a class="code" href="atomic_8h.html#a27e1e039bca1d64c21caa972e1111c09">NBBJUMPS</a> + <a class="code" href="atomic_8h.html#a0829916f98c17313ddf806ae4a16355e">NBFJUMPS</a>)];</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;  <span class="keywordtype">double</span> pjnorm_known[<a class="code" href="atomic_8h.html#af618fc4a6769a63822cf1f4be873ce23">NLEVELS_MACRO</a>], penorm_known[<a class="code" href="atomic_8h.html#af618fc4a6769a63822cf1f4be873ce23">NLEVELS_MACRO</a>];</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;  <span class="keywordtype">int</span> prbs_known[<a class="code" href="atomic_8h.html#af618fc4a6769a63822cf1f4be873ce23">NLEVELS_MACRO</a>];</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;  <span class="keywordflow">for</span> (n = 0; n &lt; <a class="code" href="atomic_8h.html#af618fc4a6769a63822cf1f4be873ce23">NLEVELS_MACRO</a>; n++)</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;  {</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;    prbs_known[<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>] = -1;         <span class="comment">//flag all as unknown</span></div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;  }</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;  one = &amp;<a class="code" href="python_8h.html#a940291848296c285c722ed248863afc1">wmain</a>[p-&gt;<a class="code" href="structphoton.html#a2aa9d1ea7afffe4f370b28b0a21d6c79">grid</a>];        <span class="comment">//This is to identify the grid cell in which we are</span></div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;  xplasma = &amp;<a class="code" href="python_8h.html#af5711847369600743b86dd27343fab7a">plasmamain</a>[one-&gt;<a class="code" href="structwind.html#ae01b6d799a4f0a60142703606c9fea3c">nplasma</a>];</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;  <a class="code" href="foo_8h.html#aa751e527d76e3ced7d54e260c6ec8cd3">check_plasma</a> (xplasma, <span class="stringliteral">&quot;matom&quot;</span>);</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;  mplasma = &amp;<a class="code" href="python_8h.html#a0453c2160b73529f8d858dccfc85aad5">macromain</a>[xplasma-&gt;<a class="code" href="structplasma.html#a8220b5d466addc895b973f092d9b7b15">nplasma</a>];</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;  t_e = xplasma-&gt;<a class="code" href="structplasma.html#a9b217285a754e1533f95d92972b6afd6">t_e</a>;           <span class="comment">//electron temperature </span></div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;  ne = xplasma-&gt;<a class="code" href="structplasma.html#ac1d38c3e4cc4ef2a1e4d83d7f8b71d22">ne</a>;             <span class="comment">//electron number density</span></div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;  <span class="comment">/* The first step is to identify the configuration that has been excited. */</span></div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;  <span class="keywordflow">if</span> (*<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a> &lt; <a class="code" href="atomic_8h.html#a59990369239024c94cbe22080c9d29c3">NLINES</a>)           <span class="comment">//this means that it was a line excitation CHECK</span></div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;  {</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;    uplvl = <a class="code" href="atomic_8h.html#a8c1d70d2c39e64a6cc16b6132d86c044">lin_ptr</a>[*<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a>]-&gt;<a class="code" href="structlines.html#a96fff3bddbfd451e708fe60b9b495784">nconfigu</a>;</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;  }</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (*<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a> &gt; <a class="code" href="atomic_8h.html#a59990369239024c94cbe22080c9d29c3">NLINES</a>)      <span class="comment">//this means it was photoionisation</span></div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;  {</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;    uplvl = <a class="code" href="atomic_8h.html#aed5961eebbc0ca048e57fe2ad4cdfab8">phot_top</a>[*<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a> - <a class="code" href="atomic_8h.html#a59990369239024c94cbe22080c9d29c3">NLINES</a> - 1].<a class="code" href="structtopbase__phot.html#aa07be8946fb5a7bb165ee7f3e90aeb7c">uplev</a>;</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;  }</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;  {</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;    <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;matom: upper level not identified. nres = %d\n&quot;</span>, *<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a>);</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;    exit (0);</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;  }</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;  <span class="comment">/* Now follows the main loop to govern the macro atom jumps. Keeps jumping until</span></div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;<span class="comment">     an emission occurs (at which point it breaks). */</span></div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;  <span class="keywordflow">for</span> (njumps = 0; njumps &lt; <a class="code" href="atomic_8h.html#ad09b144c636440e4812c09171a7d7722">MAXJUMPS</a>; njumps++)</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;  {</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;    <span class="comment">/*  The excited configuration is now known. Now compute all the probabilities of deactivation</span></div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;<span class="comment">       /jumping from this configuration. Then choose one. */</span></div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;    nbbd = <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#ade544b4d373e9e586f689a19330037ec">n_bbd_jump</a>;    <span class="comment">//store these for easy access -- number of bb downward jumps</span></div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;    nbbu = <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a9e1d8406fcb5d8d371e61e11750653a7">n_bbu_jump</a>;    <span class="comment">// number of bb upward jump from this configuration</span></div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;    nbfd = <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#acfee0b128e4e7c2a4e6aea0687a233d9">n_bfd_jump</a>;    <span class="comment">// number of bf downward jumps from this transition</span></div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;    nbfu = <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#aeab07933f8fe82391d5c8f3e4113d1bd">n_bfu_jump</a>;    <span class="comment">// number of bf upward jumps from this transiion</span></div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    <span class="keywordflow">if</span> (prbs_known[uplvl] != 1)</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    {</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;      <span class="comment">/* Start by setting everything to 0  */</span></div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;      m = 0;                    <span class="comment">//m counts the total number of possible ways to leave the level</span></div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;      pjnorm = 0.0;             <span class="comment">//stores the total jump probability</span></div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;      penorm = 0.0;             <span class="comment">//stores the total emission probability</span></div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;      <span class="keywordflow">for</span> (n = 0; n &lt; nbbd + nbfd; n++)</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;      {</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;        eprbs_known[uplvl][<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>] = eprbs[<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>] = 0;   <span class="comment">//stores the individual emission probabilities SS</span></div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;        jprbs_known[uplvl][<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>] = jprbs[<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>] = 0;   <span class="comment">//stores the individual jump probabilities SS</span></div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;      }</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;      <span class="keywordflow">for</span> (n = nbbd + nbfd; n &lt; nbbd + nbfd + nbbu + nbfu; n++)</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;      {</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;        jprbs_known[uplvl][<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>] = jprbs[<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>] = 0;   <span class="comment">/*slots for upward jumps */</span></div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;      }</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;      <span class="comment">/* Finished zeroing. */</span></div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;      <span class="comment">/* bb */</span></div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;      <span class="comment">/* First downward jumps. (I.e. those that have emission probabilities. */</span></div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;      <span class="comment">/* For bound-bound decays the jump probability is A-coeff * escape-probability * energy */</span></div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;      <span class="comment">/* At present the escape probability is only approximated (p_escape). This should be improved. */</span></div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;      <span class="comment">/* The collisional contribution to both the jumping and deactivation probabilities are now added (SS, Apr04) */</span></div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;      <span class="keywordflow">for</span> (n = 0; n &lt; nbbd; n++)</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;      {</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;        line_ptr = &amp;<a class="code" href="atomic_8h.html#a1df743c9da06da92232eff98af40239a">line</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a4d26c780eab93bd42aeefef3ddc9fcda">bbd_jump</a>[<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>]];</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;        rad_rate = (<a class="code" href="atomic_8c.html#a8c589bd3089b7851e8da407ad1ce44a5">a21</a> (line_ptr) * <a class="code" href="foo_8h.html#a3579026b8eac7743ef56ad21ff9696ff">p_escape</a> (line_ptr, xplasma));</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;        coll_rate = <a class="code" href="foo_8h.html#a6daa97078321cf4f668d31b7004fed6c">q21</a> (line_ptr, t_e);        <span class="comment">// this is multiplied by ne below</span></div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;        <span class="keywordflow">if</span> (coll_rate &lt; 0)</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;        {</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;          coll_rate = 0;</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;        }</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;        bb_cont = rad_rate + (coll_rate * ne);</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;        jprbs_known[uplvl][m] = jprbs[m] = bb_cont * <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[line_ptr-&gt;<a class="code" href="structlines.html#aa570454ab15c3c7d4324b54a254daf05">nconfigl</a>].<a class="code" href="structconfigurations.html#a7759058c9db6702f3e3cefa8c2506110">ex</a>;     <span class="comment">//energy of lower state</span></div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;        eprbs_known[uplvl][m] = eprbs[m] = bb_cont * (<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a7759058c9db6702f3e3cefa8c2506110">ex</a> - <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[<a class="code" href="atomic_8h.html#a1df743c9da06da92232eff98af40239a">line</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a4d26c780eab93bd42aeefef3ddc9fcda">bbd_jump</a>[<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>]].<a class="code" href="structlines.html#aa570454ab15c3c7d4324b54a254daf05">nconfigl</a>].<a class="code" href="structconfigurations.html#a7759058c9db6702f3e3cefa8c2506110">ex</a>);  <span class="comment">//energy difference</span></div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;        <span class="keywordflow">if</span> (jprbs[m] &lt; 0.)      <span class="comment">//test (can be deleted eventually SS)</span></div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;        {</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;          <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;Negative probability (matom, 1). Abort.&quot;</span>);</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;          exit (0);</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;        }</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;        <span class="keywordflow">if</span> (eprbs[m] &lt; 0.)      <span class="comment">//test (can be deleted eventually SS)</span></div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;        {</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;          <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;Negative probability (matom, 2). Abort.&quot;</span>);</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;          exit (0);</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;        }</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;        pjnorm += jprbs[m];</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;        penorm += eprbs[m];</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;        m++;</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;      }</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;      <span class="comment">/* bf */</span></div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;      <span class="keywordflow">for</span> (n = 0; n &lt; nbfd; n++)</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;      {</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;        cont_ptr = &amp;<a class="code" href="atomic_8h.html#aed5961eebbc0ca048e57fe2ad4cdfab8">phot_top</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a20d66fef678daa8ef52c0b933546e16a">bfd_jump</a>[<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>]];        <span class="comment">//pointer to continuum</span></div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;        <span class="keywordflow">if</span> (n &lt; 25)</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;        {</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;          sp_rec_rate = mplasma-&gt;<a class="code" href="structmacro.html#aa33a4e57be212a9a8f49edf6660350cb">recomb_sp</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#abc158a8d23c5630e6eedf3a1866af30c">bfd_indx_first</a> + <a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>];   <span class="comment">//need this twice so store it</span></div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;          bf_cont = (sp_rec_rate + <a class="code" href="direct__ion_8c.html#a432a9569392003e4470067b1c44dca5b">q_recomb</a> (cont_ptr, t_e) * ne) * ne;</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;        }</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;        <span class="keywordflow">else</span></div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;        {</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;          bf_cont = 0.0;</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;        }</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;        jprbs_known[uplvl][m] = jprbs[m] = bf_cont * <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[<a class="code" href="atomic_8h.html#aed5961eebbc0ca048e57fe2ad4cdfab8">phot_top</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a20d66fef678daa8ef52c0b933546e16a">bfd_jump</a>[<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>]].<a class="code" href="structtopbase__phot.html#ae51ac7fd7f3c120cf7eb188b207b824f">nlev</a>].<a class="code" href="structconfigurations.html#a7759058c9db6702f3e3cefa8c2506110">ex</a>;       <span class="comment">//energy of lower state</span></div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;        eprbs_known[uplvl][m] = eprbs[m] = bf_cont * (<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a7759058c9db6702f3e3cefa8c2506110">ex</a> - <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[<a class="code" href="atomic_8h.html#aed5961eebbc0ca048e57fe2ad4cdfab8">phot_top</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a20d66fef678daa8ef52c0b933546e16a">bfd_jump</a>[<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>]].<a class="code" href="structtopbase__phot.html#ae51ac7fd7f3c120cf7eb188b207b824f">nlev</a>].<a class="code" href="structconfigurations.html#a7759058c9db6702f3e3cefa8c2506110">ex</a>);  <span class="comment">//energy difference</span></div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;        <span class="keywordflow">if</span> (jprbs[m] &lt; 0.)      <span class="comment">//test (can be deleted eventually SS)</span></div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;        {</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;          <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;Negative probability (matom, 3). Abort.&quot;</span>);</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;          exit (0);</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;        }</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;        <span class="keywordflow">if</span> (eprbs[m] &lt; 0.)      <span class="comment">//test (can be deleted eventually SS)</span></div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;        {</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;          <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;Negative probability (matom, 4). Abort.&quot;</span>);</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;          exit (0);</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;        }</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;        pjnorm += jprbs[m];</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;        penorm += eprbs[m];</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;        m++;</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;      }</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;      <span class="comment">/* Now upwards jumps. */</span></div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;      <span class="comment">/* bb */</span></div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;      <span class="comment">/* For bound-bound excitation the jump probability is B-coeff times Jbar with a correction </span></div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;<span class="comment">         for stimulated emission. To avoid the need for recalculation all the time, the code will</span></div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;<span class="comment">         be designed to include the stimulated correction in Jbar - i.e. the stimulated correction</span></div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;<span class="comment">         factor will NOT be included here. (SS) */</span></div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;      <span class="comment">/* There is no emission probability for upwards transitions. */</span></div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;      <span class="comment">/* Collisional contribution to jumping probability added. (SS,Apr04) */</span></div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;      <span class="keywordflow">for</span> (n = 0; n &lt; nbbu; n++)</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;      {</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;        line_ptr = &amp;<a class="code" href="atomic_8h.html#a1df743c9da06da92232eff98af40239a">line</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#adbe6f0e8f48ab2ac418543cd5bbb5d12">bbu_jump</a>[<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>]];</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;        rad_rate = (<a class="code" href="matom_8c.html#ac84f4556e3972c1fe39b74fd9b7b4241">b12</a> (line_ptr) * mplasma-&gt;<a class="code" href="structmacro.html#a517e7721172c08c80b4f8a1b20274385">jbar_old</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a006c163c0458412401d44aca2d8b228d">bbu_indx_first</a> + <a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>]);</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;        coll_rate = <a class="code" href="foo_8h.html#a277d190575cbdab99ac77d308dc9dfa1">q12</a> (line_ptr, t_e);        <span class="comment">// this is multiplied by ne below</span></div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;        <span class="keywordflow">if</span> (coll_rate &lt; 0)</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;        {</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;          coll_rate = 0;</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;        }</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;        jprbs_known[uplvl][m] = jprbs[m] = ((rad_rate) + (coll_rate * ne)) * <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].ex;  <span class="comment">//energy of lower state</span></div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;        <span class="keywordflow">if</span> (jprbs[m] &lt; 0.)      <span class="comment">//test (can be deleted eventually SS)</span></div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;        {</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;          <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;Negative probability (matom, 5). Abort.&quot;</span>);</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;          exit (0);</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;        }</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;        pjnorm += jprbs[m];</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;        m++;</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;      }</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;      <span class="comment">/* bf */</span></div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;      <span class="keywordflow">for</span> (n = 0; n &lt; nbfu; n++)</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;      {</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;        <span class="comment">/* For bf ionization the jump probability is just gamma * energy</span></div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;<span class="comment">           gamma is the photoionisation rate. Stimulated recombination also included. */</span></div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;        cont_ptr = &amp;<a class="code" href="atomic_8h.html#aed5961eebbc0ca048e57fe2ad4cdfab8">phot_top</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#ad7ff676cefd02052bf9ec5a92f37db98">bfu_jump</a>[<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>]];        <span class="comment">//pointer to continuum</span></div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;        jprbs_known[uplvl][m] = jprbs[m] = (mplasma-&gt;<a class="code" href="structmacro.html#ae6d7a0a034aa6e4b67b5a379fc599b4d">gamma_old</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a8942d3fe089878881187ced90e2ccc5e">bfu_indx_first</a> + <a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>] - (mplasma-&gt;<a class="code" href="structmacro.html#adc584bf7d87a213e34b03a3631078c4d">alpha_st_old</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a8942d3fe089878881187ced90e2ccc5e">bfu_indx_first</a> + <a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>] * xplasma-&gt;<a class="code" href="structplasma.html#ac1d38c3e4cc4ef2a1e4d83d7f8b71d22">ne</a> * <a class="code" href="foo_8h.html#a7a80c6ec538ad7bf2b546126bac374bf">den_config</a> (xplasma, cont_ptr-&gt;<a class="code" href="structtopbase__phot.html#aa07be8946fb5a7bb165ee7f3e90aeb7c">uplev</a>) / <a class="code" href="foo_8h.html#a7a80c6ec538ad7bf2b546126bac374bf">den_config</a> (xplasma, cont_ptr-&gt;<a class="code" href="structtopbase__phot.html#ae51ac7fd7f3c120cf7eb188b207b824f">nlev</a>)) + (<a class="code" href="direct__ion_8c.html#ad33c3a097208fb519a5e779c62e3d1f3">q_ioniz</a> (cont_ptr, t_e) * ne)) * <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a7759058c9db6702f3e3cefa8c2506110">ex</a>; <span class="comment">//energy of lower state</span></div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;        <span class="comment">/* this error condition can happen in unconverged hot cells where T_R &gt;&gt; T_E.</span></div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;<span class="comment">           for the moment we set to 0 and hope spontaneous recombiantion takes care of things */</span></div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;        <span class="comment">/* note that we check and report this in check_stimulated_recomb() in estimators.c once a cycle */</span></div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;        <span class="keywordflow">if</span> (jprbs[m] &lt; 0.)      <span class="comment">//test (can be deleted eventually SS)</span></div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;        {</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;          <span class="comment">//Error (&quot;Negative probability (matom, 6). Abort?\n&quot;);</span></div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;          jprbs_known[uplvl][m] = jprbs[m] = 0.0;</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;        }</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;        pjnorm += jprbs[m];</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;        m++;</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;      }</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;      pjnorm_known[uplvl] = pjnorm;</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;      penorm_known[uplvl] = penorm;</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;      prbs_known[uplvl] = 1;</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;    }</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    <span class="comment">/* Probabilities of jumping (j) and emission (e) are now known. The normalisation factor pnorm has</span></div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;<span class="comment">       also been recorded. the integer m now gives the total number of possibilities too. </span></div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;<span class="comment">       now select what happens next. Start by choosing the random threshold value at which the</span></div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;<span class="comment">       event will occur. */</span></div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;<span class="comment">//    threshold = ((rand () + 0.5) / MAXRAND); DONE</span></div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;    threshold = <a class="code" href="foo_8h.html#a451b4740f3d1e12cb07885b0d3e5ef1b">random_number</a>(0.0,1.0);</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    <span class="keywordflow">if</span> ((pjnorm_known[uplvl] + penorm_known[uplvl]) &lt;= 0.0)</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;    {</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;      <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;matom: macro atom level has no way out %d %g %g\n&quot;</span>, uplvl, pjnorm_known[uplvl], penorm_known[uplvl]);</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;      exit (0);</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;    }</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    <span class="keywordflow">if</span> (((pjnorm_known[uplvl] / (pjnorm_known[uplvl] + penorm_known[uplvl])) &lt; threshold) || (pjnorm_known[uplvl] == 0))</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;      <span class="keywordflow">break</span>;                    <span class="comment">// An emission occurs and so we leave the for loop.</span></div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    uplvl_old = uplvl;</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;<span class="comment">// Continue on if a jump has occured </span></div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;    <span class="comment">/* Use a running total to decide where event occurs. */</span></div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;    run_tot = 0;</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;    n = 0;</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;<span class="comment">//    threshold = ((rand () + 0.5) / MAXRAND); //DONE</span></div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;    threshold = <a class="code" href="foo_8h.html#a451b4740f3d1e12cb07885b0d3e5ef1b">random_number</a>(0.0,1.0);</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;    </div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;    threshold = threshold * pjnorm_known[uplvl_old];</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;    <span class="keywordflow">while</span> (run_tot &lt; threshold)</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;    {</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;      run_tot += jprbs_known[uplvl_old][<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>];</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;      n++;</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;    }</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;    <span class="comment">// This added to prevent case where theshold is essentially 0. It is already checked that the jumping probability is not zero</span></div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;    <span class="keywordflow">if</span> (n &gt; 0)</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    {</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;      n = n - 1;</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;    }</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;    <span class="comment">/* n now identifies the jump that occurs - now set the new level. */</span></div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;    <span class="keywordflow">if</span> (n &lt; nbbd)</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;    {                           <span class="comment">/* bb downwards jump */</span></div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;      uplvl = <a class="code" href="atomic_8h.html#a1df743c9da06da92232eff98af40239a">line</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a4d26c780eab93bd42aeefef3ddc9fcda">bbd_jump</a>[<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>]].<a class="code" href="structlines.html#aa570454ab15c3c7d4324b54a254daf05">nconfigl</a>;</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;    }</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n &lt; (nbbd + nbfd))</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;    {                           <span class="comment">/* bf downwards jump */</span></div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;      uplvl = <a class="code" href="atomic_8h.html#aed5961eebbc0ca048e57fe2ad4cdfab8">phot_top</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a20d66fef678daa8ef52c0b933546e16a">bfd_jump</a>[n - nbbd]].<a class="code" href="structtopbase__phot.html#ae51ac7fd7f3c120cf7eb188b207b824f">nlev</a>;</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;    }</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n &lt; (nbbd + nbfd + nbbu))</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;    {                           <span class="comment">/* bb upwards jump */</span></div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;      uplvl = <a class="code" href="atomic_8h.html#a1df743c9da06da92232eff98af40239a">line</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#adbe6f0e8f48ab2ac418543cd5bbb5d12">bbu_jump</a>[n - nbbd - nbfd]].<a class="code" href="structlines.html#a96fff3bddbfd451e708fe60b9b495784">nconfigu</a>;</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;    }</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;    <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n &lt; (nbbd + nbfd + nbbu + nbfu))</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;    {                           <span class="comment">/* bf upwards jump */</span></div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;      uplvl = <a class="code" href="atomic_8h.html#aed5961eebbc0ca048e57fe2ad4cdfab8">phot_top</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#ad7ff676cefd02052bf9ec5a92f37db98">bfu_jump</a>[n - nbbd - nbfd - nbbu]].<a class="code" href="structtopbase__phot.html#aa07be8946fb5a7bb165ee7f3e90aeb7c">uplev</a>;</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;    }</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;    {</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;      <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;Trying to jump but nowhere to go! Matom. Abort&quot;</span>);</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;      exit (0);</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;    }</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;<span class="comment">/* ksl: Check added to verify that the level actually changed */</span></div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;    <span class="keywordflow">if</span> (uplvl_old == uplvl)</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    {</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;      <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;matom: uplvl did not change with jump: %d %d\n&quot;</span>, uplvl, n);</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;    }</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;  }</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;  <span class="comment">/* When is gets here either the sum has reached maxjumps: didn&#39;t find an emission: this is</span></div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;<span class="comment">     an error and stops the run OR an emission mechanism has been chosen in which case all is well. SS */</span></div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;  <span class="keywordflow">if</span> (njumps == MAXJUMPS)</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;  {</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;    <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;Matom: jumped %d times with no emission. Abort.\n&quot;</span>, MAXJUMPS);</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;    exit (0);</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;  }</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;  <span class="comment">/* If it gets here then an emission has occurred. SS */</span></div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;  <span class="comment">/* Use a running total to decide where event occurs. SS */</span></div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;  run_tot = 0;</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;  n = 0;</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;<span class="comment">//  threshold = ((rand () + 0.5) / MAXRAND); //DONE</span></div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;  threshold = <a class="code" href="foo_8h.html#a451b4740f3d1e12cb07885b0d3e5ef1b">random_number</a>(0.0,1.0);</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;  </div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;  threshold = threshold * penorm_known[uplvl];  <span class="comment">//normalise to total emission prob.</span></div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;  <span class="keywordflow">while</span> (run_tot &lt; threshold)</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;  {</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;    run_tot += eprbs_known[uplvl][<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>];</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;    n++;</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;  }</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;  n = n - 1;</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;  <span class="comment">/* n now identifies the jump that occurs - now set nres for the return value. */</span></div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;  <span class="keywordflow">if</span> (n &lt; nbbd)</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;  {                             <span class="comment">/* bb downwards jump */</span></div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;    <span class="comment">/* With collisions included we need to decide whether the deactivation is radiative (r-packet)</span></div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;<span class="comment">       or collisional (k-packet). Get a random number and then use the ratio of the collisional</span></div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;<span class="comment">       emission probability to the (already known) collisional+radiative probability to decide whether</span></div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;<span class="comment">       collisional or radiative deactivation occurs. */</span></div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;<span class="comment">//    choice = ((rand () + 0.5) / MAXRAND);       // the random number //DONE</span></div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;    choice = <a class="code" href="foo_8h.html#a451b4740f3d1e12cb07885b0d3e5ef1b">random_number</a>(0.0,1.0);</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;    </div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;    line_ptr = &amp;<a class="code" href="atomic_8h.html#a1df743c9da06da92232eff98af40239a">line</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a4d26c780eab93bd42aeefef3ddc9fcda">bbd_jump</a>[<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>]];        <span class="comment">//pointer for the bb transition</span></div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;    rad_rate = <a class="code" href="atomic_8c.html#a8c589bd3089b7851e8da407ad1ce44a5">a21</a> (line_ptr) * <a class="code" href="foo_8h.html#a3579026b8eac7743ef56ad21ff9696ff">p_escape</a> (line_ptr, xplasma);</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;    <span class="comment">/* JM130716 in some old versions the coll_rate was set incorrectly here- </span></div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;<span class="comment">       it needs to be multiplied by electron density */</span></div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;    coll_rate = <a class="code" href="foo_8h.html#a6daa97078321cf4f668d31b7004fed6c">q21</a> (line_ptr, t_e) * ne;</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;    <span class="keywordflow">if</span> (coll_rate &lt; 0)</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;    {</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;      coll_rate = 0.;</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;    }</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;    <span class="keywordflow">if</span> (choice &gt; (coll_rate / (rad_rate + coll_rate)))</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;    {</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;      *escape = 1;              <span class="comment">//don&#39;t need to follow this routine with a k-packet</span></div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;      <span class="comment">/* This is radiative deactivation. */</span></div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;      *<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a> = <a class="code" href="atomic_8h.html#a1df743c9da06da92232eff98af40239a">line</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a4d26c780eab93bd42aeefef3ddc9fcda">bbd_jump</a>[<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>]].<a class="code" href="structlines.html#a21eb2458dc558a817e715ca184cf8bb5">where_in_list</a>;</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;      p-&gt;<a class="code" href="structphoton.html#a98c6d400814a43aeda7d7fd1ed2d7dc6">freq</a> = <a class="code" href="atomic_8h.html#a1df743c9da06da92232eff98af40239a">line</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a4d26c780eab93bd42aeefef3ddc9fcda">bbd_jump</a>[<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>]].<a class="code" href="structlines.html#a4d74840df54d02617c21c66b2498a81c">freq</a>;</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;      <span class="comment">/* This is the comoving frequency - changed to rest frequency by doppler */</span></div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;    }</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;    {                           <span class="comment">/* This is collisional deactivation. In this case a k-packet is created and so it must be processed by</span></div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;<span class="comment">                                   the appropriate routine. (SS, Apr04) */</span></div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;      <span class="comment">/* This is done by returning escape = 0 */</span></div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;      *escape = 0;</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;    }</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;  }</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n &lt; (nbbd + nbfd))</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;  {                             <span class="comment">/* bf downwards jump */</span></div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;    <span class="comment">/* With collisional recombination included we need to decide whether to deactivate</span></div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;<span class="comment">       radiatively or make a k-packet. */</span></div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;    cont_ptr = &amp;<a class="code" href="atomic_8h.html#aed5961eebbc0ca048e57fe2ad4cdfab8">phot_top</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a20d66fef678daa8ef52c0b933546e16a">bfd_jump</a>[n - nbbd]];</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;    rad_rate = mplasma-&gt;<a class="code" href="structmacro.html#aa33a4e57be212a9a8f49edf6660350cb">recomb_sp</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#abc158a8d23c5630e6eedf3a1866af30c">bfd_indx_first</a> + n - nbbd];     <span class="comment">//again using recomb_sp rather than alpha_sp (SS July 04)</span></div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;    coll_rate = <a class="code" href="direct__ion_8c.html#a432a9569392003e4470067b1c44dca5b">q_recomb</a> (cont_ptr, t_e) * ne;</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;<span class="comment">//    choice = ((rand () + 0.5) / MAXRAND);       // the random number//DONE</span></div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;    choice = <a class="code" href="foo_8h.html#a451b4740f3d1e12cb07885b0d3e5ef1b">random_number</a>(0.0,1.0);</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;    </div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;</div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;    <span class="keywordflow">if</span> (choice &gt; (coll_rate / (rad_rate + coll_rate)))</div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;    {                           <span class="comment">//radiative deactivation</span></div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;      *escape = 1;</div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;      *<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a> = <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a20d66fef678daa8ef52c0b933546e16a">bfd_jump</a>[n - nbbd] + <a class="code" href="atomic_8h.html#a59990369239024c94cbe22080c9d29c3">NLINES</a> + 1;</div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;      <span class="comment">/* continuua are indicated by nres &gt; NLINES */</span></div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;<span class="comment">//      p-&gt;freq = phot_top[config[uplvl].bfd_jump[n - nbbd]].freq[0] - (log (1. - (rand () + 0.5) / MAXRAND) * xplasma-&gt;t_e / H_OVER_K); //DONE</span></div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;      p-&gt;<a class="code" href="structphoton.html#a98c6d400814a43aeda7d7fd1ed2d7dc6">freq</a> = <a class="code" href="atomic_8h.html#aed5961eebbc0ca048e57fe2ad4cdfab8">phot_top</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a20d66fef678daa8ef52c0b933546e16a">bfd_jump</a>[n - nbbd]].<a class="code" href="structtopbase__phot.html#a18d8d6eeb8df6e8ad2f89550c6b86310">freq</a>[0] - (log (1. -  <a class="code" href="foo_8h.html#a451b4740f3d1e12cb07885b0d3e5ef1b">random_number</a>(0.0,1.0)) * xplasma-&gt;<a class="code" href="structplasma.html#a9b217285a754e1533f95d92972b6afd6">t_e</a> / <a class="code" href="atomic_8h.html#a97148aa86d99b11c881e5f32845861d4">H_OVER_K</a>);</div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;      </div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;      <span class="comment">/* Co-moving frequency - changed to rest frequency by doppler */</span></div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;      <span class="comment">/*Currently this assumed hydrogenic shape cross-section - Improve */</span></div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;    }</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;    {                           <span class="comment">//collisional deactivation</span></div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;      *escape = 0;</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;    }</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;  }</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;  {</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;    <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;Trying to emitt from Macro Atom but no available route (matom). Abort.&quot;</span>);</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;    exit (0);</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;  }</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;  <span class="keywordflow">return</span> (0);</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;}</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;<span class="comment">/************************************</span></div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;<span class="comment">**  </span></div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;<span class="comment">* @brief the b12 Einstein coefficient.</span></div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;<span class="comment">*</span></div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;<span class="comment">* @param struct lines line_ptr line pointer to calculate</span></div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;<span class="comment">* </span></div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;<span class="comment">* ###Notes### </span></div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;<span class="comment">* History:</span></div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;<span class="comment">* 2004feb       coded by S Sim</span></div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;<span class="comment">* ksl OK, Probably should be moved to lines.c for consistency, but that can be done</span></div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;<span class="comment">* later.</span></div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;<span class="comment">* Define B12_CONSTANT</span></div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;<span class="comment">***********************************/</span></div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160; </div><div class="line"><a name="l00524"></a><span class="lineno"><a class="line" href="matom_8c.html#a4ed02e03274f12b6c0c302f6f0723bc3">  524</a></span>&#160;<span class="preprocessor">#define B12_CONSTANT 5.01983e25</span></div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;</div><div class="line"><a name="l00526"></a><span class="lineno"><a class="line" href="matom_8c.html#a2838268e309f2158a6c2948c92a299f9">  526</a></span>&#160;<span class="keyword">struct </span><a class="code" href="structlines.html">lines</a> *<a class="code" href="matom_8c.html#a2838268e309f2158a6c2948c92a299f9">b12_line_ptr</a>;</div><div class="line"><a name="l00527"></a><span class="lineno"><a class="line" href="matom_8c.html#a91b6db8e31726e041b1fc93ce0338a1b">  527</a></span>&#160;<span class="keywordtype">double</span> <a class="code" href="matom_8c.html#a91b6db8e31726e041b1fc93ce0338a1b">b12_a</a>;</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;<span class="keywordtype">double</span></div><div class="line"><a name="l00530"></a><span class="lineno"><a class="line" href="templates_8h.html#ac84f4556e3972c1fe39b74fd9b7b4241">  530</a></span>&#160;<a class="code" href="matom_8c.html#ac84f4556e3972c1fe39b74fd9b7b4241">b12</a> (line_ptr)</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;     <span class="keyword">struct </span><a class="code" href="structlines.html">lines</a> *line_ptr;</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;{</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;  <span class="keywordtype">double</span> <a class="code" href="structlines.html#a4d74840df54d02617c21c66b2498a81c">freq</a>;</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;  <span class="keywordflow">if</span> (b12_line_ptr != line_ptr)</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;  {</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;    freq = line_ptr-&gt;<a class="code" href="structlines.html#a4d74840df54d02617c21c66b2498a81c">freq</a>;</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;    <a class="code" href="matom_8c.html#a91b6db8e31726e041b1fc93ce0338a1b">b12_a</a> = <a class="code" href="matom_8c.html#a4ed02e03274f12b6c0c302f6f0723bc3">B12_CONSTANT</a> * line_ptr-&gt;<a class="code" href="structlines.html#adda9b685ebb8bc0dd55faea92c24f3ca">f</a> / <a class="code" href="structlines.html#a4d74840df54d02617c21c66b2498a81c">freq</a>;</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;    b12_line_ptr = line_ptr;</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160;  }</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;</div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;  <span class="keywordflow">return</span> (<a class="code" href="matom_8c.html#a91b6db8e31726e041b1fc93ce0338a1b">b12_a</a>);</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160;}</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;<span class="comment">/************************************************************/</span></div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160;<span class="comment">/* As for similar routines in recomb.c, in order to use the integrator the </span></div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160;<span class="comment">   following external structures are used (SS)*/</span></div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160;<span class="comment">/* This relates to the alpha_sp routines at the end of this file */</span></div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;</div><div class="line"><a name="l00550"></a><span class="lineno"><a class="line" href="matom_8c.html#a4870118e9da8bf1f4cdc629cfd2efc96">  550</a></span>&#160;<span class="keyword">struct </span><a class="code" href="structtopbase__phot.html">topbase_phot</a> *<a class="code" href="matom_8c.html#a4870118e9da8bf1f4cdc629cfd2efc96">cont_ext_ptr</a>;      <span class="comment">//continuum pointer passed externally</span></div><div class="line"><a name="l00551"></a><span class="lineno"><a class="line" href="matom_8c.html#a251b07cd6698a386f4306ff7cfb1a481">  551</a></span>&#160;<span class="keywordtype">double</span> <a class="code" href="matom_8c.html#a251b07cd6698a386f4306ff7cfb1a481">temp_ext</a>;                        <span class="comment">//temperature passed externally</span></div><div class="line"><a name="l00552"></a><span class="lineno"><a class="line" href="matom_8c.html#a55d2fd6a10cba375e78a3045d99d7714">  552</a></span>&#160;<span class="keywordtype">int</span> <a class="code" href="matom_8c.html#a55d2fd6a10cba375e78a3045d99d7714">temp_choice</a>;                        <span class="comment">//choice of type of calcualation for alpha_sp</span></div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;<span class="comment">/*****************************************************************************/</span></div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;<span class="comment">/**********************************************************/</span></div><div class="line"><a name="l00581"></a><span class="lineno"><a class="line" href="matom_8c.html#a5d003db13b4f257723500c23bee10b90">  581</a></span>&#160;<span class="preprocessor">#define ALPHA_SP_CONSTANT 5.79618e-36</span></div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;<span class="keywordtype">double</span></div><div class="line"><a name="l00584"></a><span class="lineno"><a class="line" href="templates_8h.html#a53e97649d5cd9a1fab024ab99489ddb1">  584</a></span>&#160;<a class="code" href="matom_8c.html#a53e97649d5cd9a1fab024ab99489ddb1">alpha_sp</a> (cont_ptr, <a class="code" href="compton_8c.html#ad65f0d74fe764d3ecae5ec1a89d63f08">xplasma</a>, ichoice)</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;     <span class="keyword">struct </span><a class="code" href="structtopbase__phot.html">topbase_phot</a> *cont_ptr;</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;     <a class="code" href="structplasma.html">PlasmaPtr</a> <a class="code" href="compton_8c.html#ad65f0d74fe764d3ecae5ec1a89d63f08">xplasma</a>;</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;     <span class="keywordtype">int</span> ichoice;</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;{</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;  <span class="keywordtype">double</span> alpha_sp_value;</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;  <span class="keywordtype">double</span> fthresh, flast;</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;  <span class="keywordtype">double</span> <a class="code" href="foo_8h.html#a3521f91b62531265426401a6c32fa93f">qromb</a> ();</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;  <span class="keywordtype">double</span> <a class="code" href="matom_8c.html#aee2caf449c574d065a2cf67664783ace">alpha_sp_integrand</a> ();</div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;</div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;  <a class="code" href="matom_8c.html#a55d2fd6a10cba375e78a3045d99d7714">temp_choice</a> = ichoice;</div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;  <a class="code" href="matom_8c.html#a251b07cd6698a386f4306ff7cfb1a481">temp_ext</a> = xplasma-&gt;<a class="code" href="structplasma.html#a9b217285a754e1533f95d92972b6afd6">t_e</a>;      <span class="comment">//external for use in alph_sp_integrand</span></div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;  cont_ext_ptr = cont_ptr;      <span class="comment">//&quot;</span></div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;  fthresh = cont_ptr-&gt;<a class="code" href="structtopbase__phot.html#a18d8d6eeb8df6e8ad2f89550c6b86310">freq</a>[0];  <span class="comment">//first frequency in list</span></div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;  flast = cont_ptr-&gt;<a class="code" href="structtopbase__phot.html#a18d8d6eeb8df6e8ad2f89550c6b86310">freq</a>[cont_ptr-&gt;<a class="code" href="structtopbase__phot.html#a6be4533b59ab67c16fa1f5d3a31869e8">np</a> - 1];     <span class="comment">//last frequency in list</span></div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;  alpha_sp_value = <a class="code" href="foo_8h.html#a3521f91b62531265426401a6c32fa93f">qromb</a> (alpha_sp_integrand, fthresh, flast, 1e-4);</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;  <span class="comment">/* The lines above evaluate the integral in alpha_sp. Now we just want to multiply </span></div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;<span class="comment">     through by the appropriate constant. */</span></div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;  <span class="keywordflow">if</span> (cont_ptr-&gt;<a class="code" href="structtopbase__phot.html#a0552ae390dbc87aa64fdd05d32227006">macro_info</a> == 1 &amp;&amp; <a class="code" href="python_8h.html#a3a571e0bd4220490c5c5bd86f51c83ba">geo</a>.<a class="code" href="structgeometry.html#ac453ab1a6ed3b90674cd6552c0185bff">macro_simple</a> == 0)</div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;  {</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;    alpha_sp_value = alpha_sp_value * <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[cont_ptr-&gt;<a class="code" href="structtopbase__phot.html#ae51ac7fd7f3c120cf7eb188b207b824f">nlev</a>].<a class="code" href="structconfigurations.html#a568aa359240b411f0774506fb0857f7c">g</a> / <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[cont_ptr-&gt;<a class="code" href="structtopbase__phot.html#aa07be8946fb5a7bb165ee7f3e90aeb7c">uplev</a>].<a class="code" href="structconfigurations.html#a568aa359240b411f0774506fb0857f7c">g</a> * pow (xplasma-&gt;<a class="code" href="structplasma.html#a9b217285a754e1533f95d92972b6afd6">t_e</a>, -1.5);</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;  }</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;  <span class="keywordflow">else</span>                          <span class="comment">//case for simple element</span></div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;  {</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;    alpha_sp_value = alpha_sp_value * <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[cont_ptr-&gt;<a class="code" href="structtopbase__phot.html#ae51ac7fd7f3c120cf7eb188b207b824f">nlev</a>].<a class="code" href="structconfigurations.html#a568aa359240b411f0774506fb0857f7c">g</a> / <a class="code" href="atomic_8h.html#ae721a9114e3cf54f9bcc3dab31072273">ion</a>[cont_ptr-&gt;<a class="code" href="structtopbase__phot.html#a9d54441dd7c9a93f9a937975b77c04cc">nion</a> + 1].<a class="code" href="structions.html#a57bcd07f6852176e85629314a1e8a057">g</a> * pow (xplasma-&gt;<a class="code" href="structplasma.html#a9b217285a754e1533f95d92972b6afd6">t_e</a>, -1.5);  <span class="comment">//g for next ion up used</span></div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;  }</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;  alpha_sp_value = alpha_sp_value * <a class="code" href="matom_8c.html#a5d003db13b4f257723500c23bee10b90">ALPHA_SP_CONSTANT</a>;</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;  <span class="keywordflow">return</span> (alpha_sp_value);</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;}</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;<span class="comment">/**********************************************************/</span></div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;<span class="keywordtype">double</span></div><div class="line"><a name="l00625"></a><span class="lineno"><a class="line" href="templates_8h.html#aee2caf449c574d065a2cf67664783ace">  625</a></span>&#160;<a class="code" href="matom_8c.html#aee2caf449c574d065a2cf67664783ace">alpha_sp_integrand</a> (<a class="code" href="structtopbase__phot.html#a18d8d6eeb8df6e8ad2f89550c6b86310">freq</a>)</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;     <span class="keywordtype">double</span> <a class="code" href="structtopbase__phot.html#a18d8d6eeb8df6e8ad2f89550c6b86310">freq</a>;               <span class="comment">//frequency </span></div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;{</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;  <span class="keywordtype">double</span> fthresh;</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;  <span class="keywordtype">double</span> <a class="code" href="import__cylindrical_8c.html#a099bc7b5a9501685180c163c1ffb67d0">x</a>;</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;  <span class="keywordtype">double</span> integrand;</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;  <span class="keywordtype">double</span> tt;</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;  fthresh = cont_ext_ptr-&gt;<a class="code" href="structtopbase__phot.html#a18d8d6eeb8df6e8ad2f89550c6b86310">freq</a>[0];</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;  tt = <a class="code" href="matom_8c.html#a251b07cd6698a386f4306ff7cfb1a481">temp_ext</a>;</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="structtopbase__phot.html#a18d8d6eeb8df6e8ad2f89550c6b86310">freq</a> &lt; fthresh)</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;    <span class="keywordflow">return</span> (0.0);               <span class="comment">// No recombination at frequencies lower than the threshold freq occur</span></div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;  x = <a class="code" href="atomic_8c.html#a107b53af4265eb649a0e2a483dc613da">sigma_phot</a> (cont_ext_ptr, <a class="code" href="structtopbase__phot.html#a18d8d6eeb8df6e8ad2f89550c6b86310">freq</a>);  <span class="comment">//this is the cross-section</span></div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;  integrand = x * <a class="code" href="structtopbase__phot.html#a18d8d6eeb8df6e8ad2f89550c6b86310">freq</a> * <a class="code" href="structtopbase__phot.html#a18d8d6eeb8df6e8ad2f89550c6b86310">freq</a> * exp (<a class="code" href="atomic_8h.html#a97148aa86d99b11c881e5f32845861d4">H_OVER_K</a> * (fthresh - <a class="code" href="structtopbase__phot.html#a18d8d6eeb8df6e8ad2f89550c6b86310">freq</a>) / tt);</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="matom_8c.html#a55d2fd6a10cba375e78a3045d99d7714">temp_choice</a> == 1)</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;    <span class="keywordflow">return</span> (integrand * <a class="code" href="structtopbase__phot.html#a18d8d6eeb8df6e8ad2f89550c6b86310">freq</a> / fthresh);        <span class="comment">//energy weighed case</span></div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="matom_8c.html#a55d2fd6a10cba375e78a3045d99d7714">temp_choice</a> == 2)</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;    <span class="keywordflow">return</span> (integrand * (<a class="code" href="structtopbase__phot.html#a18d8d6eeb8df6e8ad2f89550c6b86310">freq</a> - fthresh) / fthresh);    <span class="comment">// difference case</span></div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;  <span class="keywordflow">return</span> (integrand);           <span class="comment">//spontanoues case</span></div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;}</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;<span class="comment">/**********************************************************/</span></div><div class="line"><a name="l00684"></a><span class="lineno"><a class="line" href="matom_8c.html#a60902bb874ad5e3684af842ad9a28636">  684</a></span>&#160;<span class="preprocessor">#define ALPHA_FF 100.     // maximum h nu / kT to create the free free CDF </span></div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;<span class="keywordtype">int</span></div><div class="line"><a name="l00687"></a><span class="lineno"><a class="line" href="templates_8h.html#a16ae068adf1746f09c432de7e245dfb1">  687</a></span>&#160;<a class="code" href="matom_8c.html#a16ae068adf1746f09c432de7e245dfb1">kpkt</a> (p, <a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a>, escape)</div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;     <a class="code" href="structphoton.html">PhotPtr</a> p;</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;     <span class="keywordtype">int</span> *<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a>;</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;     <span class="keywordtype">int</span> *escape;</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;{</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>;</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;  <span class="keywordtype">int</span> ulvl;</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;  <span class="keywordtype">double</span> cooling_bf[<a class="code" href="atomic_8h.html#a15a303809550342a407548de2ef7c245">nphot_total</a>];</div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;  <span class="keywordtype">double</span> cooling_bf_col[<a class="code" href="atomic_8h.html#a15a303809550342a407548de2ef7c245">nphot_total</a>];   <span class="comment">//collisional cooling in bf transitions</span></div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;  <span class="keywordtype">double</span> cooling_bb[<a class="code" href="atomic_8h.html#a59990369239024c94cbe22080c9d29c3">NLINES</a>];</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;  <span class="keywordtype">double</span> cooling_adiabatic;</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;  <span class="keyword">struct </span><a class="code" href="structtopbase__phot.html">topbase_phot</a> *cont_ptr;</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;  <span class="keyword">struct </span><a class="code" href="structlines.html">lines</a> *line_ptr;</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;  <span class="keywordtype">double</span> cooling_normalisation;</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;  <span class="keywordtype">double</span> destruction_choice;</div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;  <span class="keywordtype">double</span> electron_temperature;</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;  <span class="keywordtype">double</span> cooling_bbtot, cooling_bftot, cooling_bf_coltot;</div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;  <span class="keywordtype">double</span> lower_density, upper_density;</div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;  <span class="keywordtype">double</span> cooling_ff;</div><div class="line"><a name="l00707"></a><span class="lineno">  707</span>&#160;  <a class="code" href="structwind.html">WindPtr</a> one;</div><div class="line"><a name="l00708"></a><span class="lineno">  708</span>&#160;  <a class="code" href="structplasma.html">PlasmaPtr</a> <a class="code" href="compton_8c.html#ad65f0d74fe764d3ecae5ec1a89d63f08">xplasma</a>;</div><div class="line"><a name="l00709"></a><span class="lineno">  709</span>&#160;  <a class="code" href="structmacro.html">MacroPtr</a> mplasma;</div><div class="line"><a name="l00710"></a><span class="lineno">  710</span>&#160;</div><div class="line"><a name="l00711"></a><span class="lineno">  711</span>&#160;  <span class="keywordtype">double</span> coll_rate, rad_rate;</div><div class="line"><a name="l00712"></a><span class="lineno">  712</span>&#160;  <span class="keywordtype">double</span> freqmin, freqmax;</div><div class="line"><a name="l00713"></a><span class="lineno">  713</span>&#160;</div><div class="line"><a name="l00714"></a><span class="lineno">  714</span>&#160;</div><div class="line"><a name="l00715"></a><span class="lineno">  715</span>&#160;  <span class="comment">/* Idea is to calculated the cooling</span></div><div class="line"><a name="l00716"></a><span class="lineno">  716</span>&#160;<span class="comment">     terms for all the processes and then choose one at random to destroy the k-packet and</span></div><div class="line"><a name="l00717"></a><span class="lineno">  717</span>&#160;<span class="comment">     turn it back into a photon bundle. </span></div><div class="line"><a name="l00718"></a><span class="lineno">  718</span>&#160;<span class="comment">     The routine considers bound-free, collision excitation and ff</span></div><div class="line"><a name="l00719"></a><span class="lineno">  719</span>&#160;<span class="comment">     emission. */</span></div><div class="line"><a name="l00720"></a><span class="lineno">  720</span>&#160;</div><div class="line"><a name="l00721"></a><span class="lineno">  721</span>&#160;  <span class="comment">/* The loop here runs over all the bf processes, regardless of whether they are macro or simple</span></div><div class="line"><a name="l00722"></a><span class="lineno">  722</span>&#160;<span class="comment">     ions. The reason that we can do this is that in the macro atom method stimulated recombination</span></div><div class="line"><a name="l00723"></a><span class="lineno">  723</span>&#160;<span class="comment">     has already been considered before creating the k-packet (by the use of gamma-twiddle) in &quot;scatter&quot;</span></div><div class="line"><a name="l00724"></a><span class="lineno">  724</span>&#160;<span class="comment">     and so we only have spontaneous recombination to worry about here for ALL cases. */</span></div><div class="line"><a name="l00725"></a><span class="lineno">  725</span>&#160;</div><div class="line"><a name="l00726"></a><span class="lineno">  726</span>&#160;</div><div class="line"><a name="l00727"></a><span class="lineno">  727</span>&#160;  one = &amp;<a class="code" href="python_8h.html#a940291848296c285c722ed248863afc1">wmain</a>[p-&gt;<a class="code" href="structphoton.html#a2aa9d1ea7afffe4f370b28b0a21d6c79">grid</a>];</div><div class="line"><a name="l00728"></a><span class="lineno">  728</span>&#160;  xplasma = &amp;<a class="code" href="python_8h.html#af5711847369600743b86dd27343fab7a">plasmamain</a>[one-&gt;<a class="code" href="structwind.html#ae01b6d799a4f0a60142703606c9fea3c">nplasma</a>];</div><div class="line"><a name="l00729"></a><span class="lineno">  729</span>&#160;  <a class="code" href="foo_8h.html#aa751e527d76e3ced7d54e260c6ec8cd3">check_plasma</a> (xplasma, <span class="stringliteral">&quot;kpkt&quot;</span>);</div><div class="line"><a name="l00730"></a><span class="lineno">  730</span>&#160;  mplasma = &amp;<a class="code" href="python_8h.html#a0453c2160b73529f8d858dccfc85aad5">macromain</a>[xplasma-&gt;<a class="code" href="structplasma.html#a8220b5d466addc895b973f092d9b7b15">nplasma</a>];</div><div class="line"><a name="l00731"></a><span class="lineno">  731</span>&#160;</div><div class="line"><a name="l00732"></a><span class="lineno">  732</span>&#160;  electron_temperature = xplasma-&gt;<a class="code" href="structplasma.html#a9b217285a754e1533f95d92972b6afd6">t_e</a>;</div><div class="line"><a name="l00733"></a><span class="lineno">  733</span>&#160;</div><div class="line"><a name="l00734"></a><span class="lineno">  734</span>&#160;  <span class="comment">/* JM 1511 -- Fix for issue 187. We need band limits for free free packet</span></div><div class="line"><a name="l00735"></a><span class="lineno">  735</span>&#160;<span class="comment">     generation (see call to one_ff below) */</span></div><div class="line"><a name="l00736"></a><span class="lineno">  736</span>&#160;  <span class="keywordflow">if</span> (<a class="code" href="python_8h.html#a3a571e0bd4220490c5c5bd86f51c83ba">geo</a>.<a class="code" href="structgeometry.html#a1cdd3c658ff714b9504c7ada69ae1f0d">ioniz_or_extract</a>)</div><div class="line"><a name="l00737"></a><span class="lineno">  737</span>&#160;  {</div><div class="line"><a name="l00738"></a><span class="lineno">  738</span>&#160;    <span class="comment">/* in spectral cycles, so use the boundaries of the photon generation bands */</span></div><div class="line"><a name="l00739"></a><span class="lineno">  739</span>&#160;    freqmin = <a class="code" href="python_8h.html#a4f0e3bc930f46505989f47a576f3ae3b">xband</a>.<a class="code" href="structxbands.html#a4822266ca02ed8a4b214e5efcd79256c">f1</a>[0];</div><div class="line"><a name="l00740"></a><span class="lineno">  740</span>&#160;    <span class="comment">/* JM 1709 -- introduce a maximum frequency based on exp(-h nu / (kT)), </span></div><div class="line"><a name="l00741"></a><span class="lineno">  741</span>&#160;<span class="comment">       see issue #300 */</span></div><div class="line"><a name="l00742"></a><span class="lineno">  742</span>&#160;    freqmax = <a class="code" href="matom_8c.html#a60902bb874ad5e3684af842ad9a28636">ALPHA_FF</a> * xplasma-&gt;<a class="code" href="structplasma.html#a9b217285a754e1533f95d92972b6afd6">t_e</a> / <a class="code" href="atomic_8h.html#a97148aa86d99b11c881e5f32845861d4">H_OVER_K</a>;</div><div class="line"><a name="l00743"></a><span class="lineno">  743</span>&#160;  }</div><div class="line"><a name="l00744"></a><span class="lineno">  744</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l00745"></a><span class="lineno">  745</span>&#160;  {</div><div class="line"><a name="l00746"></a><span class="lineno">  746</span>&#160;    <span class="comment">/* in spectral cycles, use the frequency range of the final spectrum */</span></div><div class="line"><a name="l00747"></a><span class="lineno">  747</span>&#160;    freqmin = <a class="code" href="python_8h.html#a740c6412880dd24768165a351bb9b214">em_rnge</a>.<a class="code" href="structemiss__range.html#ae32bcc0c5aa7a7f15c63cee741f1f2b0">fmin</a>;</div><div class="line"><a name="l00748"></a><span class="lineno">  748</span>&#160;    freqmax = <a class="code" href="python_8h.html#a740c6412880dd24768165a351bb9b214">em_rnge</a>.<a class="code" href="structemiss__range.html#ac6c5df2b3f9dd4eb3bc729feac39ae2d">fmax</a>;</div><div class="line"><a name="l00749"></a><span class="lineno">  749</span>&#160;  }</div><div class="line"><a name="l00750"></a><span class="lineno">  750</span>&#160;</div><div class="line"><a name="l00751"></a><span class="lineno">  751</span>&#160;</div><div class="line"><a name="l00752"></a><span class="lineno">  752</span>&#160;  <span class="comment">/* ksl 091108 - If the kpkt destruction rates for this cell are not known they are calculated here.  This happens</span></div><div class="line"><a name="l00753"></a><span class="lineno">  753</span>&#160;<span class="comment">   * every time the wind is updated */</span></div><div class="line"><a name="l00754"></a><span class="lineno">  754</span>&#160;</div><div class="line"><a name="l00755"></a><span class="lineno">  755</span>&#160;  <span class="keywordflow">if</span> (mplasma-&gt;<a class="code" href="structmacro.html#a22a281cdcc628db94cb49e1596802c2f">kpkt_rates_known</a> != 1)</div><div class="line"><a name="l00756"></a><span class="lineno">  756</span>&#160;  {</div><div class="line"><a name="l00757"></a><span class="lineno">  757</span>&#160;    cooling_normalisation = 0.0;</div><div class="line"><a name="l00758"></a><span class="lineno">  758</span>&#160;    cooling_bftot = 0.0;</div><div class="line"><a name="l00759"></a><span class="lineno">  759</span>&#160;    cooling_bbtot = 0.0;</div><div class="line"><a name="l00760"></a><span class="lineno">  760</span>&#160;    cooling_ff = 0.0;</div><div class="line"><a name="l00761"></a><span class="lineno">  761</span>&#160;    cooling_bf_coltot = 0.0;</div><div class="line"><a name="l00762"></a><span class="lineno">  762</span>&#160;</div><div class="line"><a name="l00763"></a><span class="lineno">  763</span>&#160;    <span class="comment">/* JM 1503 -- we used to loop over ntop_phot here, </span></div><div class="line"><a name="l00764"></a><span class="lineno">  764</span>&#160;<span class="comment">       but we should really loop over the tabulated Verner Xsections too</span></div><div class="line"><a name="l00765"></a><span class="lineno">  765</span>&#160;<span class="comment">       see #86, #141 */</span></div><div class="line"><a name="l00766"></a><span class="lineno">  766</span>&#160;    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="atomic_8h.html#a15a303809550342a407548de2ef7c245">nphot_total</a>; i++)</div><div class="line"><a name="l00767"></a><span class="lineno">  767</span>&#160;    {</div><div class="line"><a name="l00768"></a><span class="lineno">  768</span>&#160;      cont_ptr = &amp;<a class="code" href="atomic_8h.html#aed5961eebbc0ca048e57fe2ad4cdfab8">phot_top</a>[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>];</div><div class="line"><a name="l00769"></a><span class="lineno">  769</span>&#160;      ulvl = cont_ptr-&gt;<a class="code" href="structtopbase__phot.html#aa07be8946fb5a7bb165ee7f3e90aeb7c">uplev</a>;</div><div class="line"><a name="l00770"></a><span class="lineno">  770</span>&#160;</div><div class="line"><a name="l00771"></a><span class="lineno">  771</span>&#160;      <span class="keywordflow">if</span> (cont_ptr-&gt;<a class="code" href="structtopbase__phot.html#a0552ae390dbc87aa64fdd05d32227006">macro_info</a> == 1 &amp;&amp; <a class="code" href="python_8h.html#a3a571e0bd4220490c5c5bd86f51c83ba">geo</a>.<a class="code" href="structgeometry.html#ac453ab1a6ed3b90674cd6552c0185bff">macro_simple</a> == 0)</div><div class="line"><a name="l00772"></a><span class="lineno">  772</span>&#160;      {</div><div class="line"><a name="l00773"></a><span class="lineno">  773</span>&#160;        upper_density = <a class="code" href="foo_8h.html#a7a80c6ec538ad7bf2b546126bac374bf">den_config</a> (xplasma, ulvl);</div><div class="line"><a name="l00774"></a><span class="lineno">  774</span>&#160;        <span class="comment">/* SS July 04 - for macro atoms the recombination coefficients are stored so use the</span></div><div class="line"><a name="l00775"></a><span class="lineno">  775</span>&#160;<span class="comment">           stored values rather than recompue them. */</span></div><div class="line"><a name="l00776"></a><span class="lineno">  776</span>&#160;        cooling_bf[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>] = mplasma-&gt;<a class="code" href="structmacro.html#a28a025132e5524e22892ce363a37988c">cooling_bf</a>[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>] =</div><div class="line"><a name="l00777"></a><span class="lineno">  777</span>&#160;          upper_density * <a class="code" href="atomic_8h.html#abec92cc72a096640b821b8cd56a02495">H</a> * cont_ptr-&gt;<a class="code" href="structtopbase__phot.html#a18d8d6eeb8df6e8ad2f89550c6b86310">freq</a>[0] * (mplasma-&gt;<a class="code" href="structmacro.html#a13217cd83bb2aff404860f1eea75d18e">recomb_sp_e</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[ulvl].<a class="code" href="structconfigurations.html#abc158a8d23c5630e6eedf3a1866af30c">bfd_indx_first</a> + cont_ptr-&gt;<a class="code" href="structtopbase__phot.html#ae229323c0d16d0a56d3cbedd5700190f">down_index</a>]);</div><div class="line"><a name="l00778"></a><span class="lineno">  778</span>&#160;        <span class="comment">// _sp_e is defined as the difference </span></div><div class="line"><a name="l00779"></a><span class="lineno">  779</span>&#160;      }</div><div class="line"><a name="l00780"></a><span class="lineno">  780</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00781"></a><span class="lineno">  781</span>&#160;      {</div><div class="line"><a name="l00782"></a><span class="lineno">  782</span>&#160;        upper_density = xplasma-&gt;<a class="code" href="structplasma.html#a711ac1ddc0f32849edd96d937ff70761">density</a>[cont_ptr-&gt;<a class="code" href="structtopbase__phot.html#a9d54441dd7c9a93f9a937975b77c04cc">nion</a> + 1];</div><div class="line"><a name="l00783"></a><span class="lineno">  783</span>&#160;</div><div class="line"><a name="l00784"></a><span class="lineno">  784</span>&#160;        cooling_bf[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>] = mplasma-&gt;<a class="code" href="structmacro.html#a28a025132e5524e22892ce363a37988c">cooling_bf</a>[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>] = upper_density * <a class="code" href="atomic_8h.html#abec92cc72a096640b821b8cd56a02495">H</a> * cont_ptr-&gt;<a class="code" href="structtopbase__phot.html#a18d8d6eeb8df6e8ad2f89550c6b86310">freq</a>[0] * (xplasma-&gt;<a class="code" href="structplasma.html#ae4b9e1c0afc70066b36d896e8122513b">recomb_simple</a>[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>]);</div><div class="line"><a name="l00785"></a><span class="lineno">  785</span>&#160;      }</div><div class="line"><a name="l00786"></a><span class="lineno">  786</span>&#160;</div><div class="line"><a name="l00787"></a><span class="lineno">  787</span>&#160;</div><div class="line"><a name="l00788"></a><span class="lineno">  788</span>&#160;      <span class="comment">/* Note that the electron density is not included here -- all cooling rates scale</span></div><div class="line"><a name="l00789"></a><span class="lineno">  789</span>&#160;<span class="comment">         with the electron density so I&#39;ve factored it out. */</span></div><div class="line"><a name="l00790"></a><span class="lineno">  790</span>&#160;      <span class="keywordflow">if</span> (cooling_bf[i] &lt; 0)</div><div class="line"><a name="l00791"></a><span class="lineno">  791</span>&#160;      {</div><div class="line"><a name="l00792"></a><span class="lineno">  792</span>&#160;        <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;kpkt: bf cooling rate negative. Density was %g\n&quot;</span>, upper_density);</div><div class="line"><a name="l00793"></a><span class="lineno">  793</span>&#160;        <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;alpha_sp(cont_ptr, xplasma,2) %g \n&quot;</span>, <a class="code" href="matom_8c.html#a53e97649d5cd9a1fab024ab99489ddb1">alpha_sp</a> (cont_ptr, xplasma, 2));</div><div class="line"><a name="l00794"></a><span class="lineno">  794</span>&#160;        <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;i, ulvl, nphot_total, nion %d %d %d %d\n&quot;</span>, i, ulvl, nphot_total, cont_ptr-&gt;<a class="code" href="structtopbase__phot.html#a9d54441dd7c9a93f9a937975b77c04cc">nion</a>);</div><div class="line"><a name="l00795"></a><span class="lineno">  795</span>&#160;        <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;nlev, z, istate %d %d %d \n&quot;</span>, cont_ptr-&gt;<a class="code" href="structtopbase__phot.html#ae51ac7fd7f3c120cf7eb188b207b824f">nlev</a>, cont_ptr-&gt;<a class="code" href="structtopbase__phot.html#a2c145af1ccb60672e5c8c2925961ea2f">z</a>, cont_ptr-&gt;<a class="code" href="structtopbase__phot.html#a6fcc6201c5227485532cd3283bc596c5">istate</a>);</div><div class="line"><a name="l00796"></a><span class="lineno">  796</span>&#160;        <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;freq[0] %g\n&quot;</span>, cont_ptr-&gt;<a class="code" href="structtopbase__phot.html#a18d8d6eeb8df6e8ad2f89550c6b86310">freq</a>[0]);</div><div class="line"><a name="l00797"></a><span class="lineno">  797</span>&#160;        cooling_bf[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>] = mplasma-&gt;<a class="code" href="structmacro.html#a28a025132e5524e22892ce363a37988c">cooling_bf</a>[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>] = 0.0;</div><div class="line"><a name="l00798"></a><span class="lineno">  798</span>&#160;      }</div><div class="line"><a name="l00799"></a><span class="lineno">  799</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00800"></a><span class="lineno">  800</span>&#160;      {</div><div class="line"><a name="l00801"></a><span class="lineno">  801</span>&#160;        cooling_bftot += cooling_bf[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>];</div><div class="line"><a name="l00802"></a><span class="lineno">  802</span>&#160;      }</div><div class="line"><a name="l00803"></a><span class="lineno">  803</span>&#160;</div><div class="line"><a name="l00804"></a><span class="lineno">  804</span>&#160;      cooling_normalisation += cooling_bf[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>];</div><div class="line"><a name="l00805"></a><span class="lineno">  805</span>&#160;</div><div class="line"><a name="l00806"></a><span class="lineno">  806</span>&#160;      <span class="keywordflow">if</span> (cont_ptr-&gt;<a class="code" href="structtopbase__phot.html#a0552ae390dbc87aa64fdd05d32227006">macro_info</a> == 1 &amp;&amp; <a class="code" href="python_8h.html#a3a571e0bd4220490c5c5bd86f51c83ba">geo</a>.<a class="code" href="structgeometry.html#ac453ab1a6ed3b90674cd6552c0185bff">macro_simple</a> == 0)</div><div class="line"><a name="l00807"></a><span class="lineno">  807</span>&#160;      {</div><div class="line"><a name="l00808"></a><span class="lineno">  808</span>&#160;        <span class="comment">/* Include collisional ionization as a cooling term in macro atoms. Don&#39;t include</span></div><div class="line"><a name="l00809"></a><span class="lineno">  809</span>&#160;<span class="comment">           for simple ions for now.  SS */</span></div><div class="line"><a name="l00810"></a><span class="lineno">  810</span>&#160;</div><div class="line"><a name="l00811"></a><span class="lineno">  811</span>&#160;        lower_density = <a class="code" href="foo_8h.html#a7a80c6ec538ad7bf2b546126bac374bf">den_config</a> (xplasma, cont_ptr-&gt;<a class="code" href="structtopbase__phot.html#ae51ac7fd7f3c120cf7eb188b207b824f">nlev</a>);</div><div class="line"><a name="l00812"></a><span class="lineno">  812</span>&#160;        cooling_bf_col[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>] = mplasma-&gt;<a class="code" href="structmacro.html#a949003584c6b25a51657f2eb341abee4">cooling_bf_col</a>[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>] = lower_density * <a class="code" href="atomic_8h.html#abec92cc72a096640b821b8cd56a02495">H</a> * cont_ptr-&gt;<a class="code" href="structtopbase__phot.html#a18d8d6eeb8df6e8ad2f89550c6b86310">freq</a>[0] * <a class="code" href="direct__ion_8c.html#ad33c3a097208fb519a5e779c62e3d1f3">q_ioniz</a> (cont_ptr, electron_temperature);</div><div class="line"><a name="l00813"></a><span class="lineno">  813</span>&#160;</div><div class="line"><a name="l00814"></a><span class="lineno">  814</span>&#160;        cooling_bf_coltot += cooling_bf_col[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>];</div><div class="line"><a name="l00815"></a><span class="lineno">  815</span>&#160;</div><div class="line"><a name="l00816"></a><span class="lineno">  816</span>&#160;        cooling_normalisation += cooling_bf_col[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>];</div><div class="line"><a name="l00817"></a><span class="lineno">  817</span>&#160;</div><div class="line"><a name="l00818"></a><span class="lineno">  818</span>&#160;      }</div><div class="line"><a name="l00819"></a><span class="lineno">  819</span>&#160;</div><div class="line"><a name="l00820"></a><span class="lineno">  820</span>&#160;</div><div class="line"><a name="l00821"></a><span class="lineno">  821</span>&#160;</div><div class="line"><a name="l00822"></a><span class="lineno">  822</span>&#160;    }</div><div class="line"><a name="l00823"></a><span class="lineno">  823</span>&#160;</div><div class="line"><a name="l00824"></a><span class="lineno">  824</span>&#160;    <span class="comment">/* end of loop over nphot_total */</span></div><div class="line"><a name="l00825"></a><span class="lineno">  825</span>&#160;</div><div class="line"><a name="l00826"></a><span class="lineno">  826</span>&#160;    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="atomic_8h.html#af69ee38d2c862dbc6769fa27c5320b96">nlines</a>; i++)</div><div class="line"><a name="l00827"></a><span class="lineno">  827</span>&#160;    {</div><div class="line"><a name="l00828"></a><span class="lineno">  828</span>&#160;      line_ptr = &amp;<a class="code" href="atomic_8h.html#a1df743c9da06da92232eff98af40239a">line</a>[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>];</div><div class="line"><a name="l00829"></a><span class="lineno">  829</span>&#160;      <span class="keywordflow">if</span> (line_ptr-&gt;<a class="code" href="structlines.html#a8bf1b13f22b24fc4fb517bb28dd775b8">macro_info</a> == 1 &amp;&amp; <a class="code" href="python_8h.html#a3a571e0bd4220490c5c5bd86f51c83ba">geo</a>.<a class="code" href="structgeometry.html#ac453ab1a6ed3b90674cd6552c0185bff">macro_simple</a> == 0)</div><div class="line"><a name="l00830"></a><span class="lineno">  830</span>&#160;      {                         <span class="comment">//It&#39;s a macro atom line and so the density of the upper level is stored</span></div><div class="line"><a name="l00831"></a><span class="lineno">  831</span>&#160;        cooling_bb[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>] = mplasma-&gt;<a class="code" href="structmacro.html#a344b8e9e0f658f06e2397bd4880caf58">cooling_bb</a>[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>] =</div><div class="line"><a name="l00832"></a><span class="lineno">  832</span>&#160;          <a class="code" href="foo_8h.html#a7a80c6ec538ad7bf2b546126bac374bf">den_config</a> (xplasma, line_ptr-&gt;<a class="code" href="structlines.html#aa570454ab15c3c7d4324b54a254daf05">nconfigl</a>) * <a class="code" href="foo_8h.html#a277d190575cbdab99ac77d308dc9dfa1">q12</a> (line_ptr, electron_temperature) * line_ptr-&gt;<a class="code" href="structlines.html#a4d74840df54d02617c21c66b2498a81c">freq</a> * <a class="code" href="atomic_8h.html#abec92cc72a096640b821b8cd56a02495">H</a>;</div><div class="line"><a name="l00833"></a><span class="lineno">  833</span>&#160;</div><div class="line"><a name="l00834"></a><span class="lineno">  834</span>&#160;        <span class="comment">/* Note that the electron density is not included here -- all cooling rates scale</span></div><div class="line"><a name="l00835"></a><span class="lineno">  835</span>&#160;<span class="comment">           with the electron density so I&#39;ve factored it out. */</span></div><div class="line"><a name="l00836"></a><span class="lineno">  836</span>&#160;      }</div><div class="line"><a name="l00837"></a><span class="lineno">  837</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00838"></a><span class="lineno">  838</span>&#160;      {                         <span class="comment">//It&#39;s a simple line. Get the upper level density using two_level_atom</span></div><div class="line"><a name="l00839"></a><span class="lineno">  839</span>&#160;</div><div class="line"><a name="l00840"></a><span class="lineno">  840</span>&#160;        <a class="code" href="foo_8h.html#a234e98c30b4b66b1f72240a79d9f4d11">two_level_atom</a> (line_ptr, xplasma, &amp;lower_density, &amp;upper_density);</div><div class="line"><a name="l00841"></a><span class="lineno">  841</span>&#160;</div><div class="line"><a name="l00842"></a><span class="lineno">  842</span>&#160;        <span class="comment">/* the collisional rate is multiplied by ne later */</span></div><div class="line"><a name="l00843"></a><span class="lineno">  843</span>&#160;        coll_rate = <a class="code" href="foo_8h.html#a6daa97078321cf4f668d31b7004fed6c">q21</a> (line_ptr, electron_temperature) * (1. - exp (-<a class="code" href="atomic_8h.html#a97148aa86d99b11c881e5f32845861d4">H_OVER_K</a> * line_ptr-&gt;<a class="code" href="structlines.html#a4d74840df54d02617c21c66b2498a81c">freq</a> / electron_temperature));</div><div class="line"><a name="l00844"></a><span class="lineno">  844</span>&#160;</div><div class="line"><a name="l00845"></a><span class="lineno">  845</span>&#160;        cooling_bb[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>] =</div><div class="line"><a name="l00846"></a><span class="lineno">  846</span>&#160;          (lower_density * line_ptr-&gt;<a class="code" href="structlines.html#a0e2eb51cd04b7d4bbc112e63d1744a9f">gu</a> / line_ptr-&gt;<a class="code" href="structlines.html#a5165d0546a6f5fa57612a4476d2b5ab9">gl</a> -</div><div class="line"><a name="l00847"></a><span class="lineno">  847</span>&#160;           upper_density) * coll_rate / (exp (<a class="code" href="atomic_8h.html#a97148aa86d99b11c881e5f32845861d4">H_OVER_K</a> * line_ptr-&gt;<a class="code" href="structlines.html#a4d74840df54d02617c21c66b2498a81c">freq</a> / electron_temperature) - 1.) * line_ptr-&gt;<a class="code" href="structlines.html#a4d74840df54d02617c21c66b2498a81c">freq</a> * <a class="code" href="atomic_8h.html#abec92cc72a096640b821b8cd56a02495">H</a>;</div><div class="line"><a name="l00848"></a><span class="lineno">  848</span>&#160;</div><div class="line"><a name="l00849"></a><span class="lineno">  849</span>&#160;        rad_rate = <a class="code" href="atomic_8c.html#a8c589bd3089b7851e8da407ad1ce44a5">a21</a> (line_ptr) * <a class="code" href="foo_8h.html#a3579026b8eac7743ef56ad21ff9696ff">p_escape</a> (line_ptr, xplasma);</div><div class="line"><a name="l00850"></a><span class="lineno">  850</span>&#160;</div><div class="line"><a name="l00851"></a><span class="lineno">  851</span>&#160;        <span class="comment">/* Now multiply by the scattering probability - i.e. we are only going to consider bb cooling when</span></div><div class="line"><a name="l00852"></a><span class="lineno">  852</span>&#160;<span class="comment">           the photon actually escapes - we don&#39;t to waste time by exciting a two-level macro atom only so that</span></div><div class="line"><a name="l00853"></a><span class="lineno">  853</span>&#160;<span class="comment">           it makes another k-packet for us! (SS May 04) */</span></div><div class="line"><a name="l00854"></a><span class="lineno">  854</span>&#160;</div><div class="line"><a name="l00855"></a><span class="lineno">  855</span>&#160;</div><div class="line"><a name="l00856"></a><span class="lineno">  856</span>&#160;        cooling_bb[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>] *= rad_rate / (rad_rate + (coll_rate * xplasma-&gt;<a class="code" href="structplasma.html#ac1d38c3e4cc4ef2a1e4d83d7f8b71d22">ne</a>));</div><div class="line"><a name="l00857"></a><span class="lineno">  857</span>&#160;        mplasma-&gt;<a class="code" href="structmacro.html#a344b8e9e0f658f06e2397bd4880caf58">cooling_bb</a>[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>] = cooling_bb[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>];</div><div class="line"><a name="l00858"></a><span class="lineno">  858</span>&#160;      }</div><div class="line"><a name="l00859"></a><span class="lineno">  859</span>&#160;</div><div class="line"><a name="l00860"></a><span class="lineno">  860</span>&#160;      <span class="keywordflow">if</span> (cooling_bb[i] &lt; 0)</div><div class="line"><a name="l00861"></a><span class="lineno">  861</span>&#160;      {</div><div class="line"><a name="l00862"></a><span class="lineno">  862</span>&#160;        cooling_bb[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>] = mplasma-&gt;<a class="code" href="structmacro.html#a344b8e9e0f658f06e2397bd4880caf58">cooling_bb</a>[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>] = 0.0;</div><div class="line"><a name="l00863"></a><span class="lineno">  863</span>&#160;      }</div><div class="line"><a name="l00864"></a><span class="lineno">  864</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00865"></a><span class="lineno">  865</span>&#160;      {</div><div class="line"><a name="l00866"></a><span class="lineno">  866</span>&#160;        cooling_bbtot += cooling_bb[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>];</div><div class="line"><a name="l00867"></a><span class="lineno">  867</span>&#160;      }</div><div class="line"><a name="l00868"></a><span class="lineno">  868</span>&#160;      cooling_normalisation += cooling_bb[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>];</div><div class="line"><a name="l00869"></a><span class="lineno">  869</span>&#160;    }</div><div class="line"><a name="l00870"></a><span class="lineno">  870</span>&#160;</div><div class="line"><a name="l00871"></a><span class="lineno">  871</span>&#160;    <span class="comment">/* end of loop over nlines  */</span></div><div class="line"><a name="l00872"></a><span class="lineno">  872</span>&#160;</div><div class="line"><a name="l00873"></a><span class="lineno">  873</span>&#160;</div><div class="line"><a name="l00874"></a><span class="lineno">  874</span>&#160;    <span class="comment">/* 57+ -- This might be modified later since we &quot;know&quot; that xplasma cannot be for a grid with zero</span></div><div class="line"><a name="l00875"></a><span class="lineno">  875</span>&#160;<span class="comment">       volume.  Recall however that vol is part of the windPtr */</span></div><div class="line"><a name="l00876"></a><span class="lineno">  876</span>&#160;    <span class="keywordflow">if</span> (one-&gt;<a class="code" href="structwind.html#a86864abe3bc4d97d1b4c305f085c6c55">vol</a> &gt; 0)</div><div class="line"><a name="l00877"></a><span class="lineno">  877</span>&#160;    {</div><div class="line"><a name="l00878"></a><span class="lineno">  878</span>&#160;      cooling_ff = mplasma-&gt;<a class="code" href="structmacro.html#a8427be6ddfa589b733a30ab12e26daf0">cooling_ff</a> = <a class="code" href="emission_8c.html#a1f0ea4ec7ad9218a9eb0ca03a4fc6f5d">total_free</a> (one, xplasma-&gt;<a class="code" href="structplasma.html#a9b217285a754e1533f95d92972b6afd6">t_e</a>, 0.0, <a class="code" href="atomic_8h.html#ad8512644399ac6ec00af8f727bb4fac6">VERY_BIG</a>) / xplasma-&gt;<a class="code" href="structplasma.html#a469869b2b7b2a822716ac5a3ba58412a">vol</a> / xplasma-&gt;<a class="code" href="structplasma.html#ac1d38c3e4cc4ef2a1e4d83d7f8b71d22">ne</a>;    <span class="comment">// JM 1411 - changed to use filled volume</span></div><div class="line"><a name="l00879"></a><span class="lineno">  879</span>&#160;    }</div><div class="line"><a name="l00880"></a><span class="lineno">  880</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00881"></a><span class="lineno">  881</span>&#160;    {</div><div class="line"><a name="l00882"></a><span class="lineno">  882</span>&#160;      <span class="comment">/* SS June 04 - This should never happen, but sometimes it does. I think it is because of </span></div><div class="line"><a name="l00883"></a><span class="lineno">  883</span>&#160;<span class="comment">         photons leaking from one cell to another due to the push-through-distance. It is sufficiently</span></div><div class="line"><a name="l00884"></a><span class="lineno">  884</span>&#160;<span class="comment">         rare (~1 photon in a complete run of the code) that I&#39;m not worrying about it for now but it does</span></div><div class="line"><a name="l00885"></a><span class="lineno">  885</span>&#160;<span class="comment">         indicate a real problem somewhere. */</span></div><div class="line"><a name="l00886"></a><span class="lineno">  886</span>&#160;</div><div class="line"><a name="l00887"></a><span class="lineno">  887</span>&#160;      <span class="comment">/* SS Nov 09: actually I&#39;ve not seen this problem for a long</span></div><div class="line"><a name="l00888"></a><span class="lineno">  888</span>&#160;<span class="comment">         time. Don&#39;t recall that we ever actually fixed it,</span></div><div class="line"><a name="l00889"></a><span class="lineno">  889</span>&#160;<span class="comment">         however. Perhaps the improved volume calculations</span></div><div class="line"><a name="l00890"></a><span class="lineno">  890</span>&#160;<span class="comment">         removed it? We delete this whole &quot;else&quot; if we&#39;re sure</span></div><div class="line"><a name="l00891"></a><span class="lineno">  891</span>&#160;<span class="comment">         volumes are never zero. */</span></div><div class="line"><a name="l00892"></a><span class="lineno">  892</span>&#160;</div><div class="line"><a name="l00893"></a><span class="lineno">  893</span>&#160;      cooling_ff = mplasma-&gt;<a class="code" href="structmacro.html#a8427be6ddfa589b733a30ab12e26daf0">cooling_ff</a> = 0.0;</div><div class="line"><a name="l00894"></a><span class="lineno">  894</span>&#160;      <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;kpkt: A scattering event in cell %d with vol = 0???\n&quot;</span>, one-&gt;<a class="code" href="structwind.html#aa879b7be5a0f232f2fde3a95e85824b6">nwind</a>);</div><div class="line"><a name="l00895"></a><span class="lineno">  895</span>&#160;      <span class="comment">//Diagnostic      return(-1);  //57g -- Cannot diagnose with an exit</span></div><div class="line"><a name="l00896"></a><span class="lineno">  896</span>&#160;      exit (0);</div><div class="line"><a name="l00897"></a><span class="lineno">  897</span>&#160;    }</div><div class="line"><a name="l00898"></a><span class="lineno">  898</span>&#160;</div><div class="line"><a name="l00899"></a><span class="lineno">  899</span>&#160;</div><div class="line"><a name="l00900"></a><span class="lineno">  900</span>&#160;    <span class="keywordflow">if</span> (cooling_ff &lt; 0)</div><div class="line"><a name="l00901"></a><span class="lineno">  901</span>&#160;    {</div><div class="line"><a name="l00902"></a><span class="lineno">  902</span>&#160;      <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;kpkt: ff cooling rate negative. Abort.&quot;</span>);</div><div class="line"><a name="l00903"></a><span class="lineno">  903</span>&#160;      exit (0);</div><div class="line"><a name="l00904"></a><span class="lineno">  904</span>&#160;    }</div><div class="line"><a name="l00905"></a><span class="lineno">  905</span>&#160;    <span class="keywordflow">else</span></div><div class="line"><a name="l00906"></a><span class="lineno">  906</span>&#160;    {</div><div class="line"><a name="l00907"></a><span class="lineno">  907</span>&#160;      cooling_normalisation += cooling_ff;</div><div class="line"><a name="l00908"></a><span class="lineno">  908</span>&#160;    }</div><div class="line"><a name="l00909"></a><span class="lineno">  909</span>&#160;</div><div class="line"><a name="l00910"></a><span class="lineno">  910</span>&#160;</div><div class="line"><a name="l00911"></a><span class="lineno">  911</span>&#160;    <span class="comment">/* JM -- 1310 -- we now want to add adiabatic cooling as another way of destroying kpkts</span></div><div class="line"><a name="l00912"></a><span class="lineno">  912</span>&#160;<span class="comment">       this should have already been calculated and stored in the plasma structure. Note that </span></div><div class="line"><a name="l00913"></a><span class="lineno">  913</span>&#160;<span class="comment">       adiabatic cooling does not depend on type of macro atom excited */</span></div><div class="line"><a name="l00914"></a><span class="lineno">  914</span>&#160;</div><div class="line"><a name="l00915"></a><span class="lineno">  915</span>&#160;    <span class="comment">/* note the units here- we divide the total luminosity of the cell by volume and ne to give cooling rate */</span></div><div class="line"><a name="l00916"></a><span class="lineno">  916</span>&#160;</div><div class="line"><a name="l00917"></a><span class="lineno">  917</span>&#160;    cooling_adiabatic = xplasma-&gt;<a class="code" href="structplasma.html#acf37090e0b83fe81d058f21229a90018">cool_adiabatic</a> / xplasma-&gt;<a class="code" href="structplasma.html#a469869b2b7b2a822716ac5a3ba58412a">vol</a> / xplasma-&gt;<a class="code" href="structplasma.html#ac1d38c3e4cc4ef2a1e4d83d7f8b71d22">ne</a>;    <span class="comment">// JM 1411 - changed to use filled volume</span></div><div class="line"><a name="l00918"></a><span class="lineno">  918</span>&#160;</div><div class="line"><a name="l00919"></a><span class="lineno">  919</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="python_8h.html#a3a571e0bd4220490c5c5bd86f51c83ba">geo</a>.<a class="code" href="structgeometry.html#a4f5794e0b4b6ed3e93a1cbd284132a17">adiabatic</a> == 0 &amp;&amp; cooling_adiabatic &gt; 0.0)</div><div class="line"><a name="l00920"></a><span class="lineno">  920</span>&#160;    {</div><div class="line"><a name="l00921"></a><span class="lineno">  921</span>&#160;      <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;Adiabatic cooling turned off, but non zero in cell %d&quot;</span>, xplasma-&gt;<a class="code" href="structplasma.html#a8220b5d466addc895b973f092d9b7b15">nplasma</a>);</div><div class="line"><a name="l00922"></a><span class="lineno">  922</span>&#160;    }</div><div class="line"><a name="l00923"></a><span class="lineno">  923</span>&#160;</div><div class="line"><a name="l00924"></a><span class="lineno">  924</span>&#160;</div><div class="line"><a name="l00925"></a><span class="lineno">  925</span>&#160;    <span class="comment">/* JM 1302 -- Negative adiabatic coooling- this used to happen due to issue #70, where we incorrectly calculated dvdy, </span></div><div class="line"><a name="l00926"></a><span class="lineno">  926</span>&#160;<span class="comment">       but this is now resolved. Now it should only happen for cellspartly in wind, because we don&#39;t treat these very well.</span></div><div class="line"><a name="l00927"></a><span class="lineno">  927</span>&#160;<span class="comment">       Now, if cooling_adiabatic &lt; 0 then set it to zero to avoid runs exiting for part in wind cells. */</span></div><div class="line"><a name="l00928"></a><span class="lineno">  928</span>&#160;    <span class="keywordflow">if</span> (cooling_adiabatic &lt; 0)</div><div class="line"><a name="l00929"></a><span class="lineno">  929</span>&#160;    {</div><div class="line"><a name="l00930"></a><span class="lineno">  930</span>&#160;      <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;kpkt: Adiabatic cooling negative! Major problem if inwind (%d) == 0\n&quot;</span>, one-&gt;<a class="code" href="structwind.html#a7f4f2ec3bc9cea1d4dec351b026b9a73">inwind</a>);</div><div class="line"><a name="l00931"></a><span class="lineno">  931</span>&#160;      <a class="code" href="log_8h.html#a9a25be4f0d7d13fccc8457774d74167f">Log</a> (<span class="stringliteral">&quot;kpkt: Setting adiabatic kpkt destruction probability to zero for this matom.\n&quot;</span>);</div><div class="line"><a name="l00932"></a><span class="lineno">  932</span>&#160;      cooling_adiabatic = 0.0;</div><div class="line"><a name="l00933"></a><span class="lineno">  933</span>&#160;    }</div><div class="line"><a name="l00934"></a><span class="lineno">  934</span>&#160;</div><div class="line"><a name="l00935"></a><span class="lineno">  935</span>&#160;</div><div class="line"><a name="l00936"></a><span class="lineno">  936</span>&#160;    cooling_normalisation += cooling_adiabatic;</div><div class="line"><a name="l00937"></a><span class="lineno">  937</span>&#160;</div><div class="line"><a name="l00938"></a><span class="lineno">  938</span>&#160;</div><div class="line"><a name="l00939"></a><span class="lineno">  939</span>&#160;</div><div class="line"><a name="l00940"></a><span class="lineno">  940</span>&#160;    mplasma-&gt;<a class="code" href="structmacro.html#a85eac8200ef941e212d8c6b8d0bbf8cf">cooling_bbtot</a> = cooling_bbtot;</div><div class="line"><a name="l00941"></a><span class="lineno">  941</span>&#160;    mplasma-&gt;<a class="code" href="structmacro.html#ab0671cf0f286d0fc484da2b0894df5bf">cooling_bftot</a> = cooling_bftot;</div><div class="line"><a name="l00942"></a><span class="lineno">  942</span>&#160;    mplasma-&gt;<a class="code" href="structmacro.html#a6980807d807f7e9e1a49c195e09ce70a">cooling_bf_coltot</a> = cooling_bf_coltot;</div><div class="line"><a name="l00943"></a><span class="lineno">  943</span>&#160;    mplasma-&gt;<a class="code" href="structmacro.html#a8e77cd87d57475d0c53aab45ad0e78cf">cooling_adiabatic</a> = cooling_adiabatic;</div><div class="line"><a name="l00944"></a><span class="lineno">  944</span>&#160;    mplasma-&gt;<a class="code" href="structmacro.html#aa7af4ae4af78ef3c646d7e776275b584">cooling_normalisation</a> = cooling_normalisation;</div><div class="line"><a name="l00945"></a><span class="lineno">  945</span>&#160;    mplasma-&gt;<a class="code" href="structmacro.html#a22a281cdcc628db94cb49e1596802c2f">kpkt_rates_known</a> = 1;</div><div class="line"><a name="l00946"></a><span class="lineno">  946</span>&#160;</div><div class="line"><a name="l00947"></a><span class="lineno">  947</span>&#160;  }</div><div class="line"><a name="l00948"></a><span class="lineno">  948</span>&#160;</div><div class="line"><a name="l00949"></a><span class="lineno">  949</span>&#160;</div><div class="line"><a name="l00950"></a><span class="lineno">  950</span>&#160;</div><div class="line"><a name="l00951"></a><span class="lineno">  951</span>&#160;</div><div class="line"><a name="l00952"></a><span class="lineno">  952</span>&#160;</div><div class="line"><a name="l00953"></a><span class="lineno">  953</span>&#160;  <span class="comment">/* The cooling rates for the recombination and collisional processes are now known. </span></div><div class="line"><a name="l00954"></a><span class="lineno">  954</span>&#160;<span class="comment">     Choose which process destroys the k-packet with a random number. */</span></div><div class="line"><a name="l00955"></a><span class="lineno">  955</span>&#160;</div><div class="line"><a name="l00956"></a><span class="lineno">  956</span>&#160;<span class="comment">//  destruction_choice = ((rand () + 0.5) / MAXRAND) * mplasma-&gt;cooling_normalisation; //DONE</span></div><div class="line"><a name="l00957"></a><span class="lineno">  957</span>&#160;  destruction_choice = <a class="code" href="foo_8h.html#a451b4740f3d1e12cb07885b0d3e5ef1b">random_number</a>(0.0,1.0) * mplasma-&gt;<a class="code" href="structmacro.html#aa7af4ae4af78ef3c646d7e776275b584">cooling_normalisation</a>;</div><div class="line"><a name="l00958"></a><span class="lineno">  958</span>&#160;</div><div class="line"><a name="l00959"></a><span class="lineno">  959</span>&#160;  <span class="keywordflow">if</span> (destruction_choice &lt; mplasma-&gt;cooling_bftot)</div><div class="line"><a name="l00960"></a><span class="lineno">  960</span>&#160;  {                             <span class="comment">//destruction by bf</span></div><div class="line"><a name="l00961"></a><span class="lineno">  961</span>&#160;</div><div class="line"><a name="l00962"></a><span class="lineno">  962</span>&#160;    <span class="comment">/* JM 1503 -- we used to loop over ntop_phot here, </span></div><div class="line"><a name="l00963"></a><span class="lineno">  963</span>&#160;<span class="comment">       but we should really loop over the tabulated Verner Xsections too</span></div><div class="line"><a name="l00964"></a><span class="lineno">  964</span>&#160;<span class="comment">       see #86, #141 */</span></div><div class="line"><a name="l00965"></a><span class="lineno">  965</span>&#160;    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="atomic_8h.html#a15a303809550342a407548de2ef7c245">nphot_total</a>; i++)</div><div class="line"><a name="l00966"></a><span class="lineno">  966</span>&#160;    {</div><div class="line"><a name="l00967"></a><span class="lineno">  967</span>&#160;      <span class="keywordflow">if</span> (destruction_choice &lt; mplasma-&gt;cooling_bf[i])</div><div class="line"><a name="l00968"></a><span class="lineno">  968</span>&#160;      {</div><div class="line"><a name="l00969"></a><span class="lineno">  969</span>&#160;        <span class="comment">/* Having got here we know that desturction of the k-packet was via the process labelled</span></div><div class="line"><a name="l00970"></a><span class="lineno">  970</span>&#160;<span class="comment">           by i. Let&#39;s just check that i is a sensible number. */</span></div><div class="line"><a name="l00971"></a><span class="lineno">  971</span>&#160;</div><div class="line"><a name="l00972"></a><span class="lineno">  972</span>&#160;        <span class="keywordflow">if</span> (i &gt; nphot_total - 1)</div><div class="line"><a name="l00973"></a><span class="lineno">  973</span>&#160;        {</div><div class="line"><a name="l00974"></a><span class="lineno">  974</span>&#160;          <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;kpkt (matom.c): trying to destroy k-packet in unknown process. Abort.\n&quot;</span>);</div><div class="line"><a name="l00975"></a><span class="lineno">  975</span>&#160;          exit (0);</div><div class="line"><a name="l00976"></a><span class="lineno">  976</span>&#160;        }</div><div class="line"><a name="l00977"></a><span class="lineno">  977</span>&#160;</div><div class="line"><a name="l00978"></a><span class="lineno">  978</span>&#160;        <span class="comment">/* If it gets here, all seems fine. Now set nres for the destruction process. */</span></div><div class="line"><a name="l00979"></a><span class="lineno">  979</span>&#160;</div><div class="line"><a name="l00980"></a><span class="lineno">  980</span>&#160;        *<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a> = i + <a class="code" href="atomic_8h.html#a59990369239024c94cbe22080c9d29c3">NLINES</a> + 1;</div><div class="line"><a name="l00981"></a><span class="lineno">  981</span>&#160;        *escape = 1;            <span class="comment">//record that an r-packet is made - no need to excite a macro atom again</span></div><div class="line"><a name="l00982"></a><span class="lineno">  982</span>&#160;</div><div class="line"><a name="l00983"></a><span class="lineno">  983</span>&#160;</div><div class="line"><a name="l00984"></a><span class="lineno">  984</span>&#160;        <span class="comment">/* Now (as in matom) choose a frequency for the new packet. */</span></div><div class="line"><a name="l00985"></a><span class="lineno">  985</span>&#160;</div><div class="line"><a name="l00986"></a><span class="lineno">  986</span>&#160;<span class="comment">//        p-&gt;freq = phot_top[i].freq[0] - (log (1. - (rand () + 0.5) / MAXRAND) * xplasma-&gt;t_e / H_OVER_K); //DONE</span></div><div class="line"><a name="l00987"></a><span class="lineno">  987</span>&#160;        p-&gt;<a class="code" href="structphoton.html#a98c6d400814a43aeda7d7fd1ed2d7dc6">freq</a> = <a class="code" href="atomic_8h.html#aed5961eebbc0ca048e57fe2ad4cdfab8">phot_top</a>[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>].<a class="code" href="structtopbase__phot.html#a18d8d6eeb8df6e8ad2f89550c6b86310">freq</a>[0] - (log (1. - <a class="code" href="foo_8h.html#a451b4740f3d1e12cb07885b0d3e5ef1b">random_number</a>(0.0,1.0)) * xplasma-&gt;<a class="code" href="structplasma.html#a9b217285a754e1533f95d92972b6afd6">t_e</a> / <a class="code" href="atomic_8h.html#a97148aa86d99b11c881e5f32845861d4">H_OVER_K</a>);</div><div class="line"><a name="l00988"></a><span class="lineno">  988</span>&#160;        </div><div class="line"><a name="l00989"></a><span class="lineno">  989</span>&#160;        <span class="comment">/* Co-moving frequency - changed to rest frequency by doppler */</span></div><div class="line"><a name="l00990"></a><span class="lineno">  990</span>&#160;        <span class="comment">/*Currently this assumed hydrogenic shape cross-section - Improve */</span></div><div class="line"><a name="l00991"></a><span class="lineno">  991</span>&#160;</div><div class="line"><a name="l00992"></a><span class="lineno">  992</span>&#160;        <span class="comment">/* k-packet is now eliminated. All done. */</span></div><div class="line"><a name="l00993"></a><span class="lineno">  993</span>&#160;        <span class="keywordflow">return</span> (0);</div><div class="line"><a name="l00994"></a><span class="lineno">  994</span>&#160;      }</div><div class="line"><a name="l00995"></a><span class="lineno">  995</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l00996"></a><span class="lineno">  996</span>&#160;      {</div><div class="line"><a name="l00997"></a><span class="lineno">  997</span>&#160;        destruction_choice = destruction_choice - mplasma-&gt;<a class="code" href="structmacro.html#a28a025132e5524e22892ce363a37988c">cooling_bf</a>[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>];</div><div class="line"><a name="l00998"></a><span class="lineno">  998</span>&#160;      }</div><div class="line"><a name="l00999"></a><span class="lineno">  999</span>&#160;    }</div><div class="line"><a name="l01000"></a><span class="lineno"> 1000</span>&#160;  }</div><div class="line"><a name="l01001"></a><span class="lineno"> 1001</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (destruction_choice &lt; (mplasma-&gt;<a class="code" href="structmacro.html#ab0671cf0f286d0fc484da2b0894df5bf">cooling_bftot</a> + mplasma-&gt;<a class="code" href="structmacro.html#a85eac8200ef941e212d8c6b8d0bbf8cf">cooling_bbtot</a>))</div><div class="line"><a name="l01002"></a><span class="lineno"> 1002</span>&#160;  {                             <span class="comment">//this means that a collisional destruction has occurred - this results in </span></div><div class="line"><a name="l01003"></a><span class="lineno"> 1003</span>&#160;    <span class="comment">//a macro atom being excited. Choose which macro atom and level to excite</span></div><div class="line"><a name="l01004"></a><span class="lineno"> 1004</span>&#160;    destruction_choice = destruction_choice - mplasma-&gt;<a class="code" href="structmacro.html#ab0671cf0f286d0fc484da2b0894df5bf">cooling_bftot</a>;</div><div class="line"><a name="l01005"></a><span class="lineno"> 1005</span>&#160;    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="atomic_8h.html#af69ee38d2c862dbc6769fa27c5320b96">nlines</a>; i++)</div><div class="line"><a name="l01006"></a><span class="lineno"> 1006</span>&#160;    {</div><div class="line"><a name="l01007"></a><span class="lineno"> 1007</span>&#160;      <span class="keywordflow">if</span> (destruction_choice &lt; mplasma-&gt;cooling_bb[i])</div><div class="line"><a name="l01008"></a><span class="lineno"> 1008</span>&#160;      {                         <span class="comment">//This is the bb collision which removes the k-packet</span></div><div class="line"><a name="l01009"></a><span class="lineno"> 1009</span>&#160;        *<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a> = <a class="code" href="atomic_8h.html#a1df743c9da06da92232eff98af40239a">line</a>[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>].<a class="code" href="structlines.html#a21eb2458dc558a817e715ca184cf8bb5">where_in_list</a>;  <span class="comment">//label for bb process </span></div><div class="line"><a name="l01010"></a><span class="lineno"> 1010</span>&#160;        <span class="keywordflow">if</span> (<a class="code" href="atomic_8h.html#a1df743c9da06da92232eff98af40239a">line</a>[i].<a class="code" href="structlines.html#a8bf1b13f22b24fc4fb517bb28dd775b8">macro_info</a> == 1 &amp;&amp; <a class="code" href="python_8h.html#a3a571e0bd4220490c5c5bd86f51c83ba">geo</a>.<a class="code" href="structgeometry.html#ac453ab1a6ed3b90674cd6552c0185bff">macro_simple</a> == 0)   <span class="comment">//line is for a macro atom</span></div><div class="line"><a name="l01011"></a><span class="lineno"> 1011</span>&#160;        {</div><div class="line"><a name="l01012"></a><span class="lineno"> 1012</span>&#160;</div><div class="line"><a name="l01013"></a><span class="lineno"> 1013</span>&#160;          <span class="comment">/* escape = 0 flag returned to tell macro_gov that</span></div><div class="line"><a name="l01014"></a><span class="lineno"> 1014</span>&#160;<span class="comment">             a macro atom should be excited, rather than making a call to matom here. */</span></div><div class="line"><a name="l01015"></a><span class="lineno"> 1015</span>&#160;</div><div class="line"><a name="l01016"></a><span class="lineno"> 1016</span>&#160;          *escape = 0;</div><div class="line"><a name="l01017"></a><span class="lineno"> 1017</span>&#160;</div><div class="line"><a name="l01018"></a><span class="lineno"> 1018</span>&#160;        }</div><div class="line"><a name="l01019"></a><span class="lineno"> 1019</span>&#160;        <span class="keywordflow">else</span>                    <span class="comment">//line is not for a macro atom - use simple method</span></div><div class="line"><a name="l01020"></a><span class="lineno"> 1020</span>&#160;        {</div><div class="line"><a name="l01021"></a><span class="lineno"> 1021</span>&#160;          <span class="comment">/* Since the cooling rate accounts for the scattering fraction we know that if we</span></div><div class="line"><a name="l01022"></a><span class="lineno"> 1022</span>&#160;<span class="comment">             get here we want a line emission, not just an excited macro atom. (SS May 04) */</span></div><div class="line"><a name="l01023"></a><span class="lineno"> 1023</span>&#160;          *escape = 1;          <span class="comment">//No need for re-exciting a macro atom.</span></div><div class="line"><a name="l01024"></a><span class="lineno"> 1024</span>&#160;          p-&gt;<a class="code" href="structphoton.html#a98c6d400814a43aeda7d7fd1ed2d7dc6">freq</a> = <a class="code" href="atomic_8h.html#a1df743c9da06da92232eff98af40239a">line</a>[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>].<a class="code" href="structlines.html#a4d74840df54d02617c21c66b2498a81c">freq</a>;</div><div class="line"><a name="l01025"></a><span class="lineno"> 1025</span>&#160;        }</div><div class="line"><a name="l01026"></a><span class="lineno"> 1026</span>&#160;        <span class="comment">/* When it gets here the packet is back to an</span></div><div class="line"><a name="l01027"></a><span class="lineno"> 1027</span>&#160;<span class="comment">           r-packet and the emission mechanism is identified by nres</span></div><div class="line"><a name="l01028"></a><span class="lineno"> 1028</span>&#160;<span class="comment">           i.e. that&#39;s it finished. (SS, Apr 04). */</span></div><div class="line"><a name="l01029"></a><span class="lineno"> 1029</span>&#160;        <span class="keywordflow">return</span> (0);</div><div class="line"><a name="l01030"></a><span class="lineno"> 1030</span>&#160;      }</div><div class="line"><a name="l01031"></a><span class="lineno"> 1031</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01032"></a><span class="lineno"> 1032</span>&#160;      {</div><div class="line"><a name="l01033"></a><span class="lineno"> 1033</span>&#160;        destruction_choice = destruction_choice - mplasma-&gt;<a class="code" href="structmacro.html#a344b8e9e0f658f06e2397bd4880caf58">cooling_bb</a>[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>];</div><div class="line"><a name="l01034"></a><span class="lineno"> 1034</span>&#160;      }</div><div class="line"><a name="l01035"></a><span class="lineno"> 1035</span>&#160;    }</div><div class="line"><a name="l01036"></a><span class="lineno"> 1036</span>&#160;  }</div><div class="line"><a name="l01037"></a><span class="lineno"> 1037</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (destruction_choice &lt; (mplasma-&gt;<a class="code" href="structmacro.html#ab0671cf0f286d0fc484da2b0894df5bf">cooling_bftot</a> + mplasma-&gt;<a class="code" href="structmacro.html#a85eac8200ef941e212d8c6b8d0bbf8cf">cooling_bbtot</a> + mplasma-&gt;<a class="code" href="structmacro.html#a8427be6ddfa589b733a30ab12e26daf0">cooling_ff</a>))</div><div class="line"><a name="l01038"></a><span class="lineno"> 1038</span>&#160;  {                             <span class="comment">//this is a ff destruction</span></div><div class="line"><a name="l01039"></a><span class="lineno"> 1039</span>&#160;</div><div class="line"><a name="l01040"></a><span class="lineno"> 1040</span>&#160;    <span class="comment">/* The limits for ff emission are hard-wired: 40 microns -&gt;</span></div><div class="line"><a name="l01041"></a><span class="lineno"> 1041</span>&#160;<span class="comment">       twice energy of He II edge. Shouldn&#39;t be a problem unless</span></div><div class="line"><a name="l01042"></a><span class="lineno"> 1042</span>&#160;<span class="comment">       we&#39;re in plasma with temperatures that gives significant ff</span></div><div class="line"><a name="l01043"></a><span class="lineno"> 1043</span>&#160;<span class="comment">       emission outside this range. */</span></div><div class="line"><a name="l01044"></a><span class="lineno"> 1044</span>&#160;</div><div class="line"><a name="l01045"></a><span class="lineno"> 1045</span>&#160;    *escape = 1;                <span class="comment">//we are making an r-packet not exciting a macro atom</span></div><div class="line"><a name="l01046"></a><span class="lineno"> 1046</span>&#160;</div><div class="line"><a name="l01047"></a><span class="lineno"> 1047</span>&#160;    *<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a> = -2;</div><div class="line"><a name="l01048"></a><span class="lineno"> 1048</span>&#160;</div><div class="line"><a name="l01049"></a><span class="lineno"> 1049</span>&#160;    <span class="comment">/* used to do one_ff (one, 7.5e12, 2.626e16) here,</span></div><div class="line"><a name="l01050"></a><span class="lineno"> 1050</span>&#160;<span class="comment">       but now use the band boundaries, see #187. */</span></div><div class="line"><a name="l01051"></a><span class="lineno"> 1051</span>&#160;    p-&gt;<a class="code" href="structphoton.html#a98c6d400814a43aeda7d7fd1ed2d7dc6">freq</a> = <a class="code" href="emission_8c.html#af59091ae76131213b5c23a085d88eb1d">one_ff</a> (one, freqmin, freqmax);   <span class="comment">//get frequency of resulting energy packet</span></div><div class="line"><a name="l01052"></a><span class="lineno"> 1052</span>&#160;</div><div class="line"><a name="l01053"></a><span class="lineno"> 1053</span>&#160;    <span class="keywordflow">return</span> (0);</div><div class="line"><a name="l01054"></a><span class="lineno"> 1054</span>&#160;  }</div><div class="line"><a name="l01055"></a><span class="lineno"> 1055</span>&#160;</div><div class="line"><a name="l01056"></a><span class="lineno"> 1056</span>&#160;</div><div class="line"><a name="l01057"></a><span class="lineno"> 1057</span>&#160;  <span class="comment">/* JM 1310 -- added loop to check if destruction occurs via adiabatic cooling */</span></div><div class="line"><a name="l01058"></a><span class="lineno"> 1058</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (destruction_choice &lt; (mplasma-&gt;<a class="code" href="structmacro.html#ab0671cf0f286d0fc484da2b0894df5bf">cooling_bftot</a> + mplasma-&gt;<a class="code" href="structmacro.html#a85eac8200ef941e212d8c6b8d0bbf8cf">cooling_bbtot</a> + mplasma-&gt;<a class="code" href="structmacro.html#a8427be6ddfa589b733a30ab12e26daf0">cooling_ff</a> + mplasma-&gt;<a class="code" href="structmacro.html#a8e77cd87d57475d0c53aab45ad0e78cf">cooling_adiabatic</a>))</div><div class="line"><a name="l01059"></a><span class="lineno"> 1059</span>&#160;  {</div><div class="line"><a name="l01060"></a><span class="lineno"> 1060</span>&#160;</div><div class="line"><a name="l01061"></a><span class="lineno"> 1061</span>&#160;    <span class="keywordflow">if</span> (<a class="code" href="python_8h.html#a3a571e0bd4220490c5c5bd86f51c83ba">geo</a>.<a class="code" href="structgeometry.html#a4f5794e0b4b6ed3e93a1cbd284132a17">adiabatic</a> == 0)</div><div class="line"><a name="l01062"></a><span class="lineno"> 1062</span>&#160;    {</div><div class="line"><a name="l01063"></a><span class="lineno"> 1063</span>&#160;      <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;Destroying kpkt by adiabatic cooling even though it is turned off.&quot;</span>);</div><div class="line"><a name="l01064"></a><span class="lineno"> 1064</span>&#160;    }</div><div class="line"><a name="l01065"></a><span class="lineno"> 1065</span>&#160;    *escape = 1;                <span class="comment">// we want to escape but set photon weight to zero</span></div><div class="line"><a name="l01066"></a><span class="lineno"> 1066</span>&#160;    *<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a> = -2;</div><div class="line"><a name="l01067"></a><span class="lineno"> 1067</span>&#160;    <span class="comment">//p-&gt;w = 0.0;             // JM131030 set photon weight to zero as energy is taken up in adiabatic expansion</span></div><div class="line"><a name="l01068"></a><span class="lineno"> 1068</span>&#160;</div><div class="line"><a name="l01069"></a><span class="lineno"> 1069</span>&#160;    p-&gt;<a class="code" href="structphoton.html#adf0be64e948d68d787555681d15e13e2">istat</a> = P_ADIABATIC;     <span class="comment">// record that this photon went into a kpkt destruction from adiabatic cooling</span></div><div class="line"><a name="l01070"></a><span class="lineno"> 1070</span>&#160;</div><div class="line"><a name="l01071"></a><span class="lineno"> 1071</span>&#160;    <span class="keywordflow">return</span> (0);</div><div class="line"><a name="l01072"></a><span class="lineno"> 1072</span>&#160;  }</div><div class="line"><a name="l01073"></a><span class="lineno"> 1073</span>&#160;</div><div class="line"><a name="l01074"></a><span class="lineno"> 1074</span>&#160;</div><div class="line"><a name="l01075"></a><span class="lineno"> 1075</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l01076"></a><span class="lineno"> 1076</span>&#160;  {</div><div class="line"><a name="l01077"></a><span class="lineno"> 1077</span>&#160;    <span class="comment">/* We want destruction by collisional ionization in a macro atom. */</span></div><div class="line"><a name="l01078"></a><span class="lineno"> 1078</span>&#160;    destruction_choice =</div><div class="line"><a name="l01079"></a><span class="lineno"> 1079</span>&#160;      destruction_choice - mplasma-&gt;<a class="code" href="structmacro.html#ab0671cf0f286d0fc484da2b0894df5bf">cooling_bftot</a> - mplasma-&gt;<a class="code" href="structmacro.html#a85eac8200ef941e212d8c6b8d0bbf8cf">cooling_bbtot</a> - mplasma-&gt;<a class="code" href="structmacro.html#a8427be6ddfa589b733a30ab12e26daf0">cooling_ff</a> - mplasma-&gt;<a class="code" href="structmacro.html#a8e77cd87d57475d0c53aab45ad0e78cf">cooling_adiabatic</a>;</div><div class="line"><a name="l01080"></a><span class="lineno"> 1080</span>&#160;</div><div class="line"><a name="l01081"></a><span class="lineno"> 1081</span>&#160;    <span class="keywordflow">for</span> (i = 0; i &lt; <a class="code" href="atomic_8h.html#a15a303809550342a407548de2ef7c245">nphot_total</a>; i++)</div><div class="line"><a name="l01082"></a><span class="lineno"> 1082</span>&#160;    {</div><div class="line"><a name="l01083"></a><span class="lineno"> 1083</span>&#160;      <span class="keywordflow">if</span> (destruction_choice &lt; mplasma-&gt;cooling_bf_col[i])</div><div class="line"><a name="l01084"></a><span class="lineno"> 1084</span>&#160;      {</div><div class="line"><a name="l01085"></a><span class="lineno"> 1085</span>&#160;        <span class="comment">/* Having got here we know that destruction of the k-packet was via the process labelled</span></div><div class="line"><a name="l01086"></a><span class="lineno"> 1086</span>&#160;<span class="comment">           by i. Let&#39;s just check that i is a sensible number. */</span></div><div class="line"><a name="l01087"></a><span class="lineno"> 1087</span>&#160;</div><div class="line"><a name="l01088"></a><span class="lineno"> 1088</span>&#160;        <span class="keywordflow">if</span> (i &gt; nphot_total - 1)</div><div class="line"><a name="l01089"></a><span class="lineno"> 1089</span>&#160;        {</div><div class="line"><a name="l01090"></a><span class="lineno"> 1090</span>&#160;          <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;kpkt (matom.c): trying to destroy k-packet in unknown process. Abort.\n&quot;</span>);</div><div class="line"><a name="l01091"></a><span class="lineno"> 1091</span>&#160;          exit (0);</div><div class="line"><a name="l01092"></a><span class="lineno"> 1092</span>&#160;        }</div><div class="line"><a name="l01093"></a><span class="lineno"> 1093</span>&#160;</div><div class="line"><a name="l01094"></a><span class="lineno"> 1094</span>&#160;        <span class="comment">/* Now set nres for the destruction process. */</span></div><div class="line"><a name="l01095"></a><span class="lineno"> 1095</span>&#160;</div><div class="line"><a name="l01096"></a><span class="lineno"> 1096</span>&#160;        *<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a> = i + <a class="code" href="atomic_8h.html#a59990369239024c94cbe22080c9d29c3">NLINES</a> + 1;</div><div class="line"><a name="l01097"></a><span class="lineno"> 1097</span>&#160;        *escape = 0;            <span class="comment">//collisional ionization makes an excited macro atom</span></div><div class="line"><a name="l01098"></a><span class="lineno"> 1098</span>&#160;</div><div class="line"><a name="l01099"></a><span class="lineno"> 1099</span>&#160;</div><div class="line"><a name="l01100"></a><span class="lineno"> 1100</span>&#160;        <span class="comment">/* k-packet is now eliminated. All done. */</span></div><div class="line"><a name="l01101"></a><span class="lineno"> 1101</span>&#160;        <span class="keywordflow">return</span> (0);</div><div class="line"><a name="l01102"></a><span class="lineno"> 1102</span>&#160;      }</div><div class="line"><a name="l01103"></a><span class="lineno"> 1103</span>&#160;      <span class="keywordflow">else</span></div><div class="line"><a name="l01104"></a><span class="lineno"> 1104</span>&#160;      {</div><div class="line"><a name="l01105"></a><span class="lineno"> 1105</span>&#160;        destruction_choice = destruction_choice - mplasma-&gt;<a class="code" href="structmacro.html#a949003584c6b25a51657f2eb341abee4">cooling_bf_col</a>[<a class="code" href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a>];</div><div class="line"><a name="l01106"></a><span class="lineno"> 1106</span>&#160;      }</div><div class="line"><a name="l01107"></a><span class="lineno"> 1107</span>&#160;    }</div><div class="line"><a name="l01108"></a><span class="lineno"> 1108</span>&#160;  }</div><div class="line"><a name="l01109"></a><span class="lineno"> 1109</span>&#160;</div><div class="line"><a name="l01110"></a><span class="lineno"> 1110</span>&#160;</div><div class="line"><a name="l01111"></a><span class="lineno"> 1111</span>&#160;</div><div class="line"><a name="l01112"></a><span class="lineno"> 1112</span>&#160;  <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;matom.c: Failed to select a destruction process in kpkt. Abort.\n&quot;</span>);</div><div class="line"><a name="l01113"></a><span class="lineno"> 1113</span>&#160;  <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a></div><div class="line"><a name="l01114"></a><span class="lineno"> 1114</span>&#160;    (<span class="stringliteral">&quot;matom.c: cooling_bftot %g, cooling_bbtot %g, cooling_ff %g, cooling_bf_coltot %g cooling_adiabatic %g\n&quot;</span>,</div><div class="line"><a name="l01115"></a><span class="lineno"> 1115</span>&#160;     mplasma-&gt;<a class="code" href="structmacro.html#ab0671cf0f286d0fc484da2b0894df5bf">cooling_bftot</a>, mplasma-&gt;<a class="code" href="structmacro.html#a85eac8200ef941e212d8c6b8d0bbf8cf">cooling_bbtot</a>, mplasma-&gt;<a class="code" href="structmacro.html#a8427be6ddfa589b733a30ab12e26daf0">cooling_ff</a>, mplasma-&gt;<a class="code" href="structmacro.html#a6980807d807f7e9e1a49c195e09ce70a">cooling_bf_coltot</a>, mplasma-&gt;<a class="code" href="structmacro.html#a8e77cd87d57475d0c53aab45ad0e78cf">cooling_adiabatic</a>);</div><div class="line"><a name="l01116"></a><span class="lineno"> 1116</span>&#160;</div><div class="line"><a name="l01117"></a><span class="lineno"> 1117</span>&#160;  exit (0);</div><div class="line"><a name="l01118"></a><span class="lineno"> 1118</span>&#160;</div><div class="line"><a name="l01119"></a><span class="lineno"> 1119</span>&#160;  <span class="keywordflow">return</span> (0);</div><div class="line"><a name="l01120"></a><span class="lineno"> 1120</span>&#160;}</div><div class="line"><a name="l01121"></a><span class="lineno"> 1121</span>&#160;</div><div class="line"><a name="l01122"></a><span class="lineno"> 1122</span>&#160;</div><div class="line"><a name="l01123"></a><span class="lineno"> 1123</span>&#160;</div><div class="line"><a name="l01124"></a><span class="lineno"> 1124</span>&#160;<span class="comment">/************************************************************</span></div><div class="line"><a name="l01125"></a><span class="lineno"> 1125</span>&#160;<span class="comment"> ** </span></div><div class="line"><a name="l01126"></a><span class="lineno"> 1126</span>&#160;<span class="comment"> * @brief routine for dealing with bound-bound &quot;simple ions&quot; within the hybrid macro-atom framework</span></div><div class="line"><a name="l01127"></a><span class="lineno"> 1127</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01128"></a><span class="lineno"> 1128</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01129"></a><span class="lineno"> 1129</span>&#160;<span class="comment"> * fake_matom_bb is the macro atom routine that deals with line events involving</span></div><div class="line"><a name="l01130"></a><span class="lineno"> 1130</span>&#160;<span class="comment"> * simple ions (i.e. ions for which a full macro atom treatment is not employed.</span></div><div class="line"><a name="l01131"></a><span class="lineno"> 1131</span>&#160;<span class="comment"> * When this routine is called a simple line has absorbed a packet. This routine </span></div><div class="line"><a name="l01132"></a><span class="lineno"> 1132</span>&#160;<span class="comment"> * creates a fake two-level macro atom and determines whether the packet energy</span></div><div class="line"><a name="l01133"></a><span class="lineno"> 1133</span>&#160;<span class="comment"> * is simply re-emitted in the line or is thermalised. If it is thermalised it</span></div><div class="line"><a name="l01134"></a><span class="lineno"> 1134</span>&#160;<span class="comment"> * turns into a k-packet and the appropriate routine is called. </span></div><div class="line"><a name="l01135"></a><span class="lineno"> 1135</span>&#160;<span class="comment"> * </span></div><div class="line"><a name="l01136"></a><span class="lineno"> 1136</span>&#160;<span class="comment"> * </span></div><div class="line"><a name="l01137"></a><span class="lineno"> 1137</span>&#160;<span class="comment"> * Arguments:</span></div><div class="line"><a name="l01138"></a><span class="lineno"> 1138</span>&#160;<span class="comment"> * </span></div><div class="line"><a name="l01139"></a><span class="lineno"> 1139</span>&#160;<span class="comment"> *        WindPtr w                   the ptr to the structure defining the wind</span></div><div class="line"><a name="l01140"></a><span class="lineno"> 1140</span>&#160;<span class="comment"> *        PhotPtr p                   the packet at the point of activation</span></div><div class="line"><a name="l01141"></a><span class="lineno"> 1141</span>&#160;<span class="comment"> *        int nres                    the process which activates the Macro Atom</span></div><div class="line"><a name="l01142"></a><span class="lineno"> 1142</span>&#160;<span class="comment"> * </span></div><div class="line"><a name="l01143"></a><span class="lineno"> 1143</span>&#160;<span class="comment"> * Returns:</span></div><div class="line"><a name="l01144"></a><span class="lineno"> 1144</span>&#160;<span class="comment"> *        int nres                    the process by which deactivation occurs</span></div><div class="line"><a name="l01145"></a><span class="lineno"> 1145</span>&#160;<span class="comment"> *        PhotPtr p                   the packet following deactivation</span></div><div class="line"><a name="l01146"></a><span class="lineno"> 1146</span>&#160;<span class="comment"> *        int escape                  identifies whether the macro atom deactivated via an</span></div><div class="line"><a name="l01147"></a><span class="lineno"> 1147</span>&#160;<span class="comment"> *                                    r-packet (escape = 1) or a k-packet (escape = 0). If</span></div><div class="line"><a name="l01148"></a><span class="lineno"> 1148</span>&#160;<span class="comment"> *                                    a k-packet then the call to this routine should be</span></div><div class="line"><a name="l01149"></a><span class="lineno"> 1149</span>&#160;<span class="comment"> *                                    followed by a call to kpkt.</span></div><div class="line"><a name="l01150"></a><span class="lineno"> 1150</span>&#160;<span class="comment"> * </span></div><div class="line"><a name="l01151"></a><span class="lineno"> 1151</span>&#160;<span class="comment"> * ###Notes###</span></div><div class="line"><a name="l01152"></a><span class="lineno"> 1152</span>&#160;<span class="comment"> * Apr 04  SS   Coding began.</span></div><div class="line"><a name="l01153"></a><span class="lineno"> 1153</span>&#160;<span class="comment"> * Jun 04  SS   Modified to return escape = 1 for r-packet and 2 for k-packet</span></div><div class="line"><a name="l01154"></a><span class="lineno"> 1154</span>&#160;<span class="comment"> * to avoid call to k-packet within this routine.</span></div><div class="line"><a name="l01155"></a><span class="lineno"> 1155</span>&#160;<span class="comment"> * 06may    ksl 57+ -- Eliminationg passing entire w structure</span></div><div class="line"><a name="l01156"></a><span class="lineno"> 1156</span>&#160;<span class="comment">************************************************************/</span></div><div class="line"><a name="l01157"></a><span class="lineno"> 1157</span>&#160;</div><div class="line"><a name="l01158"></a><span class="lineno"> 1158</span>&#160;<span class="keywordtype">int</span></div><div class="line"><a name="l01159"></a><span class="lineno"><a class="line" href="templates_8h.html#aa39c27768ea571d93b29aa2bf90e7913"> 1159</a></span>&#160;<a class="code" href="matom_8c.html#aa39c27768ea571d93b29aa2bf90e7913">fake_matom_bb</a> (p, <a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a>, escape)</div><div class="line"><a name="l01160"></a><span class="lineno"> 1160</span>&#160;     <a class="code" href="structphoton.html">PhotPtr</a> p;</div><div class="line"><a name="l01161"></a><span class="lineno"> 1161</span>&#160;     <span class="keywordtype">int</span> *<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a>;</div><div class="line"><a name="l01162"></a><span class="lineno"> 1162</span>&#160;     <span class="keywordtype">int</span> *escape;</div><div class="line"><a name="l01163"></a><span class="lineno"> 1163</span>&#160;{</div><div class="line"><a name="l01164"></a><span class="lineno"> 1164</span>&#160;  <span class="keywordtype">double</span> kprb, rprb;</div><div class="line"><a name="l01165"></a><span class="lineno"> 1165</span>&#160;  <a class="code" href="structwind.html">WindPtr</a> one;</div><div class="line"><a name="l01166"></a><span class="lineno"> 1166</span>&#160;  <a class="code" href="structplasma.html">PlasmaPtr</a> <a class="code" href="compton_8c.html#ad65f0d74fe764d3ecae5ec1a89d63f08">xplasma</a>;</div><div class="line"><a name="l01167"></a><span class="lineno"> 1167</span>&#160;  <span class="keyword">struct </span><a class="code" href="structlines.html">lines</a> *line_ptr;</div><div class="line"><a name="l01168"></a><span class="lineno"> 1168</span>&#160;  <span class="keywordtype">double</span> electron_temperature;</div><div class="line"><a name="l01169"></a><span class="lineno"> 1169</span>&#160;  <span class="keywordtype">double</span> normalisation;</div><div class="line"><a name="l01170"></a><span class="lineno"> 1170</span>&#160;  <span class="keywordtype">double</span> choice;</div><div class="line"><a name="l01171"></a><span class="lineno"> 1171</span>&#160;</div><div class="line"><a name="l01172"></a><span class="lineno"> 1172</span>&#160;  one = &amp;<a class="code" href="python_8h.html#a940291848296c285c722ed248863afc1">wmain</a>[p-&gt;<a class="code" href="structphoton.html#a2aa9d1ea7afffe4f370b28b0a21d6c79">grid</a>];        <span class="comment">//record where we are</span></div><div class="line"><a name="l01173"></a><span class="lineno"> 1173</span>&#160;  xplasma = &amp;<a class="code" href="python_8h.html#af5711847369600743b86dd27343fab7a">plasmamain</a>[one-&gt;<a class="code" href="structwind.html#ae01b6d799a4f0a60142703606c9fea3c">nplasma</a>];</div><div class="line"><a name="l01174"></a><span class="lineno"> 1174</span>&#160;</div><div class="line"><a name="l01175"></a><span class="lineno"> 1175</span>&#160;  line_ptr = <a class="code" href="atomic_8h.html#a8c1d70d2c39e64a6cc16b6132d86c044">lin_ptr</a>[*<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a>];    <span class="comment">//record the line pointer</span></div><div class="line"><a name="l01176"></a><span class="lineno"> 1176</span>&#160;  electron_temperature = xplasma-&gt;<a class="code" href="structplasma.html#a9b217285a754e1533f95d92972b6afd6">t_e</a>;</div><div class="line"><a name="l01177"></a><span class="lineno"> 1177</span>&#160;</div><div class="line"><a name="l01178"></a><span class="lineno"> 1178</span>&#160;  <span class="comment">/* Upon calling we know that the upper level of our fake two level macro</span></div><div class="line"><a name="l01179"></a><span class="lineno"> 1179</span>&#160;<span class="comment">     atom is excited. Since it&#39;s only two-levels there are no jumping probabilities</span></div><div class="line"><a name="l01180"></a><span class="lineno"> 1180</span>&#160;<span class="comment">     and the only decision that needs to be made is whether it de-excites by an r-packet</span></div><div class="line"><a name="l01181"></a><span class="lineno"> 1181</span>&#160;<span class="comment">     in the line or a collisionally produced k-packet. To decide this we compute the</span></div><div class="line"><a name="l01182"></a><span class="lineno"> 1182</span>&#160;<span class="comment">     two emission probabilities. rprb is the probability of the r-packet and kprb</span></div><div class="line"><a name="l01183"></a><span class="lineno"> 1183</span>&#160;<span class="comment">     for the k-packet. */</span></div><div class="line"><a name="l01184"></a><span class="lineno"> 1184</span>&#160;</div><div class="line"><a name="l01185"></a><span class="lineno"> 1185</span>&#160;  <span class="comment">/* Since both k- and r-packet emission have the same delta energy associated with them then</span></div><div class="line"><a name="l01186"></a><span class="lineno"> 1186</span>&#160;<span class="comment">     we can ignore the energy factor that is otherwise needed in the de-activation probabilities.</span></div><div class="line"><a name="l01187"></a><span class="lineno"> 1187</span>&#160;<span class="comment">     The upper level population is also factored out. (SS) */</span></div><div class="line"><a name="l01188"></a><span class="lineno"> 1188</span>&#160;</div><div class="line"><a name="l01189"></a><span class="lineno"> 1189</span>&#160;  rprb = <a class="code" href="atomic_8c.html#a8c589bd3089b7851e8da407ad1ce44a5">a21</a> (line_ptr) * <a class="code" href="foo_8h.html#a3579026b8eac7743ef56ad21ff9696ff">p_escape</a> (line_ptr, xplasma);</div><div class="line"><a name="l01190"></a><span class="lineno"> 1190</span>&#160;  <span class="comment">// Einstein-A * escape probability</span></div><div class="line"><a name="l01191"></a><span class="lineno"> 1191</span>&#160;</div><div class="line"><a name="l01192"></a><span class="lineno"> 1192</span>&#160;  kprb = <a class="code" href="foo_8h.html#a6daa97078321cf4f668d31b7004fed6c">q21</a> (line_ptr, electron_temperature) * xplasma-&gt;<a class="code" href="structplasma.html#ac1d38c3e4cc4ef2a1e4d83d7f8b71d22">ne</a> * (1. - exp (-<a class="code" href="atomic_8h.html#a97148aa86d99b11c881e5f32845861d4">H_OVER_K</a> * line_ptr-&gt;<a class="code" href="structlines.html#a4d74840df54d02617c21c66b2498a81c">freq</a> / electron_temperature));</div><div class="line"><a name="l01193"></a><span class="lineno"> 1193</span>&#160;  <span class="comment">// Collision de-excitation rate coeff. * electron density </span></div><div class="line"><a name="l01194"></a><span class="lineno"> 1194</span>&#160;  <span class="comment">/* The extra factor of (1 - exp (-h nu / k T)) is explained in KSL&#39;s notes on Python. It appears because we are</span></div><div class="line"><a name="l01195"></a><span class="lineno"> 1195</span>&#160;<span class="comment">     using the &quot;scattering fraction&quot; formalism for simple ions. (SS May 04). */</span></div><div class="line"><a name="l01196"></a><span class="lineno"> 1196</span>&#160;</div><div class="line"><a name="l01197"></a><span class="lineno"> 1197</span>&#160;  normalisation = kprb + rprb;</div><div class="line"><a name="l01198"></a><span class="lineno"> 1198</span>&#160;</div><div class="line"><a name="l01199"></a><span class="lineno"> 1199</span>&#160;  kprb = kprb / normalisation;</div><div class="line"><a name="l01200"></a><span class="lineno"> 1200</span>&#160;</div><div class="line"><a name="l01201"></a><span class="lineno"> 1201</span>&#160;  rprb = rprb / normalisation;</div><div class="line"><a name="l01202"></a><span class="lineno"> 1202</span>&#160;</div><div class="line"><a name="l01203"></a><span class="lineno"> 1203</span>&#160;  <span class="comment">/* Now just use a random number to decide what happens. */</span></div><div class="line"><a name="l01204"></a><span class="lineno"> 1204</span>&#160;</div><div class="line"><a name="l01205"></a><span class="lineno"> 1205</span>&#160;<span class="comment">//  choice = ((rand () + 0.5) / MAXRAND); //DONE</span></div><div class="line"><a name="l01206"></a><span class="lineno"> 1206</span>&#160;  choice = <a class="code" href="foo_8h.html#a451b4740f3d1e12cb07885b0d3e5ef1b">random_number</a>(0.0,1.0);</div><div class="line"><a name="l01207"></a><span class="lineno"> 1207</span>&#160;</div><div class="line"><a name="l01208"></a><span class="lineno"> 1208</span>&#160;</div><div class="line"><a name="l01209"></a><span class="lineno"> 1209</span>&#160;  <span class="comment">/* If &quot;choice&quot; is less than rprb then we have chosen a radiative decay - for this fake macro atom there </span></div><div class="line"><a name="l01210"></a><span class="lineno"> 1210</span>&#160;<span class="comment">     is only one line so there&#39;s nothing to do - the energy is re-radiated in the line and that&#39;s it. We</span></div><div class="line"><a name="l01211"></a><span class="lineno"> 1211</span>&#160;<span class="comment">     don&#39;t need to change nres. Otherwise we&#39;ve chosen a collisional destruction and so we need to get</span></div><div class="line"><a name="l01212"></a><span class="lineno"> 1212</span>&#160;<span class="comment">     kpkt to deal with the resulting k-packet and give us a new value of nres following thermalisation and</span></div><div class="line"><a name="l01213"></a><span class="lineno"> 1213</span>&#160;<span class="comment">     re-emission of the energy. */</span></div><div class="line"><a name="l01214"></a><span class="lineno"> 1214</span>&#160;</div><div class="line"><a name="l01215"></a><span class="lineno"> 1215</span>&#160;  <span class="keywordflow">if</span> (choice &lt; rprb)</div><div class="line"><a name="l01216"></a><span class="lineno"> 1216</span>&#160;  {</div><div class="line"><a name="l01217"></a><span class="lineno"> 1217</span>&#160;    *escape = 1;                <span class="comment">//it&#39;s an r-packet de-activation</span></div><div class="line"><a name="l01218"></a><span class="lineno"> 1218</span>&#160;    p-&gt;<a class="code" href="structphoton.html#a98c6d400814a43aeda7d7fd1ed2d7dc6">freq</a> = line_ptr-&gt;<a class="code" href="structlines.html#a4d74840df54d02617c21c66b2498a81c">freq</a>;   <span class="comment">// As in matom, set this to the comoving frequency</span></div><div class="line"><a name="l01219"></a><span class="lineno"> 1219</span>&#160;  }</div><div class="line"><a name="l01220"></a><span class="lineno"> 1220</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l01221"></a><span class="lineno"> 1221</span>&#160;  {</div><div class="line"><a name="l01222"></a><span class="lineno"> 1222</span>&#160;    <span class="comment">/* Return the instruction to macro_gov to</span></div><div class="line"><a name="l01223"></a><span class="lineno"> 1223</span>&#160;<span class="comment">       make a k-packet. */</span></div><div class="line"><a name="l01224"></a><span class="lineno"> 1224</span>&#160;</div><div class="line"><a name="l01225"></a><span class="lineno"> 1225</span>&#160;    *escape = 0;</div><div class="line"><a name="l01226"></a><span class="lineno"> 1226</span>&#160;</div><div class="line"><a name="l01227"></a><span class="lineno"> 1227</span>&#160;  }</div><div class="line"><a name="l01228"></a><span class="lineno"> 1228</span>&#160;</div><div class="line"><a name="l01229"></a><span class="lineno"> 1229</span>&#160;  <span class="comment">/* That&#39;s it - we&#39;ve dealt with the simple line. */</span></div><div class="line"><a name="l01230"></a><span class="lineno"> 1230</span>&#160;</div><div class="line"><a name="l01231"></a><span class="lineno"> 1231</span>&#160;  <span class="keywordflow">return</span> (0);</div><div class="line"><a name="l01232"></a><span class="lineno"> 1232</span>&#160;</div><div class="line"><a name="l01233"></a><span class="lineno"> 1233</span>&#160;}</div><div class="line"><a name="l01234"></a><span class="lineno"> 1234</span>&#160;</div><div class="line"><a name="l01235"></a><span class="lineno"> 1235</span>&#160;</div><div class="line"><a name="l01236"></a><span class="lineno"> 1236</span>&#160;<span class="comment">/************************************************************</span></div><div class="line"><a name="l01237"></a><span class="lineno"> 1237</span>&#160;<span class="comment"> ** </span></div><div class="line"><a name="l01238"></a><span class="lineno"> 1238</span>&#160;<span class="comment"> *  @brief routine for dealing with bound-free &quot;simple ions&quot; within the hybrid macro-atom framework</span></div><div class="line"><a name="l01239"></a><span class="lineno"> 1239</span>&#160;<span class="comment"> *</span></div><div class="line"><a name="l01240"></a><span class="lineno"> 1240</span>&#160;<span class="comment"> * fake_matom_bf is the macro atom routine that deals with photoionisation </span></div><div class="line"><a name="l01241"></a><span class="lineno"> 1241</span>&#160;<span class="comment"> * events involving simple ions (i.e. ions for which a full macro atom treatment </span></div><div class="line"><a name="l01242"></a><span class="lineno"> 1242</span>&#160;<span class="comment"> * is not employed).</span></div><div class="line"><a name="l01243"></a><span class="lineno"> 1243</span>&#160;<span class="comment"> * When this routine is called a photoionisation has absorbed a packet. </span></div><div class="line"><a name="l01244"></a><span class="lineno"> 1244</span>&#160;<span class="comment"> * The idea of this routine is to deal with the subsequenct</span></div><div class="line"><a name="l01245"></a><span class="lineno"> 1245</span>&#160;<span class="comment"> * by creating a fake two-level atom. </span></div><div class="line"><a name="l01246"></a><span class="lineno"> 1246</span>&#160;<span class="comment"> * However, in the absense of collisional recombination (or something</span></div><div class="line"><a name="l01247"></a><span class="lineno"> 1247</span>&#160;<span class="comment"> * similar) there&#39;s only one thing that can happen - radiative </span></div><div class="line"><a name="l01248"></a><span class="lineno"> 1248</span>&#160;<span class="comment"> * recombination. Therefore there&#39;s no need to do anything here unless</span></div><div class="line"><a name="l01249"></a><span class="lineno"> 1249</span>&#160;<span class="comment"> * collisional recombination is to be introduced at some point in the</span></div><div class="line"><a name="l01250"></a><span class="lineno"> 1250</span>&#160;<span class="comment"> * future.</span></div><div class="line"><a name="l01251"></a><span class="lineno"> 1251</span>&#160;<span class="comment"> * All this routine does for now is choose a new frequency for the </span></div><div class="line"><a name="l01252"></a><span class="lineno"> 1252</span>&#160;<span class="comment"> * emitted r-packet.</span></div><div class="line"><a name="l01253"></a><span class="lineno"> 1253</span>&#160;<span class="comment"> * </span></div><div class="line"><a name="l01254"></a><span class="lineno"> 1254</span>&#160;<span class="comment"> * </span></div><div class="line"><a name="l01255"></a><span class="lineno"> 1255</span>&#160;<span class="comment"> * Arguments:</span></div><div class="line"><a name="l01256"></a><span class="lineno"> 1256</span>&#160;<span class="comment"> * </span></div><div class="line"><a name="l01257"></a><span class="lineno"> 1257</span>&#160;<span class="comment"> *        WindPtr w                   the ptr to the structure defining the wind</span></div><div class="line"><a name="l01258"></a><span class="lineno"> 1258</span>&#160;<span class="comment"> *        PhotPtr p                   the packet at the point of activation</span></div><div class="line"><a name="l01259"></a><span class="lineno"> 1259</span>&#160;<span class="comment"> *        int nres                    the process which activates the Macro Atom</span></div><div class="line"><a name="l01260"></a><span class="lineno"> 1260</span>&#160;<span class="comment"> * </span></div><div class="line"><a name="l01261"></a><span class="lineno"> 1261</span>&#160;<span class="comment"> * Returns:</span></div><div class="line"><a name="l01262"></a><span class="lineno"> 1262</span>&#160;<span class="comment"> *        int nres                    the process by which deactivation occurs</span></div><div class="line"><a name="l01263"></a><span class="lineno"> 1263</span>&#160;<span class="comment"> *        PhotPtr p                   the packet following deactivation</span></div><div class="line"><a name="l01264"></a><span class="lineno"> 1264</span>&#160;<span class="comment"> *        int escape                  in principle this tells us whether de-activation is</span></div><div class="line"><a name="l01265"></a><span class="lineno"> 1265</span>&#160;<span class="comment"> *                                    via an r-packet or a k-packet. For this routine at the </span></div><div class="line"><a name="l01266"></a><span class="lineno"> 1266</span>&#160;<span class="comment"> *                                    moment only r-packets are possible so it always returns</span></div><div class="line"><a name="l01267"></a><span class="lineno"> 1267</span>&#160;<span class="comment"> *                                    escape = 1</span></div><div class="line"><a name="l01268"></a><span class="lineno"> 1268</span>&#160;<span class="comment"> * ###Notes###:</span></div><div class="line"><a name="l01269"></a><span class="lineno"> 1269</span>&#160;<span class="comment"> * Apr 04  SS   Coding began.</span></div><div class="line"><a name="l01270"></a><span class="lineno"> 1270</span>&#160;<span class="comment"> * Jun 04  SS   Modified to include &quot;escape&quot; being set to 1</span></div><div class="line"><a name="l01271"></a><span class="lineno"> 1271</span>&#160;<span class="comment"> * 06may    ksl 57+ -- Modified for new structure.  Have not fixed the call to fake_atom</span></div><div class="line"><a name="l01272"></a><span class="lineno"> 1272</span>&#160;<span class="comment"> * !!! Currently this assumes hydrogenic shape cross-section - Improve.</span></div><div class="line"><a name="l01273"></a><span class="lineno"> 1273</span>&#160;<span class="comment">************************************************************/</span></div><div class="line"><a name="l01274"></a><span class="lineno"> 1274</span>&#160;</div><div class="line"><a name="l01275"></a><span class="lineno"> 1275</span>&#160;<span class="keywordtype">int</span></div><div class="line"><a name="l01276"></a><span class="lineno"><a class="line" href="templates_8h.html#a4c03c66dea8a22dd2a87077c816d26c2"> 1276</a></span>&#160;<a class="code" href="matom_8c.html#a4c03c66dea8a22dd2a87077c816d26c2">fake_matom_bf</a> (p, <a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a>, escape)</div><div class="line"><a name="l01277"></a><span class="lineno"> 1277</span>&#160;     <a class="code" href="structphoton.html">PhotPtr</a> p;</div><div class="line"><a name="l01278"></a><span class="lineno"> 1278</span>&#160;     <span class="keywordtype">int</span> *<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a>;</div><div class="line"><a name="l01279"></a><span class="lineno"> 1279</span>&#160;     <span class="keywordtype">int</span> *escape;</div><div class="line"><a name="l01280"></a><span class="lineno"> 1280</span>&#160;{</div><div class="line"><a name="l01281"></a><span class="lineno"> 1281</span>&#160;  <a class="code" href="structwind.html">WindPtr</a> one;</div><div class="line"><a name="l01282"></a><span class="lineno"> 1282</span>&#160;  <a class="code" href="structplasma.html">PlasmaPtr</a> <a class="code" href="compton_8c.html#ad65f0d74fe764d3ecae5ec1a89d63f08">xplasma</a>;</div><div class="line"><a name="l01283"></a><span class="lineno"> 1283</span>&#160;</div><div class="line"><a name="l01284"></a><span class="lineno"> 1284</span>&#160;  one = &amp;<a class="code" href="python_8h.html#a940291848296c285c722ed248863afc1">wmain</a>[p-&gt;<a class="code" href="structphoton.html#a2aa9d1ea7afffe4f370b28b0a21d6c79">grid</a>];        <span class="comment">//record where we are</span></div><div class="line"><a name="l01285"></a><span class="lineno"> 1285</span>&#160;  xplasma = &amp;<a class="code" href="python_8h.html#af5711847369600743b86dd27343fab7a">plasmamain</a>[one-&gt;<a class="code" href="structwind.html#ae01b6d799a4f0a60142703606c9fea3c">nplasma</a>];</div><div class="line"><a name="l01286"></a><span class="lineno"> 1286</span>&#160;</div><div class="line"><a name="l01287"></a><span class="lineno"> 1287</span>&#160;  <span class="comment">/* All that can happen is radiative recombination (no collisional recombination</span></div><div class="line"><a name="l01288"></a><span class="lineno"> 1288</span>&#160;<span class="comment">     for now. Just choose frequency for re-emission). */</span></div><div class="line"><a name="l01289"></a><span class="lineno"> 1289</span>&#160;</div><div class="line"><a name="l01290"></a><span class="lineno"> 1290</span>&#160;  *escape = 1;                  <span class="comment">//always an r-packet here</span></div><div class="line"><a name="l01291"></a><span class="lineno"> 1291</span>&#160;</div><div class="line"><a name="l01292"></a><span class="lineno"> 1292</span>&#160;<span class="comment">//  p-&gt;freq = phot_top[*nres - NLINES - 1].freq[0] - (log (1. - (rand () + 0.5) / MAXRAND) * xplasma-&gt;t_e / H_OVER_K); DONE</span></div><div class="line"><a name="l01293"></a><span class="lineno"> 1293</span>&#160;  p-&gt;<a class="code" href="structphoton.html#a98c6d400814a43aeda7d7fd1ed2d7dc6">freq</a> = <a class="code" href="atomic_8h.html#aed5961eebbc0ca048e57fe2ad4cdfab8">phot_top</a>[*<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a> - <a class="code" href="atomic_8h.html#a59990369239024c94cbe22080c9d29c3">NLINES</a> - 1].<a class="code" href="structtopbase__phot.html#a18d8d6eeb8df6e8ad2f89550c6b86310">freq</a>[0] - (log (1. - <a class="code" href="foo_8h.html#a451b4740f3d1e12cb07885b0d3e5ef1b">random_number</a>(0.0,1.0)) * xplasma-&gt;<a class="code" href="structplasma.html#a9b217285a754e1533f95d92972b6afd6">t_e</a> / <a class="code" href="atomic_8h.html#a97148aa86d99b11c881e5f32845861d4">H_OVER_K</a>);</div><div class="line"><a name="l01294"></a><span class="lineno"> 1294</span>&#160;  </div><div class="line"><a name="l01295"></a><span class="lineno"> 1295</span>&#160;</div><div class="line"><a name="l01296"></a><span class="lineno"> 1296</span>&#160;  <span class="comment">/* Currently this assumes hydrogenic shape cross-section - Improve */</span></div><div class="line"><a name="l01297"></a><span class="lineno"> 1297</span>&#160;</div><div class="line"><a name="l01298"></a><span class="lineno"> 1298</span>&#160;  <span class="keywordflow">return</span> (0);</div><div class="line"><a name="l01299"></a><span class="lineno"> 1299</span>&#160;</div><div class="line"><a name="l01300"></a><span class="lineno"> 1300</span>&#160;}</div><div class="line"><a name="l01301"></a><span class="lineno"> 1301</span>&#160;</div><div class="line"><a name="l01302"></a><span class="lineno"> 1302</span>&#160;</div><div class="line"><a name="l01303"></a><span class="lineno"> 1303</span>&#160;</div><div class="line"><a name="l01304"></a><span class="lineno"> 1304</span>&#160;</div><div class="line"><a name="l01305"></a><span class="lineno"> 1305</span>&#160;<span class="comment">/**********************************************************/</span></div><div class="line"><a name="l01322"></a><span class="lineno"> 1322</span>&#160;<span class="keywordtype">int</span></div><div class="line"><a name="l01323"></a><span class="lineno"><a class="line" href="templates_8h.html#a9ae82cdebefd0a70326fd37ee0a61fd4"> 1323</a></span>&#160;<a class="code" href="matom_8c.html#a9ae82cdebefd0a70326fd37ee0a61fd4">emit_matom</a> (w, p, <a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a>, upper)</div><div class="line"><a name="l01324"></a><span class="lineno"> 1324</span>&#160;     <a class="code" href="structwind.html">WindPtr</a> w;</div><div class="line"><a name="l01325"></a><span class="lineno"> 1325</span>&#160;     <a class="code" href="structphoton.html">PhotPtr</a> p;</div><div class="line"><a name="l01326"></a><span class="lineno"> 1326</span>&#160;     <span class="keywordtype">int</span> *<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a>;</div><div class="line"><a name="l01327"></a><span class="lineno"> 1327</span>&#160;     <span class="keywordtype">int</span> upper;</div><div class="line"><a name="l01328"></a><span class="lineno"> 1328</span>&#160;{</div><div class="line"><a name="l01329"></a><span class="lineno"> 1329</span>&#160;  <span class="keyword">struct </span><a class="code" href="structlines.html">lines</a> *line_ptr;</div><div class="line"><a name="l01330"></a><span class="lineno"> 1330</span>&#160;  <span class="keyword">struct </span><a class="code" href="structtopbase__phot.html">topbase_phot</a> *cont_ptr;</div><div class="line"><a name="l01331"></a><span class="lineno"> 1331</span>&#160;  <span class="keywordtype">int</span> uplvl;</div><div class="line"><a name="l01332"></a><span class="lineno"> 1332</span>&#160;  <span class="keywordtype">double</span> <a class="code" href="matom_8c.html#a53e97649d5cd9a1fab024ab99489ddb1">alpha_sp</a> ();</div><div class="line"><a name="l01333"></a><span class="lineno"> 1333</span>&#160;  <span class="keywordtype">double</span> eprbs[<a class="code" href="atomic_8h.html#a27e1e039bca1d64c21caa972e1111c09">NBBJUMPS</a> + <a class="code" href="atomic_8h.html#a0829916f98c17313ddf806ae4a16355e">NBFJUMPS</a>];</div><div class="line"><a name="l01334"></a><span class="lineno"> 1334</span>&#160;  <span class="keywordtype">double</span> penorm;</div><div class="line"><a name="l01335"></a><span class="lineno"> 1335</span>&#160;  <span class="keywordtype">double</span> threshold, run_tot;</div><div class="line"><a name="l01336"></a><span class="lineno"> 1336</span>&#160;  <span class="keywordtype">double</span> sp_rec_rate;</div><div class="line"><a name="l01337"></a><span class="lineno"> 1337</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>, m;</div><div class="line"><a name="l01338"></a><span class="lineno"> 1338</span>&#160;  <span class="keywordtype">int</span> nbbd, nbfd;</div><div class="line"><a name="l01339"></a><span class="lineno"> 1339</span>&#160;  <span class="keywordtype">double</span> t_e, ne;</div><div class="line"><a name="l01340"></a><span class="lineno"> 1340</span>&#160;  <span class="keywordtype">double</span> bb_cont;</div><div class="line"><a name="l01341"></a><span class="lineno"> 1341</span>&#160;  <a class="code" href="structwind.html">WindPtr</a> one;</div><div class="line"><a name="l01342"></a><span class="lineno"> 1342</span>&#160;  <a class="code" href="structplasma.html">PlasmaPtr</a> <a class="code" href="compton_8c.html#ad65f0d74fe764d3ecae5ec1a89d63f08">xplasma</a>;</div><div class="line"><a name="l01343"></a><span class="lineno"> 1343</span>&#160;</div><div class="line"><a name="l01344"></a><span class="lineno"> 1344</span>&#160;</div><div class="line"><a name="l01345"></a><span class="lineno"> 1345</span>&#160;  one = &amp;w[p-&gt;<a class="code" href="structphoton.html#a2aa9d1ea7afffe4f370b28b0a21d6c79">grid</a>];            <span class="comment">//This is to identify the grip cell in which we are</span></div><div class="line"><a name="l01346"></a><span class="lineno"> 1346</span>&#160;  xplasma = &amp;<a class="code" href="python_8h.html#af5711847369600743b86dd27343fab7a">plasmamain</a>[one-&gt;<a class="code" href="structwind.html#ae01b6d799a4f0a60142703606c9fea3c">nplasma</a>];</div><div class="line"><a name="l01347"></a><span class="lineno"> 1347</span>&#160;</div><div class="line"><a name="l01348"></a><span class="lineno"> 1348</span>&#160;  t_e = xplasma-&gt;<a class="code" href="structplasma.html#a9b217285a754e1533f95d92972b6afd6">t_e</a>;           <span class="comment">//electron temperature </span></div><div class="line"><a name="l01349"></a><span class="lineno"> 1349</span>&#160;  ne = xplasma-&gt;<a class="code" href="structplasma.html#ac1d38c3e4cc4ef2a1e4d83d7f8b71d22">ne</a>;             <span class="comment">//electron number density</span></div><div class="line"><a name="l01350"></a><span class="lineno"> 1350</span>&#160;</div><div class="line"><a name="l01351"></a><span class="lineno"> 1351</span>&#160;</div><div class="line"><a name="l01352"></a><span class="lineno"> 1352</span>&#160;  <span class="comment">/* The first step is to identify the configuration that has been excited. */</span></div><div class="line"><a name="l01353"></a><span class="lineno"> 1353</span>&#160;</div><div class="line"><a name="l01354"></a><span class="lineno"> 1354</span>&#160;  uplvl = upper;</div><div class="line"><a name="l01355"></a><span class="lineno"> 1355</span>&#160;</div><div class="line"><a name="l01356"></a><span class="lineno"> 1356</span>&#160;  <span class="comment">/* Unlike the proper matom routine, we don&#39;t want any jumps, only deactivations here. */</span></div><div class="line"><a name="l01357"></a><span class="lineno"> 1357</span>&#160;</div><div class="line"><a name="l01358"></a><span class="lineno"> 1358</span>&#160;</div><div class="line"><a name="l01359"></a><span class="lineno"> 1359</span>&#160;  <span class="comment">/*  The excited configuration is now known. Now compute all the probabilities of deactivation</span></div><div class="line"><a name="l01360"></a><span class="lineno"> 1360</span>&#160;<span class="comment">     /jumping from this configuration. Then choose one. */</span></div><div class="line"><a name="l01361"></a><span class="lineno"> 1361</span>&#160;</div><div class="line"><a name="l01362"></a><span class="lineno"> 1362</span>&#160;</div><div class="line"><a name="l01363"></a><span class="lineno"> 1363</span>&#160;  nbbd = <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#ade544b4d373e9e586f689a19330037ec">n_bbd_jump</a>;      <span class="comment">//store these for easy access -- number of bb downward jumps</span></div><div class="line"><a name="l01364"></a><span class="lineno"> 1364</span>&#160;  nbfd = <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#acfee0b128e4e7c2a4e6aea0687a233d9">n_bfd_jump</a>;      <span class="comment">// number of bf downared jumps from this transition</span></div><div class="line"><a name="l01365"></a><span class="lineno"> 1365</span>&#160;</div><div class="line"><a name="l01366"></a><span class="lineno"> 1366</span>&#160;</div><div class="line"><a name="l01367"></a><span class="lineno"> 1367</span>&#160;  <span class="comment">// Start by setting everything to 0</span></div><div class="line"><a name="l01368"></a><span class="lineno"> 1368</span>&#160;</div><div class="line"><a name="l01369"></a><span class="lineno"> 1369</span>&#160;  m = 0;                        <span class="comment">//m counts the total number of possible ways to leave the level</span></div><div class="line"><a name="l01370"></a><span class="lineno"> 1370</span>&#160;  penorm = 0.0;                 <span class="comment">//stores the total emission probability</span></div><div class="line"><a name="l01371"></a><span class="lineno"> 1371</span>&#160;</div><div class="line"><a name="l01372"></a><span class="lineno"> 1372</span>&#160;  <span class="keywordflow">for</span> (n = 0; n &lt; nbbd + nbfd; n++)</div><div class="line"><a name="l01373"></a><span class="lineno"> 1373</span>&#160;  {</div><div class="line"><a name="l01374"></a><span class="lineno"> 1374</span>&#160;    eprbs[<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>] = 0;               <span class="comment">//stores the individual emission probabilities SS</span></div><div class="line"><a name="l01375"></a><span class="lineno"> 1375</span>&#160;  }</div><div class="line"><a name="l01376"></a><span class="lineno"> 1376</span>&#160;  <span class="comment">/* Finished zeroing. */</span></div><div class="line"><a name="l01377"></a><span class="lineno"> 1377</span>&#160;</div><div class="line"><a name="l01378"></a><span class="lineno"> 1378</span>&#160;</div><div class="line"><a name="l01379"></a><span class="lineno"> 1379</span>&#160;  <span class="comment">/* bb */</span></div><div class="line"><a name="l01380"></a><span class="lineno"> 1380</span>&#160;</div><div class="line"><a name="l01381"></a><span class="lineno"> 1381</span>&#160;  <span class="comment">/* First downward jumps. */</span></div><div class="line"><a name="l01382"></a><span class="lineno"> 1382</span>&#160;</div><div class="line"><a name="l01383"></a><span class="lineno"> 1383</span>&#160;  <span class="keywordflow">for</span> (n = 0; n &lt; nbbd; n++)</div><div class="line"><a name="l01384"></a><span class="lineno"> 1384</span>&#160;  {</div><div class="line"><a name="l01385"></a><span class="lineno"> 1385</span>&#160;    line_ptr = &amp;<a class="code" href="atomic_8h.html#a1df743c9da06da92232eff98af40239a">line</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a4d26c780eab93bd42aeefef3ddc9fcda">bbd_jump</a>[<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>]];</div><div class="line"><a name="l01386"></a><span class="lineno"> 1386</span>&#160;    <span class="comment">/* Since we are only interested in making an r-packet here we can (a) ignore collisional</span></div><div class="line"><a name="l01387"></a><span class="lineno"> 1387</span>&#160;<span class="comment">       deactivation and (b) ignore lines outside the frequency range of interest. */</span></div><div class="line"><a name="l01388"></a><span class="lineno"> 1388</span>&#160;    <span class="keywordflow">if</span> ((line_ptr-&gt;<a class="code" href="structlines.html#a4d74840df54d02617c21c66b2498a81c">freq</a> &gt; <a class="code" href="python_8h.html#a740c6412880dd24768165a351bb9b214">em_rnge</a>.<a class="code" href="structemiss__range.html#ae32bcc0c5aa7a7f15c63cee741f1f2b0">fmin</a>) &amp;&amp; (line_ptr-&gt;<a class="code" href="structlines.html#a4d74840df54d02617c21c66b2498a81c">freq</a> &lt; <a class="code" href="python_8h.html#a740c6412880dd24768165a351bb9b214">em_rnge</a>.<a class="code" href="structemiss__range.html#ac6c5df2b3f9dd4eb3bc729feac39ae2d">fmax</a>))     <span class="comment">// correct range</span></div><div class="line"><a name="l01389"></a><span class="lineno"> 1389</span>&#160;    {</div><div class="line"><a name="l01390"></a><span class="lineno"> 1390</span>&#160;      bb_cont = (<a class="code" href="atomic_8c.html#a8c589bd3089b7851e8da407ad1ce44a5">a21</a> (line_ptr) * <a class="code" href="foo_8h.html#a3579026b8eac7743ef56ad21ff9696ff">p_escape</a> (line_ptr, xplasma));</div><div class="line"><a name="l01391"></a><span class="lineno"> 1391</span>&#160;</div><div class="line"><a name="l01392"></a><span class="lineno"> 1392</span>&#160;      eprbs[m] = bb_cont * (<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a7759058c9db6702f3e3cefa8c2506110">ex</a> - <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[<a class="code" href="atomic_8h.html#a1df743c9da06da92232eff98af40239a">line</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a4d26c780eab93bd42aeefef3ddc9fcda">bbd_jump</a>[<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>]].<a class="code" href="structlines.html#aa570454ab15c3c7d4324b54a254daf05">nconfigl</a>].<a class="code" href="structconfigurations.html#a7759058c9db6702f3e3cefa8c2506110">ex</a>);    <span class="comment">//energy difference</span></div><div class="line"><a name="l01393"></a><span class="lineno"> 1393</span>&#160;</div><div class="line"><a name="l01394"></a><span class="lineno"> 1394</span>&#160;      <span class="keywordflow">if</span> (eprbs[m] &lt; 0.)        <span class="comment">//test (can be deleted eventually SS)</span></div><div class="line"><a name="l01395"></a><span class="lineno"> 1395</span>&#160;      {</div><div class="line"><a name="l01396"></a><span class="lineno"> 1396</span>&#160;        <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;Negative probability (matom, 2). Abort.&quot;</span>);</div><div class="line"><a name="l01397"></a><span class="lineno"> 1397</span>&#160;        exit (0);</div><div class="line"><a name="l01398"></a><span class="lineno"> 1398</span>&#160;      }</div><div class="line"><a name="l01399"></a><span class="lineno"> 1399</span>&#160;</div><div class="line"><a name="l01400"></a><span class="lineno"> 1400</span>&#160;      penorm += eprbs[m];</div><div class="line"><a name="l01401"></a><span class="lineno"> 1401</span>&#160;    }</div><div class="line"><a name="l01402"></a><span class="lineno"> 1402</span>&#160;    m++;</div><div class="line"><a name="l01403"></a><span class="lineno"> 1403</span>&#160;  }</div><div class="line"><a name="l01404"></a><span class="lineno"> 1404</span>&#160;</div><div class="line"><a name="l01405"></a><span class="lineno"> 1405</span>&#160;  <span class="comment">/* bf */</span></div><div class="line"><a name="l01406"></a><span class="lineno"> 1406</span>&#160;  <span class="keywordflow">for</span> (n = 0; n &lt; nbfd; n++)</div><div class="line"><a name="l01407"></a><span class="lineno"> 1407</span>&#160;  {</div><div class="line"><a name="l01408"></a><span class="lineno"> 1408</span>&#160;    cont_ptr = &amp;<a class="code" href="atomic_8h.html#aed5961eebbc0ca048e57fe2ad4cdfab8">phot_top</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a20d66fef678daa8ef52c0b933546e16a">bfd_jump</a>[<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>]];    <span class="comment">//pointer to continuum</span></div><div class="line"><a name="l01409"></a><span class="lineno"> 1409</span>&#160;</div><div class="line"><a name="l01410"></a><span class="lineno"> 1410</span>&#160;    <span class="comment">/* If the edge is above the frequency range we are interested in then we need not consider this</span></div><div class="line"><a name="l01411"></a><span class="lineno"> 1411</span>&#160;<span class="comment">       bf process. */</span></div><div class="line"><a name="l01412"></a><span class="lineno"> 1412</span>&#160;    <span class="keywordflow">if</span> (cont_ptr-&gt;<a class="code" href="structtopbase__phot.html#a18d8d6eeb8df6e8ad2f89550c6b86310">freq</a>[0] &lt; <a class="code" href="python_8h.html#a740c6412880dd24768165a351bb9b214">em_rnge</a>.<a class="code" href="structemiss__range.html#ac6c5df2b3f9dd4eb3bc729feac39ae2d">fmax</a>)       <span class="comment">//means that it may contribute</span></div><div class="line"><a name="l01413"></a><span class="lineno"> 1413</span>&#160;    {</div><div class="line"><a name="l01414"></a><span class="lineno"> 1414</span>&#160;      sp_rec_rate = <a class="code" href="matom_8c.html#a53e97649d5cd9a1fab024ab99489ddb1">alpha_sp</a> (cont_ptr, xplasma, 0);</div><div class="line"><a name="l01415"></a><span class="lineno"> 1415</span>&#160;      eprbs[m] = sp_rec_rate * ne * (<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a7759058c9db6702f3e3cefa8c2506110">ex</a> - <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[<a class="code" href="atomic_8h.html#aed5961eebbc0ca048e57fe2ad4cdfab8">phot_top</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a20d66fef678daa8ef52c0b933546e16a">bfd_jump</a>[<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>]].<a class="code" href="structtopbase__phot.html#ae51ac7fd7f3c120cf7eb188b207b824f">nlev</a>].<a class="code" href="structconfigurations.html#a7759058c9db6702f3e3cefa8c2506110">ex</a>);   <span class="comment">//energy difference</span></div><div class="line"><a name="l01416"></a><span class="lineno"> 1416</span>&#160;      <span class="keywordflow">if</span> (eprbs[m] &lt; 0.)        <span class="comment">//test (can be deleted eventually SS)</span></div><div class="line"><a name="l01417"></a><span class="lineno"> 1417</span>&#160;      {</div><div class="line"><a name="l01418"></a><span class="lineno"> 1418</span>&#160;        <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;Negative probability (matom, 4). Abort.&quot;</span>);</div><div class="line"><a name="l01419"></a><span class="lineno"> 1419</span>&#160;        exit (0);</div><div class="line"><a name="l01420"></a><span class="lineno"> 1420</span>&#160;      }</div><div class="line"><a name="l01421"></a><span class="lineno"> 1421</span>&#160;      penorm += eprbs[m];</div><div class="line"><a name="l01422"></a><span class="lineno"> 1422</span>&#160;    }</div><div class="line"><a name="l01423"></a><span class="lineno"> 1423</span>&#160;    m++;</div><div class="line"><a name="l01424"></a><span class="lineno"> 1424</span>&#160;  }</div><div class="line"><a name="l01425"></a><span class="lineno"> 1425</span>&#160;</div><div class="line"><a name="l01426"></a><span class="lineno"> 1426</span>&#160;</div><div class="line"><a name="l01427"></a><span class="lineno"> 1427</span>&#160;</div><div class="line"><a name="l01428"></a><span class="lineno"> 1428</span>&#160;  <span class="comment">/* No need for upwards jumps - they don&#39;t provide emission mechanisms. */</span></div><div class="line"><a name="l01429"></a><span class="lineno"> 1429</span>&#160;</div><div class="line"><a name="l01430"></a><span class="lineno"> 1430</span>&#160;  <span class="comment">/* Probabilities of emission (e) are now known. The normalisation factor pnorm has</span></div><div class="line"><a name="l01431"></a><span class="lineno"> 1431</span>&#160;<span class="comment">     also been recorded. the integer m now gives the total number of possibilities too. </span></div><div class="line"><a name="l01432"></a><span class="lineno"> 1432</span>&#160;<span class="comment">     now select what happens next. Start by choosing the random threshold value at which the</span></div><div class="line"><a name="l01433"></a><span class="lineno"> 1433</span>&#160;<span class="comment">     event will occur. */</span></div><div class="line"><a name="l01434"></a><span class="lineno"> 1434</span>&#160;</div><div class="line"><a name="l01435"></a><span class="lineno"> 1435</span>&#160;<span class="comment">//  threshold = ((rand () + 0.5) / MAXRAND); DONE</span></div><div class="line"><a name="l01436"></a><span class="lineno"> 1436</span>&#160;  threshold = <a class="code" href="foo_8h.html#a451b4740f3d1e12cb07885b0d3e5ef1b">random_number</a>(0.0,1.0);</div><div class="line"><a name="l01437"></a><span class="lineno"> 1437</span>&#160;  </div><div class="line"><a name="l01438"></a><span class="lineno"> 1438</span>&#160;</div><div class="line"><a name="l01439"></a><span class="lineno"> 1439</span>&#160;  run_tot = 0;</div><div class="line"><a name="l01440"></a><span class="lineno"> 1440</span>&#160;  n = 0;</div><div class="line"><a name="l01441"></a><span class="lineno"> 1441</span>&#160;  threshold = threshold * penorm;       <span class="comment">//normalise to total emission prob.</span></div><div class="line"><a name="l01442"></a><span class="lineno"> 1442</span>&#160;  <span class="keywordflow">while</span> (run_tot &lt; threshold)</div><div class="line"><a name="l01443"></a><span class="lineno"> 1443</span>&#160;  {</div><div class="line"><a name="l01444"></a><span class="lineno"> 1444</span>&#160;    run_tot += eprbs[<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>];</div><div class="line"><a name="l01445"></a><span class="lineno"> 1445</span>&#160;    n++;</div><div class="line"><a name="l01446"></a><span class="lineno"> 1446</span>&#160;  }</div><div class="line"><a name="l01447"></a><span class="lineno"> 1447</span>&#160;  n = n - 1;</div><div class="line"><a name="l01448"></a><span class="lineno"> 1448</span>&#160;  <span class="comment">/* n now identifies the jump that occurs - now set nres for the return value. */</span></div><div class="line"><a name="l01449"></a><span class="lineno"> 1449</span>&#160;  <span class="keywordflow">if</span> (n &lt; nbbd)</div><div class="line"><a name="l01450"></a><span class="lineno"> 1450</span>&#160;  {                             <span class="comment">/* bb downwards */</span></div><div class="line"><a name="l01451"></a><span class="lineno"> 1451</span>&#160;    line_ptr = &amp;<a class="code" href="atomic_8h.html#a1df743c9da06da92232eff98af40239a">line</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a4d26c780eab93bd42aeefef3ddc9fcda">bbd_jump</a>[<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>]];        <span class="comment">//pointer for the bb transition</span></div><div class="line"><a name="l01452"></a><span class="lineno"> 1452</span>&#160;    *<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a> = <a class="code" href="atomic_8h.html#a1df743c9da06da92232eff98af40239a">line</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a4d26c780eab93bd42aeefef3ddc9fcda">bbd_jump</a>[<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>]].<a class="code" href="structlines.html#a21eb2458dc558a817e715ca184cf8bb5">where_in_list</a>;</div><div class="line"><a name="l01453"></a><span class="lineno"> 1453</span>&#160;    p-&gt;<a class="code" href="structphoton.html#a98c6d400814a43aeda7d7fd1ed2d7dc6">freq</a> = <a class="code" href="atomic_8h.html#a1df743c9da06da92232eff98af40239a">line</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a4d26c780eab93bd42aeefef3ddc9fcda">bbd_jump</a>[<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>]].<a class="code" href="structlines.html#a4d74840df54d02617c21c66b2498a81c">freq</a>;</div><div class="line"><a name="l01454"></a><span class="lineno"> 1454</span>&#160;    <span class="comment">/* This is the comoving frequency - changed to rest frequency by doppler */</span></div><div class="line"><a name="l01455"></a><span class="lineno"> 1455</span>&#160;  }</div><div class="line"><a name="l01456"></a><span class="lineno"> 1456</span>&#160;  <span class="keywordflow">else</span> <span class="keywordflow">if</span> (n &lt; (nbbd + nbfd))</div><div class="line"><a name="l01457"></a><span class="lineno"> 1457</span>&#160;  {                             <span class="comment">/* bf downwards jump */</span></div><div class="line"><a name="l01458"></a><span class="lineno"> 1458</span>&#160;    *<a class="code" href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a> = <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a20d66fef678daa8ef52c0b933546e16a">bfd_jump</a>[n - nbbd] + <a class="code" href="atomic_8h.html#a59990369239024c94cbe22080c9d29c3">NLINES</a> + 1;</div><div class="line"><a name="l01459"></a><span class="lineno"> 1459</span>&#160;    <span class="comment">/* continuua are indicated by nres &gt; NLINES */</span></div><div class="line"><a name="l01460"></a><span class="lineno"> 1460</span>&#160;<span class="comment">//    p-&gt;freq = phot_top[config[uplvl].bfd_jump[n - nbbd]].freq[0] - (log (1. - (rand () + 0.5) / MAXRAND) * t_e / H_OVER_K); DONE</span></div><div class="line"><a name="l01461"></a><span class="lineno"> 1461</span>&#160;    p-&gt;<a class="code" href="structphoton.html#a98c6d400814a43aeda7d7fd1ed2d7dc6">freq</a> = <a class="code" href="atomic_8h.html#aed5961eebbc0ca048e57fe2ad4cdfab8">phot_top</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a20d66fef678daa8ef52c0b933546e16a">bfd_jump</a>[n - nbbd]].<a class="code" href="structtopbase__phot.html#a18d8d6eeb8df6e8ad2f89550c6b86310">freq</a>[0] - (log (1. - <a class="code" href="foo_8h.html#a451b4740f3d1e12cb07885b0d3e5ef1b">random_number</a>(0.0,1.0)) * t_e / <a class="code" href="atomic_8h.html#a97148aa86d99b11c881e5f32845861d4">H_OVER_K</a>);</div><div class="line"><a name="l01462"></a><span class="lineno"> 1462</span>&#160;    </div><div class="line"><a name="l01463"></a><span class="lineno"> 1463</span>&#160;    <span class="comment">/* Co-moving frequency - changed to rest frequency by doppler */</span></div><div class="line"><a name="l01464"></a><span class="lineno"> 1464</span>&#160;    <span class="comment">/*Currently this assumed hydrogenic shape cross-section - Improve */</span></div><div class="line"><a name="l01465"></a><span class="lineno"> 1465</span>&#160;  }</div><div class="line"><a name="l01466"></a><span class="lineno"> 1466</span>&#160;  <span class="keywordflow">else</span></div><div class="line"><a name="l01467"></a><span class="lineno"> 1467</span>&#160;  {</div><div class="line"><a name="l01468"></a><span class="lineno"> 1468</span>&#160;    <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;Trying to emit from Macro Atom but no available route (emit_matom). Abort.&quot;</span>);</div><div class="line"><a name="l01469"></a><span class="lineno"> 1469</span>&#160;    exit (0);</div><div class="line"><a name="l01470"></a><span class="lineno"> 1470</span>&#160;  }</div><div class="line"><a name="l01471"></a><span class="lineno"> 1471</span>&#160;  <span class="keywordflow">return</span> (0);</div><div class="line"><a name="l01472"></a><span class="lineno"> 1472</span>&#160;}</div><div class="line"><a name="l01473"></a><span class="lineno"> 1473</span>&#160;</div><div class="line"><a name="l01474"></a><span class="lineno"> 1474</span>&#160;<span class="comment">/* The frequency and the value of nres have been set correctly. All done. */</span></div><div class="line"><a name="l01475"></a><span class="lineno"> 1475</span>&#160;</div><div class="line"><a name="l01476"></a><span class="lineno"> 1476</span>&#160;</div><div class="line"><a name="l01477"></a><span class="lineno"> 1477</span>&#160;</div><div class="line"><a name="l01478"></a><span class="lineno"> 1478</span>&#160;</div><div class="line"><a name="l01479"></a><span class="lineno"> 1479</span>&#160;</div><div class="line"><a name="l01480"></a><span class="lineno"> 1480</span>&#160;</div><div class="line"><a name="l01481"></a><span class="lineno"> 1481</span>&#160;</div><div class="line"><a name="l01482"></a><span class="lineno"> 1482</span>&#160;<span class="comment">/**********************************************************/</span></div><div class="line"><a name="l01496"></a><span class="lineno"> 1496</span>&#160;<span class="keywordtype">double</span></div><div class="line"><a name="l01497"></a><span class="lineno"><a class="line" href="templates_8h.html#ac60407b8b44d5a57ec6c89122058dcf7"> 1497</a></span>&#160;<a class="code" href="matom_8c.html#ac60407b8b44d5a57ec6c89122058dcf7">matom_emit_in_line_prob</a> (<a class="code" href="structwind.html">WindPtr</a> one, <span class="keyword">struct</span> <a class="code" href="structlines.html">lines</a> *line_ptr_emit)</div><div class="line"><a name="l01498"></a><span class="lineno"> 1498</span>&#160;{</div><div class="line"><a name="l01499"></a><span class="lineno"> 1499</span>&#160;  <span class="keywordtype">double</span> eprbs, eprbs_line;</div><div class="line"><a name="l01500"></a><span class="lineno"> 1500</span>&#160;  <span class="keyword">struct </span><a class="code" href="structlines.html">lines</a> *line_ptr;</div><div class="line"><a name="l01501"></a><span class="lineno"> 1501</span>&#160;  <span class="keyword">struct </span><a class="code" href="structtopbase__phot.html">topbase_phot</a> *cont_ptr;</div><div class="line"><a name="l01502"></a><span class="lineno"> 1502</span>&#160;  <span class="keywordtype">int</span> uplvl;</div><div class="line"><a name="l01503"></a><span class="lineno"> 1503</span>&#160;  <span class="keywordtype">double</span> <a class="code" href="matom_8c.html#a53e97649d5cd9a1fab024ab99489ddb1">alpha_sp</a> ();</div><div class="line"><a name="l01504"></a><span class="lineno"> 1504</span>&#160;  <span class="keywordtype">double</span> penorm, freqmax, freqmin;</div><div class="line"><a name="l01505"></a><span class="lineno"> 1505</span>&#160;  <span class="keywordtype">double</span> sp_rec_rate;</div><div class="line"><a name="l01506"></a><span class="lineno"> 1506</span>&#160;  <span class="keywordtype">int</span> <a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>;</div><div class="line"><a name="l01507"></a><span class="lineno"> 1507</span>&#160;  <span class="keywordtype">int</span> nbbd, nbfd;</div><div class="line"><a name="l01508"></a><span class="lineno"> 1508</span>&#160;  <span class="keywordtype">double</span> ne;</div><div class="line"><a name="l01509"></a><span class="lineno"> 1509</span>&#160;  <span class="keywordtype">double</span> bb_cont;</div><div class="line"><a name="l01510"></a><span class="lineno"> 1510</span>&#160;  <a class="code" href="structplasma.html">PlasmaPtr</a> <a class="code" href="compton_8c.html#ad65f0d74fe764d3ecae5ec1a89d63f08">xplasma</a>;</div><div class="line"><a name="l01511"></a><span class="lineno"> 1511</span>&#160;</div><div class="line"><a name="l01512"></a><span class="lineno"> 1512</span>&#160;  xplasma = &amp;<a class="code" href="python_8h.html#af5711847369600743b86dd27343fab7a">plasmamain</a>[one-&gt;<a class="code" href="structwind.html#ae01b6d799a4f0a60142703606c9fea3c">nplasma</a>];</div><div class="line"><a name="l01513"></a><span class="lineno"> 1513</span>&#160;  ne = xplasma-&gt;<a class="code" href="structplasma.html#ac1d38c3e4cc4ef2a1e4d83d7f8b71d22">ne</a>;             <span class="comment">//electron number density</span></div><div class="line"><a name="l01514"></a><span class="lineno"> 1514</span>&#160;</div><div class="line"><a name="l01515"></a><span class="lineno"> 1515</span>&#160;</div><div class="line"><a name="l01516"></a><span class="lineno"> 1516</span>&#160;  <span class="comment">//We know the line we&#39;re de-exciting into, so find the upper level of this line</span></div><div class="line"><a name="l01517"></a><span class="lineno"> 1517</span>&#160;  uplvl = line_ptr_emit-&gt;<a class="code" href="structlines.html#a96fff3bddbfd451e708fe60b9b495784">nconfigu</a>;</div><div class="line"><a name="l01518"></a><span class="lineno"> 1518</span>&#160;</div><div class="line"><a name="l01519"></a><span class="lineno"> 1519</span>&#160;</div><div class="line"><a name="l01520"></a><span class="lineno"> 1520</span>&#160;  <span class="comment">//Now find the number of jumps available from this level</span></div><div class="line"><a name="l01521"></a><span class="lineno"> 1521</span>&#160;  nbbd = <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#ade544b4d373e9e586f689a19330037ec">n_bbd_jump</a>;      <span class="comment">//store these for easy access -- number of bb downward jumps</span></div><div class="line"><a name="l01522"></a><span class="lineno"> 1522</span>&#160;  nbfd = <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#acfee0b128e4e7c2a4e6aea0687a233d9">n_bfd_jump</a>;      <span class="comment">// number of bf downared jumps from this transition</span></div><div class="line"><a name="l01523"></a><span class="lineno"> 1523</span>&#160;</div><div class="line"><a name="l01524"></a><span class="lineno"> 1524</span>&#160;  <span class="comment">// Start by setting everything to 0</span></div><div class="line"><a name="l01525"></a><span class="lineno"> 1525</span>&#160;  penorm = 0.0;                 <span class="comment">//stores the total emission probability</span></div><div class="line"><a name="l01526"></a><span class="lineno"> 1526</span>&#160;  eprbs_line = 0.0;</div><div class="line"><a name="l01527"></a><span class="lineno"> 1527</span>&#160;  <span class="comment">/* Finished zeroing. */</span></div><div class="line"><a name="l01528"></a><span class="lineno"> 1528</span>&#160;</div><div class="line"><a name="l01529"></a><span class="lineno"> 1529</span>&#160;  <span class="comment">// Set frequency range to search to be the spectral range</span></div><div class="line"><a name="l01530"></a><span class="lineno"> 1530</span>&#160;  freqmin = <a class="code" href="atomic_8h.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a> / (<a class="code" href="python_8h.html#a3a571e0bd4220490c5c5bd86f51c83ba">geo</a>.<a class="code" href="structgeometry.html#a140530983e750dba228f9cd27d12000f">swavemax</a> * 1e-8);</div><div class="line"><a name="l01531"></a><span class="lineno"> 1531</span>&#160;  freqmax = <a class="code" href="atomic_8h.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a> / (<a class="code" href="python_8h.html#a3a571e0bd4220490c5c5bd86f51c83ba">geo</a>.<a class="code" href="structgeometry.html#abc10c324e776f2bf8c809096402ecb75">swavemin</a> * 1e-8);</div><div class="line"><a name="l01532"></a><span class="lineno"> 1532</span>&#160;</div><div class="line"><a name="l01533"></a><span class="lineno"> 1533</span>&#160;  <span class="comment">/* bb */</span></div><div class="line"><a name="l01534"></a><span class="lineno"> 1534</span>&#160;  <span class="comment">/* First downward jumps. */</span></div><div class="line"><a name="l01535"></a><span class="lineno"> 1535</span>&#160;  <span class="keywordflow">for</span> (n = 0; n &lt; nbbd; n++)</div><div class="line"><a name="l01536"></a><span class="lineno"> 1536</span>&#160;  {</div><div class="line"><a name="l01537"></a><span class="lineno"> 1537</span>&#160;    line_ptr = &amp;<a class="code" href="atomic_8h.html#a1df743c9da06da92232eff98af40239a">line</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a4d26c780eab93bd42aeefef3ddc9fcda">bbd_jump</a>[<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>]];</div><div class="line"><a name="l01538"></a><span class="lineno"> 1538</span>&#160;    <span class="comment">/* Since we are only interested in making an r-packet here we can (a) ignore collisional</span></div><div class="line"><a name="l01539"></a><span class="lineno"> 1539</span>&#160;<span class="comment">       deactivation and (b) ignore lines outside the frequency range of interest. */</span></div><div class="line"><a name="l01540"></a><span class="lineno"> 1540</span>&#160;    <span class="keywordflow">if</span> ((line_ptr-&gt;<a class="code" href="structlines.html#a4d74840df54d02617c21c66b2498a81c">freq</a> &gt; freqmin) &amp;&amp; (line_ptr-&gt;<a class="code" href="structlines.html#a4d74840df54d02617c21c66b2498a81c">freq</a> &lt; freqmax))       <span class="comment">// correct range</span></div><div class="line"><a name="l01541"></a><span class="lineno"> 1541</span>&#160;    {</div><div class="line"><a name="l01542"></a><span class="lineno"> 1542</span>&#160;      bb_cont = (<a class="code" href="atomic_8c.html#a8c589bd3089b7851e8da407ad1ce44a5">a21</a> (line_ptr) * <a class="code" href="foo_8h.html#a3579026b8eac7743ef56ad21ff9696ff">p_escape</a> (line_ptr, xplasma));</div><div class="line"><a name="l01543"></a><span class="lineno"> 1543</span>&#160;      eprbs = bb_cont * (<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a7759058c9db6702f3e3cefa8c2506110">ex</a> - <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[<a class="code" href="atomic_8h.html#a1df743c9da06da92232eff98af40239a">line</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a4d26c780eab93bd42aeefef3ddc9fcda">bbd_jump</a>[<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>]].<a class="code" href="structlines.html#aa570454ab15c3c7d4324b54a254daf05">nconfigl</a>].<a class="code" href="structconfigurations.html#a7759058c9db6702f3e3cefa8c2506110">ex</a>);       <span class="comment">//energy difference</span></div><div class="line"><a name="l01544"></a><span class="lineno"> 1544</span>&#160;      penorm += eprbs;</div><div class="line"><a name="l01545"></a><span class="lineno"> 1545</span>&#160;      <span class="keywordflow">if</span> (line_ptr == line_ptr_emit)</div><div class="line"><a name="l01546"></a><span class="lineno"> 1546</span>&#160;      {</div><div class="line"><a name="l01547"></a><span class="lineno"> 1547</span>&#160;        eprbs_line = eprbs;</div><div class="line"><a name="l01548"></a><span class="lineno"> 1548</span>&#160;      }</div><div class="line"><a name="l01549"></a><span class="lineno"> 1549</span>&#160;    }</div><div class="line"><a name="l01550"></a><span class="lineno"> 1550</span>&#160;  }</div><div class="line"><a name="l01551"></a><span class="lineno"> 1551</span>&#160;</div><div class="line"><a name="l01552"></a><span class="lineno"> 1552</span>&#160;  <span class="keywordflow">if</span> (eprbs_line == 0.0)</div><div class="line"><a name="l01553"></a><span class="lineno"> 1553</span>&#160;  {</div><div class="line"><a name="l01554"></a><span class="lineno"> 1554</span>&#160;    <a class="code" href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a> (<span class="stringliteral">&quot;matom_emit_in_line_prob: Line frequency %g lies outside spectral range %g-%g!\n&quot;</span>, line_ptr-&gt;<a class="code" href="structlines.html#a4d74840df54d02617c21c66b2498a81c">freq</a>, <a class="code" href="python_8h.html#a740c6412880dd24768165a351bb9b214">em_rnge</a>.<a class="code" href="structemiss__range.html#ae32bcc0c5aa7a7f15c63cee741f1f2b0">fmin</a>, <a class="code" href="python_8h.html#a740c6412880dd24768165a351bb9b214">em_rnge</a>.<a class="code" href="structemiss__range.html#ac6c5df2b3f9dd4eb3bc729feac39ae2d">fmax</a>);</div><div class="line"><a name="l01555"></a><span class="lineno"> 1555</span>&#160;    <span class="keywordflow">return</span> (-1.0);</div><div class="line"><a name="l01556"></a><span class="lineno"> 1556</span>&#160;  }</div><div class="line"><a name="l01557"></a><span class="lineno"> 1557</span>&#160;</div><div class="line"><a name="l01558"></a><span class="lineno"> 1558</span>&#160;  <span class="comment">/* bf */</span></div><div class="line"><a name="l01559"></a><span class="lineno"> 1559</span>&#160;  <span class="comment">/* There should be no bf jumps for Ha/Hb but included for potential use for other lines */</span></div><div class="line"><a name="l01560"></a><span class="lineno"> 1560</span>&#160;  <span class="keywordflow">for</span> (n = 0; n &lt; nbfd; n++)</div><div class="line"><a name="l01561"></a><span class="lineno"> 1561</span>&#160;  {</div><div class="line"><a name="l01562"></a><span class="lineno"> 1562</span>&#160;    cont_ptr = &amp;<a class="code" href="atomic_8h.html#aed5961eebbc0ca048e57fe2ad4cdfab8">phot_top</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a20d66fef678daa8ef52c0b933546e16a">bfd_jump</a>[<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>]];    <span class="comment">//pointer to continuum</span></div><div class="line"><a name="l01563"></a><span class="lineno"> 1563</span>&#160;</div><div class="line"><a name="l01564"></a><span class="lineno"> 1564</span>&#160;    <span class="comment">/* If the edge is above the frequency range we are interested in then we need not consider this</span></div><div class="line"><a name="l01565"></a><span class="lineno"> 1565</span>&#160;<span class="comment">       bf process. */</span></div><div class="line"><a name="l01566"></a><span class="lineno"> 1566</span>&#160;    <span class="keywordflow">if</span> (cont_ptr-&gt;<a class="code" href="structtopbase__phot.html#a18d8d6eeb8df6e8ad2f89550c6b86310">freq</a>[0] &lt; freqmax)    <span class="comment">//means that it may contribute</span></div><div class="line"><a name="l01567"></a><span class="lineno"> 1567</span>&#160;    {</div><div class="line"><a name="l01568"></a><span class="lineno"> 1568</span>&#160;      sp_rec_rate = <a class="code" href="matom_8c.html#a53e97649d5cd9a1fab024ab99489ddb1">alpha_sp</a> (cont_ptr, xplasma, 0);</div><div class="line"><a name="l01569"></a><span class="lineno"> 1569</span>&#160;      eprbs = sp_rec_rate * ne * (<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a7759058c9db6702f3e3cefa8c2506110">ex</a> - <a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[<a class="code" href="atomic_8h.html#aed5961eebbc0ca048e57fe2ad4cdfab8">phot_top</a>[<a class="code" href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a>[uplvl].<a class="code" href="structconfigurations.html#a20d66fef678daa8ef52c0b933546e16a">bfd_jump</a>[<a class="code" href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">n</a>]].<a class="code" href="structtopbase__phot.html#ae51ac7fd7f3c120cf7eb188b207b824f">nlev</a>].<a class="code" href="structconfigurations.html#a7759058c9db6702f3e3cefa8c2506110">ex</a>);      <span class="comment">//energy difference</span></div><div class="line"><a name="l01570"></a><span class="lineno"> 1570</span>&#160;      penorm += eprbs;</div><div class="line"><a name="l01571"></a><span class="lineno"> 1571</span>&#160;    }</div><div class="line"><a name="l01572"></a><span class="lineno"> 1572</span>&#160;  }</div><div class="line"><a name="l01573"></a><span class="lineno"> 1573</span>&#160;  <span class="comment">//We now have the total probability of all avenues the matom could de-excite into</span></div><div class="line"><a name="l01574"></a><span class="lineno"> 1574</span>&#160;</div><div class="line"><a name="l01575"></a><span class="lineno"> 1575</span>&#160;  <span class="comment">//Return probability that the matom in this cell de-excites into this line</span></div><div class="line"><a name="l01576"></a><span class="lineno"> 1576</span>&#160;  <span class="keywordflow">return</span> (eprbs_line / penorm);</div><div class="line"><a name="l01577"></a><span class="lineno"> 1577</span>&#160;}</div><div class="ttc" id="structtopbase__phot_html_a6fcc6201c5227485532cd3283bc596c5"><div class="ttname"><a href="structtopbase__phot.html#a6fcc6201c5227485532cd3283bc596c5">topbase_phot::istate</a></div><div class="ttdeci">int istate</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00335">atomic.h:335</a></div></div>
<div class="ttc" id="structconfigurations_html_a8942d3fe089878881187ced90e2ccc5e"><div class="ttname"><a href="structconfigurations.html#a8942d3fe089878881187ced90e2ccc5e">configurations::bfu_indx_first</a></div><div class="ttdeci">int bfu_indx_first</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00208">atomic.h:208</a></div></div>
<div class="ttc" id="structlines_html_a0e2eb51cd04b7d4bbc112e63d1744a9f"><div class="ttname"><a href="structlines.html#a0e2eb51cd04b7d4bbc112e63d1744a9f">lines::gu</a></div><div class="ttdeci">double gu</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00226">atomic.h:226</a></div></div>
<div class="ttc" id="structtopbase__phot_html_a2c145af1ccb60672e5c8c2925961ea2f"><div class="ttname"><a href="structtopbase__phot.html#a2c145af1ccb60672e5c8c2925961ea2f">topbase_phot::z</a></div><div class="ttdeci">int z</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00335">atomic.h:335</a></div></div>
<div class="ttc" id="matom_8c_html_ac60407b8b44d5a57ec6c89122058dcf7"><div class="ttname"><a href="matom_8c.html#ac60407b8b44d5a57ec6c89122058dcf7">matom_emit_in_line_prob</a></div><div class="ttdeci">double matom_emit_in_line_prob(WindPtr one, struct lines *line_ptr_emit)</div><div class="ttdoc">Prob. of cell emitting in a given line. </div><div class="ttdef"><b>Definition:</b> <a href="matom_8c_source.html#l01497">matom.c:1497</a></div></div>
<div class="ttc" id="python_8h_html_a740c6412880dd24768165a351bb9b214"><div class="ttname"><a href="python_8h.html#a740c6412880dd24768165a351bb9b214">em_rnge</a></div><div class="ttdeci">struct emiss_range em_rnge</div></div>
<div class="ttc" id="atomic_8h_html_a97148aa86d99b11c881e5f32845861d4"><div class="ttname"><a href="atomic_8h.html#a97148aa86d99b11c881e5f32845861d4">H_OVER_K</a></div><div class="ttdeci">#define H_OVER_K</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00015">atomic.h:15</a></div></div>
<div class="ttc" id="structmacro_html_a8e77cd87d57475d0c53aab45ad0e78cf"><div class="ttname"><a href="structmacro.html#a8e77cd87d57475d0c53aab45ad0e78cf">macro::cooling_adiabatic</a></div><div class="ttdeci">double cooling_adiabatic</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00981">python.h:981</a></div></div>
<div class="ttc" id="atomic_8h_html_af69ee38d2c862dbc6769fa27c5320b96"><div class="ttname"><a href="atomic_8h.html#af69ee38d2c862dbc6769fa27c5320b96">nlines</a></div><div class="ttdeci">int nlines</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00065">atomic.h:65</a></div></div>
<div class="ttc" id="log_8h_html_a9a25be4f0d7d13fccc8457774d74167f"><div class="ttname"><a href="log_8h.html#a9a25be4f0d7d13fccc8457774d74167f">Log</a></div><div class="ttdeci">int Log(char *format,...)</div><div class="ttdoc">Print/write an informational message. </div><div class="ttdef"><b>Definition:</b> <a href="xlog_8c_source.html#l00325">xlog.c:325</a></div></div>
<div class="ttc" id="matom_8c_html_a2838268e309f2158a6c2948c92a299f9"><div class="ttname"><a href="matom_8c.html#a2838268e309f2158a6c2948c92a299f9">b12_line_ptr</a></div><div class="ttdeci">struct lines * b12_line_ptr</div><div class="ttdef"><b>Definition:</b> <a href="matom_8c_source.html#l00526">matom.c:526</a></div></div>
<div class="ttc" id="structplasma_html_a8220b5d466addc895b973f092d9b7b15"><div class="ttname"><a href="structplasma.html#a8220b5d466addc895b973f092d9b7b15">plasma::nplasma</a></div><div class="ttdeci">int nplasma</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00740">python.h:740</a></div></div>
<div class="ttc" id="matom_8c_html_a55d2fd6a10cba375e78a3045d99d7714"><div class="ttname"><a href="matom_8c.html#a55d2fd6a10cba375e78a3045d99d7714">temp_choice</a></div><div class="ttdeci">int temp_choice</div><div class="ttdef"><b>Definition:</b> <a href="matom_8c_source.html#l00552">matom.c:552</a></div></div>
<div class="ttc" id="atomic_8h_html_ad8512644399ac6ec00af8f727bb4fac6"><div class="ttname"><a href="atomic_8h.html#ad8512644399ac6ec00af8f727bb4fac6">VERY_BIG</a></div><div class="ttdeci">#define VERY_BIG</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00003">atomic.h:3</a></div></div>
<div class="ttc" id="structmacro_html_a13217cd83bb2aff404860f1eea75d18e"><div class="ttname"><a href="structmacro.html#a13217cd83bb2aff404860f1eea75d18e">macro::recomb_sp_e</a></div><div class="ttdeci">double * recomb_sp_e</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00958">python.h:958</a></div></div>
<div class="ttc" id="atomic_8h_html_a8c1d70d2c39e64a6cc16b6132d86c044"><div class="ttname"><a href="atomic_8h.html#a8c1d70d2c39e64a6cc16b6132d86c044">lin_ptr</a></div><div class="ttdeci">LinePtr lin_ptr[NLINES]</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00253">atomic.h:253</a></div></div>
<div class="ttc" id="emission_8c_html_af59091ae76131213b5c23a085d88eb1d"><div class="ttname"><a href="emission_8c.html#af59091ae76131213b5c23a085d88eb1d">one_ff</a></div><div class="ttdeci">double one_ff(WindPtr one, double f1, double f2)</div><div class="ttdoc">randomly generate the frequency of a ff photon within the frequency interval f1 and f2 ...</div><div class="ttdef"><b>Definition:</b> <a href="emission_8c_source.html#l00680">emission.c:680</a></div></div>
<div class="ttc" id="atomic_8h_html_a27e1e039bca1d64c21caa972e1111c09"><div class="ttname"><a href="atomic_8h.html#a27e1e039bca1d64c21caa972e1111c09">NBBJUMPS</a></div><div class="ttdeci">#define NBBJUMPS</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00072">atomic.h:72</a></div></div>
<div class="ttc" id="atomic_8h_html_a15a303809550342a407548de2ef7c245"><div class="ttname"><a href="atomic_8h.html#a15a303809550342a407548de2ef7c245">nphot_total</a></div><div class="ttdeci">int nphot_total</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00327">atomic.h:327</a></div></div>
<div class="ttc" id="structwind_html_ae01b6d799a4f0a60142703606c9fea3c"><div class="ttname"><a href="structwind.html#ae01b6d799a4f0a60142703606c9fea3c">wind::nplasma</a></div><div class="ttdeci">int nplasma</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00696">python.h:696</a></div></div>
<div class="ttc" id="matom_8c_html_a5d003db13b4f257723500c23bee10b90"><div class="ttname"><a href="matom_8c.html#a5d003db13b4f257723500c23bee10b90">ALPHA_SP_CONSTANT</a></div><div class="ttdeci">#define ALPHA_SP_CONSTANT</div><div class="ttdoc">the matom estimator for the spontaneous recombination rate. </div><div class="ttdef"><b>Definition:</b> <a href="matom_8c_source.html#l00581">matom.c:581</a></div></div>
<div class="ttc" id="structemiss__range_html_ac6c5df2b3f9dd4eb3bc729feac39ae2d"><div class="ttname"><a href="structemiss__range.html#ac6c5df2b3f9dd4eb3bc729feac39ae2d">emiss_range::fmax</a></div><div class="ttdeci">double fmax</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l01310">python.h:1310</a></div></div>
<div class="ttc" id="emission_8c_html_a1f0ea4ec7ad9218a9eb0ca03a4fc6f5d"><div class="ttname"><a href="emission_8c.html#a1f0ea4ec7ad9218a9eb0ca03a4fc6f5d">total_free</a></div><div class="ttdeci">double total_free(WindPtr one, double t_e, double f1, double f2)</div><div class="ttdoc">calculates the band-limited ff luminosity of a cell. </div><div class="ttdef"><b>Definition:</b> <a href="emission_8c_source.html#l00491">emission.c:491</a></div></div>
<div class="ttc" id="structplasma_html_a469869b2b7b2a822716ac5a3ba58412a"><div class="ttname"><a href="structplasma.html#a469869b2b7b2a822716ac5a3ba58412a">plasma::vol</a></div><div class="ttdeci">double vol</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00743">python.h:743</a></div></div>
<div class="ttc" id="compton_8c_html_ad65f0d74fe764d3ecae5ec1a89d63f08"><div class="ttname"><a href="compton_8c.html#ad65f0d74fe764d3ecae5ec1a89d63f08">xplasma</a></div><div class="ttdeci">PlasmaPtr xplasma</div><div class="ttdef"><b>Definition:</b> <a href="compton_8c_source.html#l00019">compton.c:19</a></div></div>
<div class="ttc" id="structmacro_html_ab0671cf0f286d0fc484da2b0894df5bf"><div class="ttname"><a href="structmacro.html#ab0671cf0f286d0fc484da2b0894df5bf">macro::cooling_bftot</a></div><div class="ttdeci">double cooling_bftot</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00979">python.h:979</a></div></div>
<div class="ttc" id="structlines_html_a21eb2458dc558a817e715ca184cf8bb5"><div class="ttname"><a href="structlines.html#a21eb2458dc558a817e715ca184cf8bb5">lines::where_in_list</a></div><div class="ttdeci">int where_in_list</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00240">atomic.h:240</a></div></div>
<div class="ttc" id="structlines_html_a4d74840df54d02617c21c66b2498a81c"><div class="ttname"><a href="structlines.html#a4d74840df54d02617c21c66b2498a81c">lines::freq</a></div><div class="ttdeci">double freq</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00235">atomic.h:235</a></div></div>
<div class="ttc" id="structconfigurations_html_a20d66fef678daa8ef52c0b933546e16a"><div class="ttname"><a href="structconfigurations.html#a20d66fef678daa8ef52c0b933546e16a">configurations::bfd_jump</a></div><div class="ttdeci">int bfd_jump[NBFJUMPS]</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00206">atomic.h:206</a></div></div>
<div class="ttc" id="foo_8h_html_a6daa97078321cf4f668d31b7004fed6c"><div class="ttname"><a href="foo_8h.html#a6daa97078321cf4f668d31b7004fed6c">q21</a></div><div class="ttdeci">double q21(struct lines *line_ptr, double t)</div><div class="ttdoc">calculates and returns the collisional de-excitation coefficient q21 </div><div class="ttdef"><b>Definition:</b> <a href="lines_8c_source.html#l00224">lines.c:224</a></div></div>
<div class="ttc" id="foo_8h_html_a3579026b8eac7743ef56ad21ff9696ff"><div class="ttname"><a href="foo_8h.html#a3579026b8eac7743ef56ad21ff9696ff">p_escape</a></div><div class="ttdeci">double p_escape(struct lines *line_ptr, PlasmaPtr xplasma)</div><div class="ttdoc">Estimate the esccapte probability for a line in a plasma cell. </div><div class="ttdef"><b>Definition:</b> <a href="lines_8c_source.html#l00773">lines.c:773</a></div></div>
<div class="ttc" id="structmacro_html_a344b8e9e0f658f06e2397bd4880caf58"><div class="ttname"><a href="structmacro.html#a344b8e9e0f658f06e2397bd4880caf58">macro::cooling_bb</a></div><div class="ttdeci">double * cooling_bb</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00974">python.h:974</a></div></div>
<div class="ttc" id="structmacro_html_a85eac8200ef941e212d8c6b8d0bbf8cf"><div class="ttname"><a href="structmacro.html#a85eac8200ef941e212d8c6b8d0bbf8cf">macro::cooling_bbtot</a></div><div class="ttdeci">double cooling_bbtot</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00979">python.h:979</a></div></div>
<div class="ttc" id="structlines_html_a5165d0546a6f5fa57612a4476d2b5ab9"><div class="ttname"><a href="structlines.html#a5165d0546a6f5fa57612a4476d2b5ab9">lines::gl</a></div><div class="ttdeci">double gl</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00226">atomic.h:226</a></div></div>
<div class="ttc" id="python_8h_html_a0453c2160b73529f8d858dccfc85aad5"><div class="ttname"><a href="python_8h.html#a0453c2160b73529f8d858dccfc85aad5">macromain</a></div><div class="ttdeci">MacroPtr macromain</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00986">python.h:986</a></div></div>
<div class="ttc" id="structphoton_html_adf0be64e948d68d787555681d15e13e2"><div class="ttname"><a href="structphoton.html#adf0be64e948d68d787555681d15e13e2">photon::istat</a></div><div class="ttdeci">enum photon::istat_enum istat</div></div>
<div class="ttc" id="structconfigurations_html_acfee0b128e4e7c2a4e6aea0687a233d9"><div class="ttname"><a href="structconfigurations.html#acfee0b128e4e7c2a4e6aea0687a233d9">configurations::n_bfd_jump</a></div><div class="ttdeci">int n_bfd_jump</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00198">atomic.h:198</a></div></div>
<div class="ttc" id="structconfigurations_html_abc158a8d23c5630e6eedf3a1866af30c"><div class="ttname"><a href="structconfigurations.html#abc158a8d23c5630e6eedf3a1866af30c">configurations::bfd_indx_first</a></div><div class="ttdeci">int bfd_indx_first</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00209">atomic.h:209</a></div></div>
<div class="ttc" id="structconfigurations_html_a9e1d8406fcb5d8d371e61e11750653a7"><div class="ttname"><a href="structconfigurations.html#a9e1d8406fcb5d8d371e61e11750653a7">configurations::n_bbu_jump</a></div><div class="ttdeci">int n_bbu_jump</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00197">atomic.h:197</a></div></div>
<div class="ttc" id="structconfigurations_html_a568aa359240b411f0774506fb0857f7c"><div class="ttname"><a href="structconfigurations.html#a568aa359240b411f0774506fb0857f7c">configurations::g</a></div><div class="ttdeci">double g</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00199">atomic.h:199</a></div></div>
<div class="ttc" id="python_8h_html_a4f0e3bc930f46505989f47a576f3ae3b"><div class="ttname"><a href="python_8h.html#a4f0e3bc930f46505989f47a576f3ae3b">xband</a></div><div class="ttdeci">struct xbands xband</div></div>
<div class="ttc" id="structplasma_html_a9b217285a754e1533f95d92972b6afd6"><div class="ttname"><a href="structplasma.html#a9b217285a754e1533f95d92972b6afd6">plasma::t_e</a></div><div class="ttdeci">double t_e</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00779">python.h:779</a></div></div>
<div class="ttc" id="structtopbase__phot_html_ae51ac7fd7f3c120cf7eb188b207b824f"><div class="ttname"><a href="structtopbase__phot.html#ae51ac7fd7f3c120cf7eb188b207b824f">topbase_phot::nlev</a></div><div class="ttdeci">int nlev</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00332">atomic.h:332</a></div></div>
<div class="ttc" id="foo_8h_html_a234e98c30b4b66b1f72240a79d9f4d11"><div class="ttname"><a href="foo_8h.html#a234e98c30b4b66b1f72240a79d9f4d11">two_level_atom</a></div><div class="ttdeci">double two_level_atom(struct lines *line_ptr, PlasmaPtr xplasma, double *d1, double *d2)</div><div class="ttdoc">calculates the ratio n2/n1 and gives the individual densities for the states of a two level atom...</div><div class="ttdef"><b>Definition:</b> <a href="lines_8c_source.html#l00423">lines.c:423</a></div></div>
<div class="ttc" id="import__cylindrical_8c_html_ab47e1e72aea1af4158c96f38ee80b8f7"><div class="ttname"><a href="import__cylindrical_8c.html#ab47e1e72aea1af4158c96f38ee80b8f7">i</a></div><div class="ttdeci">int i[NDIM_MAX *NDIM_MAX]</div><div class="ttdef"><b>Definition:</b> <a href="import__cylindrical_8c_source.html#l00031">import_cylindrical.c:31</a></div></div>
<div class="ttc" id="structwind_html"><div class="ttname"><a href="structwind.html">wind</a></div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00692">python.h:692</a></div></div>
<div class="ttc" id="foo_8h_html_a7a80c6ec538ad7bf2b546126bac374bf"><div class="ttname"><a href="foo_8h.html#a7a80c6ec538ad7bf2b546126bac374bf">den_config</a></div><div class="ttdeci">double den_config(PlasmaPtr xplasma, int nconf)</div><div class="ttdoc">returns the precalculated density of a particular &quot;nlte&quot; level. </div><div class="ttdef"><b>Definition:</b> <a href="radiation_8c_source.html#l00895">radiation.c:895</a></div></div>
<div class="ttc" id="structplasma_html_a711ac1ddc0f32849edd96d937ff70761"><div class="ttname"><a href="structplasma.html#a711ac1ddc0f32849edd96d937ff70761">plasma::density</a></div><div class="ttdeci">double * density</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00745">python.h:745</a></div></div>
<div class="ttc" id="import__cylindrical_8c_html_a099bc7b5a9501685180c163c1ffb67d0"><div class="ttname"><a href="import__cylindrical_8c.html#a099bc7b5a9501685180c163c1ffb67d0">x</a></div><div class="ttdeci">double x[NDIM_MAX *NDIM_MAX]</div><div class="ttdef"><b>Definition:</b> <a href="import__cylindrical_8c_source.html#l00033">import_cylindrical.c:33</a></div></div>
<div class="ttc" id="structphoton_html"><div class="ttname"><a href="structphoton.html">photon</a></div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l01034">python.h:1034</a></div></div>
<div class="ttc" id="matom_8c_html_a60902bb874ad5e3684af842ad9a28636"><div class="ttname"><a href="matom_8c.html#a60902bb874ad5e3684af842ad9a28636">ALPHA_FF</a></div><div class="ttdeci">#define ALPHA_FF</div><div class="ttdoc">deals with the elimination of k-packets. </div><div class="ttdef"><b>Definition:</b> <a href="matom_8c_source.html#l00684">matom.c:684</a></div></div>
<div class="ttc" id="structmacro_html_aa7af4ae4af78ef3c646d7e776275b584"><div class="ttname"><a href="structmacro.html#aa7af4ae4af78ef3c646d7e776275b584">macro::cooling_normalisation</a></div><div class="ttdeci">double cooling_normalisation</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00978">python.h:978</a></div></div>
<div class="ttc" id="python_8h_html_a3a571e0bd4220490c5c5bd86f51c83ba"><div class="ttname"><a href="python_8h.html#a3a571e0bd4220490c5c5bd86f51c83ba">geo</a></div><div class="ttdeci">struct geometry geo</div></div>
<div class="ttc" id="structlines_html_adda9b685ebb8bc0dd55faea92c24f3ca"><div class="ttname"><a href="structlines.html#adda9b685ebb8bc0dd55faea92c24f3ca">lines::f</a></div><div class="ttdeci">double f</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00236">atomic.h:236</a></div></div>
<div class="ttc" id="structtopbase__phot_html_a9d54441dd7c9a93f9a937975b77c04cc"><div class="ttname"><a href="structtopbase__phot.html#a9d54441dd7c9a93f9a937975b77c04cc">topbase_phot::nion</a></div><div class="ttdeci">int nion</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00334">atomic.h:334</a></div></div>
<div class="ttc" id="structconfigurations_html_a4d26c780eab93bd42aeefef3ddc9fcda"><div class="ttname"><a href="structconfigurations.html#a4d26c780eab93bd42aeefef3ddc9fcda">configurations::bbd_jump</a></div><div class="ttdeci">int bbd_jump[NBBJUMPS]</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00204">atomic.h:204</a></div></div>
<div class="ttc" id="direct__ion_8c_html_ad33c3a097208fb519a5e779c62e3d1f3"><div class="ttname"><a href="direct__ion_8c.html#ad33c3a097208fb519a5e779c62e3d1f3">q_ioniz</a></div><div class="ttdeci">double q_ioniz(struct topbase_phot *cont_ptr, double electron_temperature)</div><div class="ttdoc">returns the collisional ionization rate co-efficient </div><div class="ttdef"><b>Definition:</b> <a href="direct__ion_8c_source.html#l00387">direct_ion.c:387</a></div></div>
<div class="ttc" id="structconfigurations_html_a7759058c9db6702f3e3cefa8c2506110"><div class="ttname"><a href="structconfigurations.html#a7759058c9db6702f3e3cefa8c2506110">configurations::ex</a></div><div class="ttdeci">double ex</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00201">atomic.h:201</a></div></div>
<div class="ttc" id="matom_8c_html_a53e97649d5cd9a1fab024ab99489ddb1"><div class="ttname"><a href="matom_8c.html#a53e97649d5cd9a1fab024ab99489ddb1">alpha_sp</a></div><div class="ttdeci">double alpha_sp(struct topbase_phot *cont_ptr, PlasmaPtr xplasma, int ichoice)</div><div class="ttdef"><b>Definition:</b> <a href="matom_8c_source.html#l00584">matom.c:584</a></div></div>
<div class="ttc" id="structphoton_html_a98c6d400814a43aeda7d7fd1ed2d7dc6"><div class="ttname"><a href="structphoton.html#a98c6d400814a43aeda7d7fd1ed2d7dc6">photon::freq</a></div><div class="ttdeci">double freq</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l01038">python.h:1038</a></div></div>
<div class="ttc" id="structtopbase__phot_html"><div class="ttname"><a href="structtopbase__phot.html">topbase_phot</a></div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00329">atomic.h:329</a></div></div>
<div class="ttc" id="structplasma_html_ac1d38c3e4cc4ef2a1e4d83d7f8b71d22"><div class="ttname"><a href="structplasma.html#ac1d38c3e4cc4ef2a1e4d83d7f8b71d22">plasma::ne</a></div><div class="ttdeci">double ne</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00741">python.h:741</a></div></div>
<div class="ttc" id="matom_8c_html_a4c03c66dea8a22dd2a87077c816d26c2"><div class="ttname"><a href="matom_8c.html#a4c03c66dea8a22dd2a87077c816d26c2">fake_matom_bf</a></div><div class="ttdeci">int fake_matom_bf(PhotPtr p, int *nres, int *escape)</div><div class="ttdef"><b>Definition:</b> <a href="matom_8c_source.html#l01276">matom.c:1276</a></div></div>
<div class="ttc" id="direct__ion_8c_html_a432a9569392003e4470067b1c44dca5b"><div class="ttname"><a href="direct__ion_8c.html#a432a9569392003e4470067b1c44dca5b">q_recomb</a></div><div class="ttdeci">double q_recomb(struct topbase_phot *cont_ptr, double electron_temperature)</div><div class="ttdoc">Returns a collisional recombination rate co-efficient. </div><div class="ttdef"><b>Definition:</b> <a href="direct__ion_8c_source.html#l00450">direct_ion.c:450</a></div></div>
<div class="ttc" id="atomic_8h_html_abec92cc72a096640b821b8cd56a02495"><div class="ttname"><a href="atomic_8h.html#abec92cc72a096640b821b8cd56a02495">H</a></div><div class="ttdeci">#define H</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00007">atomic.h:7</a></div></div>
<div class="ttc" id="structlines_html_a96fff3bddbfd451e708fe60b9b495784"><div class="ttname"><a href="structlines.html#a96fff3bddbfd451e708fe60b9b495784">lines::nconfigu</a></div><div class="ttdeci">int nconfigu</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00227">atomic.h:227</a></div></div>
<div class="ttc" id="structmacro_html_aa33a4e57be212a9a8f49edf6660350cb"><div class="ttname"><a href="structmacro.html#aa33a4e57be212a9a8f49edf6660350cb">macro::recomb_sp</a></div><div class="ttdeci">double * recomb_sp</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00955">python.h:955</a></div></div>
<div class="ttc" id="foo_8h_html_aa751e527d76e3ced7d54e260c6ec8cd3"><div class="ttname"><a href="foo_8h.html#aa751e527d76e3ced7d54e260c6ec8cd3">check_plasma</a></div><div class="ttdeci">int check_plasma(PlasmaPtr xplasma, char message[])</div></div>
<div class="ttc" id="structlines_html"><div class="ttname"><a href="structlines.html">lines</a></div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00222">atomic.h:222</a></div></div>
<div class="ttc" id="matom_8c_html_a4ed02e03274f12b6c0c302f6f0723bc3"><div class="ttname"><a href="matom_8c.html#a4ed02e03274f12b6c0c302f6f0723bc3">B12_CONSTANT</a></div><div class="ttdeci">#define B12_CONSTANT</div><div class="ttdef"><b>Definition:</b> <a href="matom_8c_source.html#l00524">matom.c:524</a></div></div>
<div class="ttc" id="matom_8c_html_aa39c27768ea571d93b29aa2bf90e7913"><div class="ttname"><a href="matom_8c.html#aa39c27768ea571d93b29aa2bf90e7913">fake_matom_bb</a></div><div class="ttdeci">int fake_matom_bb(PhotPtr p, int *nres, int *escape)</div><div class="ttdef"><b>Definition:</b> <a href="matom_8c_source.html#l01159">matom.c:1159</a></div></div>
<div class="ttc" id="python_8h_html"><div class="ttname"><a href="python_8h.html">python.h</a></div></div>
<div class="ttc" id="atomic_8h_html_a1df743c9da06da92232eff98af40239a"><div class="ttname"><a href="atomic_8h.html#a1df743c9da06da92232eff98af40239a">line</a></div><div class="ttdeci">LinePtr line</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00253">atomic.h:253</a></div></div>
<div class="ttc" id="structlines_html_aa570454ab15c3c7d4324b54a254daf05"><div class="ttname"><a href="structlines.html#aa570454ab15c3c7d4324b54a254daf05">lines::nconfigl</a></div><div class="ttdeci">int nconfigl</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00227">atomic.h:227</a></div></div>
<div class="ttc" id="structlines_html_a8bf1b13f22b24fc4fb517bb28dd775b8"><div class="ttname"><a href="structlines.html#a8bf1b13f22b24fc4fb517bb28dd775b8">lines::macro_info</a></div><div class="ttdeci">int macro_info</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00229">atomic.h:229</a></div></div>
<div class="ttc" id="structconfigurations_html_a006c163c0458412401d44aca2d8b228d"><div class="ttname"><a href="structconfigurations.html#a006c163c0458412401d44aca2d8b228d">configurations::bbu_indx_first</a></div><div class="ttdeci">int bbu_indx_first</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00207">atomic.h:207</a></div></div>
<div class="ttc" id="python_8h_html_ac1f90b11b79f8d2c9a25f12643063ee7"><div class="ttname"><a href="python_8h.html#ac1f90b11b79f8d2c9a25f12643063ee7">nres</a></div><div class="ttdeci">int nres[MAXSCAT+1]</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l01138">python.h:1138</a></div></div>
<div class="ttc" id="structtopbase__phot_html_ae229323c0d16d0a56d3cbedd5700190f"><div class="ttname"><a href="structtopbase__phot.html#ae229323c0d16d0a56d3cbedd5700190f">topbase_phot::down_index</a></div><div class="ttdeci">int down_index</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00350">atomic.h:350</a></div></div>
<div class="ttc" id="log_8h_html_a4f4caa375f1c3a9def422000f305cce5"><div class="ttname"><a href="log_8h.html#a4f4caa375f1c3a9def422000f305cce5">Error</a></div><div class="ttdeci">int Error(char *format,...)</div><div class="ttdoc">Print/write out an error message. </div><div class="ttdef"><b>Definition:</b> <a href="xlog_8c_source.html#l00402">xlog.c:402</a></div></div>
<div class="ttc" id="atomic_8h_html"><div class="ttname"><a href="atomic_8h.html">atomic.h</a></div></div>
<div class="ttc" id="structtopbase__phot_html_a18d8d6eeb8df6e8ad2f89550c6b86310"><div class="ttname"><a href="structtopbase__phot.html#a18d8d6eeb8df6e8ad2f89550c6b86310">topbase_phot::freq</a></div><div class="ttdeci">double freq[NCROSS]</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00356">atomic.h:356</a></div></div>
<div class="ttc" id="atomic_8h_html_a684683fca9c02a1eb50bd3125efdaa2c"><div class="ttname"><a href="atomic_8h.html#a684683fca9c02a1eb50bd3125efdaa2c">config</a></div><div class="ttdeci">ConfigPtr config</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00214">atomic.h:214</a></div></div>
<div class="ttc" id="structconfigurations_html_ad7ff676cefd02052bf9ec5a92f37db98"><div class="ttname"><a href="structconfigurations.html#ad7ff676cefd02052bf9ec5a92f37db98">configurations::bfu_jump</a></div><div class="ttdeci">int bfu_jump[NBFJUMPS]</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00205">atomic.h:205</a></div></div>
<div class="ttc" id="structgeometry_html_a1cdd3c658ff714b9504c7ada69ae1f0d"><div class="ttname"><a href="structgeometry.html#a1cdd3c658ff714b9504c7ada69ae1f0d">geometry::ioniz_or_extract</a></div><div class="ttdeci">int ioniz_or_extract</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00419">python.h:419</a></div></div>
<div class="ttc" id="structmacro_html"><div class="ttname"><a href="structmacro.html">macro</a></div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00923">python.h:923</a></div></div>
<div class="ttc" id="structemiss__range_html_ae32bcc0c5aa7a7f15c63cee741f1f2b0"><div class="ttname"><a href="structemiss__range.html#ae32bcc0c5aa7a7f15c63cee741f1f2b0">emiss_range::fmin</a></div><div class="ttdeci">double fmin</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l01310">python.h:1310</a></div></div>
<div class="ttc" id="structions_html_a57bcd07f6852176e85629314a1e8a057"><div class="ttname"><a href="structions.html#a57bcd07f6852176e85629314a1e8a057">ions::g</a></div><div class="ttdeci">double g</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00108">atomic.h:108</a></div></div>
<div class="ttc" id="structgeometry_html_a4f5794e0b4b6ed3e93a1cbd284132a17"><div class="ttname"><a href="structgeometry.html#a4f5794e0b4b6ed3e93a1cbd284132a17">geometry::adiabatic</a></div><div class="ttdeci">int adiabatic</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00493">python.h:493</a></div></div>
<div class="ttc" id="atomic_8h_html_ae721a9114e3cf54f9bcc3dab31072273"><div class="ttname"><a href="atomic_8h.html#ae721a9114e3cf54f9bcc3dab31072273">ion</a></div><div class="ttdeci">IonPtr ion</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00174">atomic.h:174</a></div></div>
<div class="ttc" id="structconfigurations_html_aeab07933f8fe82391d5c8f3e4113d1bd"><div class="ttname"><a href="structconfigurations.html#aeab07933f8fe82391d5c8f3e4113d1bd">configurations::n_bfu_jump</a></div><div class="ttdeci">int n_bfu_jump</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00198">atomic.h:198</a></div></div>
<div class="ttc" id="atomic_8h_html_aed5961eebbc0ca048e57fe2ad4cdfab8"><div class="ttname"><a href="atomic_8h.html#aed5961eebbc0ca048e57fe2ad4cdfab8">phot_top</a></div><div class="ttdeci">Topbase_phot phot_top[NLEVELS]</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00360">atomic.h:360</a></div></div>
<div class="ttc" id="atomic_8h_html_a0829916f98c17313ddf806ae4a16355e"><div class="ttname"><a href="atomic_8h.html#a0829916f98c17313ddf806ae4a16355e">NBFJUMPS</a></div><div class="ttdeci">#define NBFJUMPS</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00074">atomic.h:74</a></div></div>
<div class="ttc" id="structmacro_html_a6980807d807f7e9e1a49c195e09ce70a"><div class="ttname"><a href="structmacro.html#a6980807d807f7e9e1a49c195e09ce70a">macro::cooling_bf_coltot</a></div><div class="ttdeci">double cooling_bf_coltot</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00979">python.h:979</a></div></div>
<div class="ttc" id="structconfigurations_html_ade544b4d373e9e586f689a19330037ec"><div class="ttname"><a href="structconfigurations.html#ade544b4d373e9e586f689a19330037ec">configurations::n_bbd_jump</a></div><div class="ttdeci">int n_bbd_jump</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00197">atomic.h:197</a></div></div>
<div class="ttc" id="structgeometry_html_ac453ab1a6ed3b90674cd6552c0185bff"><div class="ttname"><a href="structgeometry.html#ac453ab1a6ed3b90674cd6552c0185bff">geometry::macro_simple</a></div><div class="ttdeci">int macro_simple</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00424">python.h:424</a></div></div>
<div class="ttc" id="atomic_8h_html_ac4cf4b2ab929bd23951a8676eeac086b"><div class="ttname"><a href="atomic_8h.html#ac4cf4b2ab929bd23951a8676eeac086b">C</a></div><div class="ttdeci">#define C</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00011">atomic.h:11</a></div></div>
<div class="ttc" id="structwind_html_a86864abe3bc4d97d1b4c305f085c6c55"><div class="ttname"><a href="structwind.html#a86864abe3bc4d97d1b4c305f085c6c55">wind::vol</a></div><div class="ttdeci">double vol</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00711">python.h:711</a></div></div>
<div class="ttc" id="matom_8c_html_a91b6db8e31726e041b1fc93ce0338a1b"><div class="ttname"><a href="matom_8c.html#a91b6db8e31726e041b1fc93ce0338a1b">b12_a</a></div><div class="ttdeci">double b12_a</div><div class="ttdef"><b>Definition:</b> <a href="matom_8c_source.html#l00527">matom.c:527</a></div></div>
<div class="ttc" id="atomic_8c_html_a8c589bd3089b7851e8da407ad1ce44a5"><div class="ttname"><a href="atomic_8c.html#a8c589bd3089b7851e8da407ad1ce44a5">a21</a></div><div class="ttdeci">double a21(struct lines *line_ptr)</div><div class="ttdoc">Calculate the Einstein A coefficient for a transition. </div><div class="ttdef"><b>Definition:</b> <a href="atomic_8c_source.html#l00103">atomic.c:103</a></div></div>
<div class="ttc" id="atomic_8h_html_ad09b144c636440e4812c09171a7d7722"><div class="ttname"><a href="atomic_8h.html#ad09b144c636440e4812c09171a7d7722">MAXJUMPS</a></div><div class="ttdeci">#define MAXJUMPS</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00076">atomic.h:76</a></div></div>
<div class="ttc" id="structtopbase__phot_html_a6be4533b59ab67c16fa1f5d3a31869e8"><div class="ttname"><a href="structtopbase__phot.html#a6be4533b59ab67c16fa1f5d3a31869e8">topbase_phot::np</a></div><div class="ttdeci">int np</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00336">atomic.h:336</a></div></div>
<div class="ttc" id="structmacro_html_a28a025132e5524e22892ce363a37988c"><div class="ttname"><a href="structmacro.html#a28a025132e5524e22892ce363a37988c">macro::cooling_bf</a></div><div class="ttdeci">double * cooling_bf</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00972">python.h:972</a></div></div>
<div class="ttc" id="structplasma_html"><div class="ttname"><a href="structplasma.html">plasma</a></div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00737">python.h:737</a></div></div>
<div class="ttc" id="my__linalg_8h_html"><div class="ttname"><a href="my__linalg_8h.html">my_linalg.h</a></div></div>
<div class="ttc" id="python_8h_html_a940291848296c285c722ed248863afc1"><div class="ttname"><a href="python_8h.html#a940291848296c285c722ed248863afc1">wmain</a></div><div class="ttdeci">WindPtr wmain</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00724">python.h:724</a></div></div>
<div class="ttc" id="structgeometry_html_a140530983e750dba228f9cd27d12000f"><div class="ttname"><a href="structgeometry.html#a140530983e750dba228f9cd27d12000f">geometry::swavemax</a></div><div class="ttdeci">double swavemax</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00348">python.h:348</a></div></div>
<div class="ttc" id="matom_8c_html_a251b07cd6698a386f4306ff7cfb1a481"><div class="ttname"><a href="matom_8c.html#a251b07cd6698a386f4306ff7cfb1a481">temp_ext</a></div><div class="ttdeci">double temp_ext</div><div class="ttdef"><b>Definition:</b> <a href="matom_8c_source.html#l00551">matom.c:551</a></div></div>
<div class="ttc" id="matom_8c_html_aee2caf449c574d065a2cf67664783ace"><div class="ttname"><a href="matom_8c.html#aee2caf449c574d065a2cf67664783ace">alpha_sp_integrand</a></div><div class="ttdeci">double alpha_sp_integrand(double freq)</div><div class="ttdoc">This returns the integrand for alpha_sp at a chosen frequency -. </div><div class="ttdef"><b>Definition:</b> <a href="matom_8c_source.html#l00625">matom.c:625</a></div></div>
<div class="ttc" id="structtopbase__phot_html_a90291444d813ae17dc857a699e4b11df"><div class="ttname"><a href="structtopbase__phot.html#a90291444d813ae17dc857a699e4b11df">topbase_phot::n</a></div><div class="ttdeci">int n</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00337">atomic.h:337</a></div></div>
<div class="ttc" id="atomic_8h_html_a59990369239024c94cbe22080c9d29c3"><div class="ttname"><a href="atomic_8h.html#a59990369239024c94cbe22080c9d29c3">NLINES</a></div><div class="ttdeci">#define NLINES</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00064">atomic.h:64</a></div></div>
<div class="ttc" id="structxbands_html_a4822266ca02ed8a4b214e5efcd79256c"><div class="ttname"><a href="structxbands.html#a4822266ca02ed8a4b214e5efcd79256c">xbands::f1</a></div><div class="ttdeci">double f1[NBANDS]</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l01264">python.h:1264</a></div></div>
<div class="ttc" id="structmacro_html_adc584bf7d87a213e34b03a3631078c4d"><div class="ttname"><a href="structmacro.html#adc584bf7d87a213e34b03a3631078c4d">macro::alpha_st_old</a></div><div class="ttdeci">double * alpha_st_old</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00948">python.h:948</a></div></div>
<div class="ttc" id="atomic_8c_html_a107b53af4265eb649a0e2a483dc613da"><div class="ttname"><a href="atomic_8c.html#a107b53af4265eb649a0e2a483dc613da">sigma_phot</a></div><div class="ttdeci">double sigma_phot(struct photoionization *x_ptr, double freq)</div><div class="ttdoc">double (x_ptr,freq) calculates the photionization crossection due to the transition associated with x...</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8c_source.html#l00049">atomic.c:49</a></div></div>
<div class="ttc" id="structmacro_html_ae6d7a0a034aa6e4b67b5a379fc599b4d"><div class="ttname"><a href="structmacro.html#ae6d7a0a034aa6e4b67b5a379fc599b4d">macro::gamma_old</a></div><div class="ttdeci">double * gamma_old</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00937">python.h:937</a></div></div>
<div class="ttc" id="structphoton_html_a2aa9d1ea7afffe4f370b28b0a21d6c79"><div class="ttname"><a href="structphoton.html#a2aa9d1ea7afffe4f370b28b0a21d6c79">photon::grid</a></div><div class="ttdeci">int grid</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l01062">python.h:1062</a></div></div>
<div class="ttc" id="matom_8c_html_ac84f4556e3972c1fe39b74fd9b7b4241"><div class="ttname"><a href="matom_8c.html#ac84f4556e3972c1fe39b74fd9b7b4241">b12</a></div><div class="ttdeci">double b12(struct lines *line_ptr)</div><div class="ttdef"><b>Definition:</b> <a href="matom_8c_source.html#l00530">matom.c:530</a></div></div>
<div class="ttc" id="structconfigurations_html_adbe6f0e8f48ab2ac418543cd5bbb5d12"><div class="ttname"><a href="structconfigurations.html#adbe6f0e8f48ab2ac418543cd5bbb5d12">configurations::bbu_jump</a></div><div class="ttdeci">int bbu_jump[NBBJUMPS]</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00203">atomic.h:203</a></div></div>
<div class="ttc" id="matom_8c_html_a4870118e9da8bf1f4cdc629cfd2efc96"><div class="ttname"><a href="matom_8c.html#a4870118e9da8bf1f4cdc629cfd2efc96">cont_ext_ptr</a></div><div class="ttdeci">struct topbase_phot * cont_ext_ptr</div><div class="ttdef"><b>Definition:</b> <a href="matom_8c_source.html#l00550">matom.c:550</a></div></div>
<div class="ttc" id="structwind_html_aa879b7be5a0f232f2fde3a95e85824b6"><div class="ttname"><a href="structwind.html#aa879b7be5a0f232f2fde3a95e85824b6">wind::nwind</a></div><div class="ttdeci">int nwind</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00695">python.h:695</a></div></div>
<div class="ttc" id="structmacro_html_a22a281cdcc628db94cb49e1596802c2f"><div class="ttname"><a href="structmacro.html#a22a281cdcc628db94cb49e1596802c2f">macro::kpkt_rates_known</a></div><div class="ttdeci">int kpkt_rates_known</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00970">python.h:970</a></div></div>
<div class="ttc" id="foo_8h_html_a277d190575cbdab99ac77d308dc9dfa1"><div class="ttname"><a href="foo_8h.html#a277d190575cbdab99ac77d308dc9dfa1">q12</a></div><div class="ttdeci">double q12(struct lines *line_ptr, double t)</div><div class="ttdoc">Calculate the collisional excitation coefficient for a line. </div><div class="ttdef"><b>Definition:</b> <a href="lines_8c_source.html#l00285">lines.c:285</a></div></div>
<div class="ttc" id="python_8h_html_af5711847369600743b86dd27343fab7a"><div class="ttname"><a href="python_8h.html#af5711847369600743b86dd27343fab7a">plasmamain</a></div><div class="ttdeci">PlasmaPtr plasmamain</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00904">python.h:904</a></div></div>
<div class="ttc" id="structwind_html_a7f4f2ec3bc9cea1d4dec351b026b9a73"><div class="ttname"><a href="structwind.html#a7f4f2ec3bc9cea1d4dec351b026b9a73">wind::inwind</a></div><div class="ttdeci">enum wind::inwind_enum inwind</div></div>
<div class="ttc" id="matom_8c_html_a16ae068adf1746f09c432de7e245dfb1"><div class="ttname"><a href="matom_8c.html#a16ae068adf1746f09c432de7e245dfb1">kpkt</a></div><div class="ttdeci">int kpkt(PhotPtr p, int *nres, int *escape)</div><div class="ttdef"><b>Definition:</b> <a href="matom_8c_source.html#l00687">matom.c:687</a></div></div>
<div class="ttc" id="structmacro_html_a8427be6ddfa589b733a30ab12e26daf0"><div class="ttname"><a href="structmacro.html#a8427be6ddfa589b733a30ab12e26daf0">macro::cooling_ff</a></div><div class="ttdeci">double cooling_ff</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00980">python.h:980</a></div></div>
<div class="ttc" id="foo_8h_html_a3521f91b62531265426401a6c32fa93f"><div class="ttname"><a href="foo_8h.html#a3521f91b62531265426401a6c32fa93f">qromb</a></div><div class="ttdeci">double qromb(double(*func)(double), double a, double b, double eps)</div><div class="ttdoc">Integrate a function between a and b. </div><div class="ttdef"><b>Definition:</b> <a href="recipes_8c_source.html#l00066">recipes.c:66</a></div></div>
<div class="ttc" id="matom_8c_html_a9301eba8fb39302ef3da90cdb52aef4d"><div class="ttname"><a href="matom_8c.html#a9301eba8fb39302ef3da90cdb52aef4d">matom</a></div><div class="ttdeci">int matom(PhotPtr p, int *nres, int *escape)</div><div class="ttdoc">The core of the implementation of Macro Atoms in python. </div><div class="ttdef"><b>Definition:</b> <a href="matom_8c_source.html#l00097">matom.c:97</a></div></div>
<div class="ttc" id="structplasma_html_acf37090e0b83fe81d058f21229a90018"><div class="ttname"><a href="structplasma.html#acf37090e0b83fe81d058f21229a90018">plasma::cool_adiabatic</a></div><div class="ttdeci">double cool_adiabatic</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00843">python.h:843</a></div></div>
<div class="ttc" id="structgeometry_html_abc10c324e776f2bf8c809096402ecb75"><div class="ttname"><a href="structgeometry.html#abc10c324e776f2bf8c809096402ecb75">geometry::swavemin</a></div><div class="ttdeci">double swavemin</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00348">python.h:348</a></div></div>
<div class="ttc" id="structtopbase__phot_html_aa07be8946fb5a7bb165ee7f3e90aeb7c"><div class="ttname"><a href="structtopbase__phot.html#aa07be8946fb5a7bb165ee7f3e90aeb7c">topbase_phot::uplev</a></div><div class="ttdeci">int uplev</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00333">atomic.h:333</a></div></div>
<div class="ttc" id="structmacro_html_a949003584c6b25a51657f2eb341abee4"><div class="ttname"><a href="structmacro.html#a949003584c6b25a51657f2eb341abee4">macro::cooling_bf_col</a></div><div class="ttdeci">double * cooling_bf_col</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00973">python.h:973</a></div></div>
<div class="ttc" id="structtopbase__phot_html_a0552ae390dbc87aa64fdd05d32227006"><div class="ttname"><a href="structtopbase__phot.html#a0552ae390dbc87aa64fdd05d32227006">topbase_phot::macro_info</a></div><div class="ttdeci">int macro_info</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00344">atomic.h:344</a></div></div>
<div class="ttc" id="structmacro_html_a517e7721172c08c80b4f8a1b20274385"><div class="ttname"><a href="structmacro.html#a517e7721172c08c80b4f8a1b20274385">macro::jbar_old</a></div><div class="ttdeci">double * jbar_old</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00931">python.h:931</a></div></div>
<div class="ttc" id="matom_8c_html_a9ae82cdebefd0a70326fd37ee0a61fd4"><div class="ttname"><a href="matom_8c.html#a9ae82cdebefd0a70326fd37ee0a61fd4">emit_matom</a></div><div class="ttdeci">int emit_matom(WindPtr w, PhotPtr p, int *nres, int upper)</div><div class="ttdoc">a scaled down version of matom which deals with deactivation only for spectral cycles. </div><div class="ttdef"><b>Definition:</b> <a href="matom_8c_source.html#l01323">matom.c:1323</a></div></div>
<div class="ttc" id="structplasma_html_ae4b9e1c0afc70066b36d896e8122513b"><div class="ttname"><a href="structplasma.html#ae4b9e1c0afc70066b36d896e8122513b">plasma::recomb_simple</a></div><div class="ttdeci">double * recomb_simple</div><div class="ttdef"><b>Definition:</b> <a href="python_8h_source.html#l00764">python.h:764</a></div></div>
<div class="ttc" id="foo_8h_html_a451b4740f3d1e12cb07885b0d3e5ef1b"><div class="ttname"><a href="foo_8h.html#a451b4740f3d1e12cb07885b0d3e5ef1b">random_number</a></div><div class="ttdeci">double random_number(double min, double max)</div><div class="ttdoc">Gets a random number from the generator set up in init_rand. </div><div class="ttdef"><b>Definition:</b> <a href="random_8c_source.html#l00284">random.c:284</a></div></div>
<div class="ttc" id="atomic_8h_html_af618fc4a6769a63822cf1f4be873ce23"><div class="ttname"><a href="atomic_8h.html#af618fc4a6769a63822cf1f4be873ce23">NLEVELS_MACRO</a></div><div class="ttdeci">#define NLEVELS_MACRO</div><div class="ttdef"><b>Definition:</b> <a href="atomic_8h_source.html#l00062">atomic.h:62</a></div></div>
</div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="dir_b2f33c71d4aa5e7af42a1ca61ff5af1b.html">source</a></li><li class="navelem"><a class="el" href="matom_8c.html">matom.c</a></li>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
